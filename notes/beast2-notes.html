<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-05-02 Mon 14:01 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>beast2-aez-notes</title>
<meta name="author" content="Alex Zarebski" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet.css" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">beast2-aez-notes</h1>
<p>
<a href="../index.html">Home</a>
</p>


<div id="org69d41ad" class="figure">
<p><img src="../images/beast2-logo.png" alt="beast2-logo.png" width="250px" />
</p>
</div>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org400303b">Links</a></li>
<li><a href="#orgf6e4a5d">Notes</a>
<ul>
<li><a href="#orgaaafcc6">Build a BEAST2</a></li>
<li><a href="#org8526999"><span class="todo TODO">TODO</span> Understanding Packages</a></li>
<li><a href="#orgc29e0be">Understanding BEAST2</a></li>
<li><a href="#org4d0ccc8">Understanding the XML</a></li>
<li><a href="#orgd866461">Understanding <code>bdsky</code></a></li>
</ul>
</li>
<li><a href="#orgd833c21">Packages</a></li>
<li><a href="#org08763f1">Tools</a>
<ul>
<li><a href="#orgc4baf73">Web beautify</a></li>
<li><a href="#org4910f4c">Pretty printing Tracer output</a></li>
</ul>
</li>
<li><a href="#orgbf86600">Examples</a>
<ul>
<li><a href="#orgc18e4a5">BEAST2 as an MCMC engine: part I</a></li>
<li><a href="#orgdcc938c">BEAST2 as an MCMC engine: part II</a></li>
<li><a href="#org2ce02e1">Birth-death simulation: Example I</a></li>
<li><a href="#org45be3f3">Birth-death simulation: Example II</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org400303b" class="outline-2">
<h2 id="org400303b">Links</h2>
<div class="outline-text-2" id="text-org400303b">
<ul class="org-ul">
<li><a href="https://www.beast2.org/xml/index.html">BEAST2 Documentation</a> for "the user who wants to edit BEAST2 XML manually."</li>
<li><a href="https://github.com/CompEvol/beast2">BEAST2 repository</a></li>
<li><a href="https://github.com/BEAST2-Dev/bdsky">bdsky - Birth Death Serial Skyline Model for BEAST2</a> the GitHub repository</li>
<li><a href="https://github.com/tgvaughan/feast">feast</a> a collection of resources from Tim Vaughan</li>
<li><a href="https://github.com/laduplessis/skylinetools">skylinetools</a> is a package from Louis du Plessis which has skylining
functionality, (the <code>DateParser</code> constructor has a nifty trick.)</li>
<li><a href="https://taming-the-beast.org/">Taming the BEAST</a> is a collection of tutorials for BEAST2</li>
</ul>
</div>
</div>

<div id="outline-container-orgf6e4a5d" class="outline-2">
<h2 id="orgf6e4a5d">Notes</h2>
<div class="outline-text-2" id="text-orgf6e4a5d">
</div>
<div id="outline-container-orgaaafcc6" class="outline-3">
<h3 id="orgaaafcc6">Build a BEAST2</h3>
<div class="outline-text-3" id="text-orgaaafcc6">
<ol class="org-ol">
<li>Clone the BEAST2 repository.
<ul class="org-ul">
<li><code>git clone git@github.com:CompEvol/beast2.git</code></li>
</ul></li>
<li>Build the project by running <code>ant</code>.
<ul class="org-ul">
<li>If you don't care about running the tests <code>ant compile-all</code> does the
compilation without running the tests.</li>
</ul></li>
<li>Run the desired program:
<ul class="org-ul">
<li><code>java -cp build/dist/beast.jar beast.app.beauti.Beauti</code></li>
<li><code>java -cp build/dist/beast.jar beast.app.beastapp.BeastMain</code></li>
</ul></li>
</ol>

<p>
Note that you can clock on the little '?' in Beauti to get the location that
packages are stored at.
</p>
</div>

<div id="outline-container-org67e1a6f" class="outline-4">
<h4 id="org67e1a6f">Notes</h4>
<div class="outline-text-4" id="text-org67e1a6f">
<ul class="org-ul">
<li><code>v2.6.7</code>:</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org8526999" class="outline-3">
<h3 id="org8526999"><span class="todo TODO">TODO</span> Understanding Packages</h3>
<div class="outline-text-3" id="text-org8526999">
<p>
Bouckaert has a <a href="https://www.beast2.org/2021/06/21/building-from-source.html">blog post</a> about building package from source from mid-2021. The
following line from the Babel <code>build.xml</code> (which is the example package used in
the blog post)
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;property name="beast2path" location="../beast2" /&gt;
</pre>
</div>

<p>
makes it sound like it assumes that BEAST2 will be in the same directory as the
packages during compilation.
</p>
</div>

<div id="outline-container-orgc466019" class="outline-4">
<h4 id="orgc466019"><span class="todo TODO">TODO</span> Configuring IntelliJ for writing a package</h4>
<div class="outline-text-4" id="text-orgc466019">
<p>
I have no idea if this is the correct way that BEAST2 packages should be set up,
but this has worked for me in the past, and provided there are a sufficient
number of unit tests I assume it should work&#x2026;
</p>

<ul class="org-ul">
<li>Note that the <code>build.xml</code> probably assumes that BEAST2 and your code are in
sibling directories.</li>
<li>Build the BEAST2 project first and then close it and open your project
(probably based on the results of <code>ant skeleton</code>).</li>
<li>Click through <b>File</b> &#x2013; <b>Project Settings</b> &#x2013; <b>Modules</b> &#x2013; <b>&lt;YOUR/PACKAGE&gt;</b> and then
using the <b>+</b> (add) button, tell IntelliJ that you want to add a Module
Dependency, which will be BEAST2.</li>
<li>When building the package, if it complains about missing packages, you may
need to add JAR files in the same way.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgc29e0be" class="outline-3">
<h3 id="orgc29e0be">Understanding BEAST2</h3>
<div class="outline-text-3" id="text-orgc29e0be">
<ul class="org-ul">
<li>The <code>BEASTInterface</code> is an interface which all BEAST-objects must implement, the
<code>BEASTObject</code> class implements that interface and most objects we care about
will derive from <code>BEASTObject</code>.</li>
<li>The <code>StateNode</code> is akin to the <i>stochastic node</i> of H\"{o}hna <i>et al</i> (2014), ie it
is a random variable. State nodes can be changed by operators.</li>
<li>The <code>CalculationNode</code> is akin to the <i>deterministic</i> node of H\"{o}hna <i>et al</i>
(2014), ie it is a deterministic function of its input.</li>
<li>The <code>TreeDistribution</code> (which extends the <code>Distribution</code> abstract class) is the
foundation for both the classes deriving from <code>SpeciesTreeDistribution</code> (which
are the birth-death models) and various coalescent models.</li>
<li>There is a <code>ModelBuilder</code> application for visualising a computation.</li>
</ul>
</div>
</div>

<div id="outline-container-org4d0ccc8" class="outline-3">
<h3 id="org4d0ccc8">Understanding the XML</h3>
<div class="outline-text-3" id="text-org4d0ccc8">
<p>
Chapter 13 of (, ) focuses on how BEAST uses XML to
specify a computation.
</p>

<ul class="org-ul">
<li>There are some reserved attributes (<a href="#org5444dc0">this table</a>) and element names (<a href="#orgd9fbcd9">this table</a>)
that BEAST attributes special meaning to.</li>
<li>The <code>namespace</code> attribute of the <code>beast</code> element specifies where classes are
looked for. The comma-separated list is searched in order, but you can use the
full name in cases where there could be a name-clash.</li>
<li>The <code>input</code> can be replaced with the <code>name</code> to simplify the specification.</li>
</ul>

<table id="org5444dc0" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Reserved attributes</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Attribute name</th>
<th scope="col" class="org-left">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>id</code></td>
<td class="org-left">Unique identifier</td>
</tr>

<tr>
<td class="org-left"><code>idref</code></td>
<td class="org-left">Reference to another element</td>
</tr>

<tr>
<td class="org-left"><code>name</code></td>
<td class="org-left">The part of the parent it plugs into</td>
</tr>

<tr>
<td class="org-left"><code>spec</code></td>
<td class="org-left">The Java class to use</td>
</tr>
</tbody>
</table>

<table id="orgd9fbcd9" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Reserved tags</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Tag name</th>
<th scope="col" class="org-left">Associated BEAST-object</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>run</code></td>
<td class="org-left"><code>beast.core.Runnable</code></td>
</tr>

<tr>
<td class="org-left"><code>distribution</code></td>
<td class="org-left"><code>beast.core.Distribution</code></td>
</tr>

<tr>
<td class="org-left"><code>operator</code></td>
<td class="org-left"><code>beast.core.Operator</code></td>
</tr>

<tr>
<td class="org-left"><code>logger</code></td>
<td class="org-left"><code>beast.core.Logger</code></td>
</tr>

<tr>
<td class="org-left"><code>data</code></td>
<td class="org-left"><code>beast.evolution.alignment.Alignment</code></td>
</tr>

<tr>
<td class="org-left"><code>sequence</code></td>
<td class="org-left"><code>beast.evolution.alignment.Sequence</code></td>
</tr>

<tr>
<td class="org-left"><code>state</code></td>
<td class="org-left"><code>beast.core.State</code></td>
</tr>

<tr>
<td class="org-left"><code>parameter</code></td>
<td class="org-left"><code>beast.core.parameter.RealParameter</code></td>
</tr>

<tr>
<td class="org-left"><code>tree</code></td>
<td class="org-left"><code>beast.evolution.tree.Tree</code></td>
</tr>

<tr>
<td class="org-left"><code>input</code></td>
<td class="org-left">reserved name</td>
</tr>

<tr>
<td class="org-left"><code>map</code></td>
<td class="org-left">macro to simplify <code>spec</code></td>
</tr>

<tr>
<td class="org-left"><code>plate</code></td>
<td class="org-left">for-loop style macro</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org5484b3d" class="outline-4">
<h4 id="org5484b3d">The plate macro</h4>
<div class="outline-text-4" id="text-org5484b3d">
<p>
The XML
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;plate var="n" range="v1,v2,v3" &gt;
    &lt;parameter id="value.$(n)" a="foo" b="$(n)" /&gt;
&lt;/plate&gt;
</pre>
</div>

<p>
becomes
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;parameter id="value.v1" a="foo" b="v1" /&gt;
&lt;parameter id="value.v2" a="foo" b="v2" /&gt;
&lt;parameter id="value.v3" a="foo" b="v3" /&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd866461" class="outline-3">
<h3 id="orgd866461">Understanding <code>bdsky</code></h3>
<div class="outline-text-3" id="text-orgd866461">
<p>
To understand the implementation of time varying parameters see the following:
</p>

<ul class="org-ul">
<li><a href="#orgc9a82aa">Skyline (interface)</a></li>
<li><a href="#orgffaed93">SkylineSegement (class)</a></li>
<li><a href="#org29a1656">SimpleSkyline (class)</a></li>
<li><a href="#org3fd2761">MultiSkyline (class)</a></li>
</ul>

<p>
To understand how this implements the BDSky model see the following:
</p>

<ul class="org-ul">
<li><a href="#org2a4c01d">BDSSkylineSegment (class)</a></li>
<li><a href="#org1a03ed7">BDSParameterization (abstract class)</a></li>
<li><a href="#org9885ef0">CanonicalParameterization (class)</a></li>
<li><a href="#orge79f908">R0Parameterization (class)</a></li>
</ul>

<p>
which all culminates in <a href="#org8a20cbe">ParameterizedBirthDeathSkylineModel (class)</a> which is the
class that actually does the main calculation.
</p>
</div>

<div id="outline-container-orgc9a82aa" class="outline-4">
<h4 id="orgc9a82aa">Skyline (interface)</h4>
<div class="outline-text-4" id="text-orgc9a82aa">
<div class="org-src-container">
<pre class="src src-java">public interface Skyline { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/master/src/bdsky/Skyline.java"><code>Skyline</code></a> is an <i>interface</i> provided by the <code>bdsky</code> package
</p>

<ul class="org-ul">
<li>This represents a multivariate right continuous function on a domain
\([a,\infty)\).</li>
<li>The interface requires the methods <code>getSegments</code>, <code>getValue</code>, <code>getValues</code>, <code>getTimes</code>
and <code>getDimension</code>.</li>
<li>Things that implement <code>Skyline</code> look like lists of</li>
</ul>
</div>
</div>

<div id="outline-container-orgffaed93" class="outline-4">
<h4 id="orgffaed93">SkylineSegment (class)</h4>
<div class="outline-text-4" id="text-orgffaed93">
<div class="org-src-container">
<pre class="src src-java">public class SkylineSegment { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/master/src/bdsky/SkylineSegment.java"><code>SkylineSegment</code></a> is a <i>class</i> provided by the <code>bdsky</code> package
</p>

<ul class="org-ul">
<li>This represents an interval of time, \([a,b)\), and a vector of values
assigned to that time.</li>
<li>There are methods <code>start</code> and <code>end</code> to get the start, \(a\), and end, \(b\) times
of the interval.</li>
</ul>
</div>
</div>

<div id="outline-container-org29a1656" class="outline-4">
<h4 id="org29a1656">SimpleSkyline (class)</h4>
<div class="outline-text-4" id="text-org29a1656">
<div class="org-src-container">
<pre class="src src-java">public class SimpleSkyline extends CalculationNode implements Skyline { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/master/src/bdsky/SimpleSkyline.java"><code>SimpleSkyline</code></a> is a <i>class</i> provided by the <code>bdsky</code> package which represents a
piece-wise constant function (with a one dimensional range).
</p>
</div>
</div>

<div id="outline-container-org3fd2761" class="outline-4">
<h4 id="org3fd2761">MultiSkyline (class)</h4>
<div class="outline-text-4" id="text-org3fd2761">
<div class="org-src-container">
<pre class="src src-java">public class MultiSkyline extends CalculationNode implements Skyline { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/ec2caf66a58b59cc82a7b8391dbd06b25fe67ca6/src/bdsky/MultiSkyline.java"><code>MultiSkyline</code></a> is a <i>class</i> provided by the <code>bdsky</code> package which is really just a
wrapper around a list of <a href="#org29a1656">=SimpleSkyline=s</a>, which takes care of splitting up time
into the required number of segments.
</p>
</div>
</div>

<div id="outline-container-org2a4c01d" class="outline-4">
<h4 id="org2a4c01d">BDSSkylineSegment (class)</h4>
<div class="outline-text-4" id="text-org2a4c01d">
<div class="org-src-container">
<pre class="src src-java">public class BDSSkylineSegment extends SkylineSegment { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/ec2caf66a58b59cc82a7b8391dbd06b25fe67ca6/src/bdsky/BDSSkylineSegment.java#L6"><code>BDSSkylineSegment</code></a> is a class that wraps the <code>SkylineSegment</code> and specialises it
for use as the parameterisation of the BDS model. Both the
<code>CanonicalParameterization</code> and the <code>R0Parameterization</code> make use of this class,
constructing their skyline segments with it.
</p>
</div>
</div>

<div id="outline-container-org1a03ed7" class="outline-4">
<h4 id="org1a03ed7">BDSParameterization (abstract class)</h4>
<div class="outline-text-4" id="text-org1a03ed7">
<div class="org-src-container">
<pre class="src src-java">public abstract class BDSParameterization extends CalculationNode { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/ec2caf66a58b59cc82a7b8391dbd06b25fe67ca6/src/bdsky/BDSParameterization.java"><code>BDSParameterization</code></a> is an <i>abstract class</i> provided by the <code>bdsky</code> package which
provides a template for writing classes which provide novel parameterisations of
the model. The <code>CanonicalParamterization</code> and <code>R0Parameterization</code> are two classes
that inherit from this.
</p>
</div>
</div>

<div id="outline-container-org9885ef0" class="outline-4">
<h4 id="org9885ef0">CanonicalParameterization (class)</h4>
<div class="outline-text-4" id="text-org9885ef0">
<div class="org-src-container">
<pre class="src src-java">public class CanonicalParameterization extends BDSParameterization { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/ec2caf66a58b59cc82a7b8391dbd06b25fe67ca6/src/bdsky/CanonicalParameterization.java"><code>CanonicalParameterization</code></a> is a <i>class</i> provided by the <code>bdsky</code> package which
extends (ie inherits from) the <code>BDSParameterization</code> abstract class and represents
the parameterisation in terms of the birth rate, death rate, sampling rate, and
removal probability (which is important for sampled ancestors).
</p>
</div>
</div>

<div id="outline-container-orge79f908" class="outline-4">
<h4 id="orge79f908">R0Parameterization (class)</h4>
<div class="outline-text-4" id="text-orge79f908">
<div class="org-src-container">
<pre class="src src-java">public class R0Parameterization extends BDSParameterization { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/ec2caf66a58b59cc82a7b8391dbd06b25fe67ca6/src/bdsky/R0Parameterization.java"><code>R0Parameterization</code></a> is a <i>class</i> provided by the <code>bdsky</code> package which extends (ie
inherits from) the <code>BDSParameterization</code> abstract class and represents the
parameterisation in terms of the reproductive number, total becoming
uninfectious rate, the sampling proportion and the removal probability upon
sampling.
</p>
</div>
</div>

<div id="outline-container-org8a20cbe" class="outline-4">
<h4 id="org8a20cbe">ParameterizedBirthDeathSkylineModel (class)</h4>
<div class="outline-text-4" id="text-org8a20cbe">
<div class="org-src-container">
<pre class="src src-java">public class ParameterizedBirthDeathSkylineModel extends SpeciesTreeDistribution { }
</pre>
</div>

<p>
<a href="https://github.com/BEAST2-Dev/bdsky/blob/ec2caf66a58b59cc82a7b8391dbd06b25fe67ca6/src/bdsky/ParameterizedBirthDeathSkylineModel.java"><code>ParameterizedBirthDeathSkylineModel</code></a> is a <i>class</i> provided by the <code>bdsky</code> package
which does the actual calculation, ie it has a <code>calculateTreeLogLikelihood</code>
method.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd833c21" class="outline-2">
<h2 id="orgd833c21">Packages</h2>
<div class="outline-text-2" id="text-orgd833c21">
<p>
Here are some links to BEAST2 packages that may be of interest. This table is
likely to go out of date <i>very</i> quickly.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> BEAST2 packages</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Package</th>
<th scope="col" class="org-left">Publication (implementation)</th>
<th scope="col" class="org-left">Source</th>
<th scope="col" class="org-left">Publication (method)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">BADTRIP</td>
<td class="org-left"><a href="https://doi.org/10.1371/journal.pcbi.1006117">https://doi.org/10.1371/journal.pcbi.1006117</a></td>
<td class="org-left"><a href="https://bitbucket.org/nicofmay/badtrip/src/master/">bitbucket</a></td>
<td class="org-left"><code>???</code></td>
</tr>

<tr>
<td class="org-left">BDSKY</td>
<td class="org-left"><a href="https://doi.org/10.1073/pnas.1207965110">https://doi.org/10.1073/pnas.1207965110</a></td>
<td class="org-left"><a href="https://github.com/BEAST2-Dev/bdsky/">github</a></td>
<td class="org-left"><a href="https://doi.org/https://doi.org/10.1016/j.jtbi.2010.09.010">https://doi.org/https://doi.org/10.1016/j.jtbi.2010.09.010</a></td>
</tr>

<tr>
<td class="org-left">BESP</td>
<td class="org-left"><a href="https://doi.org/10.1093/molbev/msaa016">https://doi.org/10.1093/molbev/msaa016</a></td>
<td class="org-left"><a href="https://github.com/laduplessis/besp/">github</a></td>
<td class="org-left"><a href="https://doi.org/10.1093/molbev/msaa016">https://doi.org/10.1093/molbev/msaa016</a></td>
</tr>

<tr>
<td class="org-left">TimTam</td>
<td class="org-left"><code>???</code></td>
<td class="org-left"><a href="https://github.com/aezarebski/timtam2">github</a></td>
<td class="org-left"><a href="https://doi.org/10.1371/journal.pcbi.1009805">https://doi.org/10.1371/journal.pcbi.1009805</a></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org08763f1" class="outline-2">
<h2 id="org08763f1">Tools</h2>
<div class="outline-text-2" id="text-org08763f1">
<ul class="org-ul">
<li>You can run both <code>beast</code> and <code>beauti</code> from the command line as they are both
available in the <code>beast.jar</code>. In the case of <code>beauti</code> it will be something like
<code>java -sp &lt;path/to/beast.jar&gt; beast.app.beauti.Beauti</code>.</li>
<li>Tracer, FigTree, TempEst and TreeAnnotator all comes as a separate jar files.
You can just click on the jar file and it should run the program correctly.
<ul class="org-ul">
<li><a href="./phylogenetics-notes.html#org2f9ebe8">My TempEst notes</a></li>
</ul></li>
</ul>
</div>

<div id="outline-container-orgc4baf73" class="outline-3">
<h3 id="orgc4baf73">Web beautify</h3>
<div class="outline-text-3" id="text-orgc4baf73">
<p>
Having a linter for XML is helpful. The tool js-beautify seems decent: <a href="https://beautifier.io/">LINK</a> and
<a href="https://github.com/beautify-web/js-beautify">GitHub</a>. You can configure this if you do not like the default style it uses.
Just add the following as <code>.jsbeautifyrc</code> in the root of your project.
</p>

<div class="org-src-container">
<pre class="src src-json">{
    "indent_size": 4,
    "preserve_newlines": true,
    "wrap_attributes": "force-aligned"
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4910f4c" class="outline-3">
<h3 id="org4910f4c">Pretty printing Tracer output</h3>
<div class="outline-text-3" id="text-org4910f4c">
<p>
The following little script can be used to translate a summary produced by
Tracer into something that is easier to use in documents.
</p>

<div class="org-src-container">
<pre class="src src-R">#!/usr/bin/env Rscript
# -*- mode:ess-mode; -*-
#'
#' tracer-table
#' ============
#'
#' Tool to convert tracer summary to an org-mode/markdown style table.
#'
#' Usage
#' -----
#'
#' ./tracer-table --input &lt;demo.txt&gt; --output demo.org
#'

suppressPackageStartupMessages(library(argparse))

parser &lt;- ArgumentParser()

parser$add_argument(
	 "-v",
	 "--verbose",
	 action = "store_true",
	 default = FALSE,
	 help = "Verbose output"
       )
parser$add_argument(
	 "-i",
	 "--input",
	 type = "character",
	 help = "Input file"
       )
parser$add_argument(
	 "-o",
	 "--output",
	 type = "character",
	 help = "Output file"
       )

args &lt;- parser$parse_args()


main &lt;- function(args) {
  foo &lt;- readLines(args$input) |&gt;
    gsub(pattern = "\t", replacement = " | ") |&gt;
    gsub(pattern = "^", replacement = "| ") |&gt;
    gsub(pattern = "$", replacement = " |")
  tbl_header &lt;- head(foo, 1)
  tbl_hline &lt;- tbl_header |&gt;
    gsub(pattern = "[_\ a-zA-Z]", replacement = "-") |&gt;
    gsub(pattern = "-\\|-", replacement = "-+-")
  tbl_body &lt;- tail(foo, -1)
  bar &lt;- c(tbl_header, tbl_hline, tbl_body)
  writeLines(text = bar, con = args$output)
}

if (!interactive()) {
  args &lt;- parser$parse_args()
  main(args)
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbf86600" class="outline-2">
<h2 id="orgbf86600">Examples</h2>
<div class="outline-text-2" id="text-orgbf86600">
<ul class="org-ul">
<li><a href="#orgc18e4a5">BEAST2 as an MCMC engine: part I</a></li>
<li><a href="#orgdcc938c">BEAST2 as an MCMC engine: part II</a></li>
<li><a href="#org2ce02e1">Birth-death simulation: Example I</a></li>
<li><a href="#org45be3f3">Birth-death simulation: Example II</a></li>
</ul>
</div>

<div id="outline-container-orgc18e4a5" class="outline-3">
<h3 id="orgc18e4a5">BEAST2 as an MCMC engine: part I</h3>
<div class="outline-text-3" id="text-orgc18e4a5">
<p>
This example looks at how to use BEAST2 to simulate from a standard normal
distribution using MCMC. The XML for this has the following structure
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;beast version="2.0"&gt;

  &lt;&lt;targetDistribution&gt;&gt;

  &lt;&lt;mcmc&gt;&gt;

&lt;/beast&gt;
</pre>
</div>

<p>
The <a href="#org79c905a"><code>targetDistribution</code></a> specifies the distribution we will sample from and the <a href="#org81fb137">mcmc</a> specifies how details of the MCMC algorithm.
</p>
</div>

<div id="outline-container-org79c905a" class="outline-4">
<h4 id="org79c905a">The target distribution</h4>
<div class="outline-text-4" id="text-org79c905a">
<p>
We use a <code>Prior</code> to represent the distribution because this makes it easy to
evaluate the distribution at a particular value.
</p>

<div class="org-src-container">
<pre class="src src-xml" id="org8a6e8e0">&lt;distribution id="posterior" spec="beast.math.distributions.Prior" x="@x"&gt;
  &lt;distr spec="beast.math.distributions.Normal" mean="0.0" sigma="1.0" /&gt;
&lt;/distribution&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org81fb137" class="outline-4">
<h4 id="org81fb137">MCMC</h4>
<div class="outline-text-4" id="text-org81fb137">
<p>
We use a <code>run</code> tag to specify the MCMC. This requires a <code>state</code> object to
describe the parameters we are sampling, the <code>distribution</code> over the state, and
an <code>operator</code> and <code>logger</code> to perturb the state and record the results.
</p>

<div class="org-src-container">
<pre class="src src-xml" id="orge57fa79">&lt;run chainLength="10000000" id="mcmc" preBurnin="100" spec="beast.core.MCMC"&gt;

    &lt;state id="state" storeEvery="1000"&gt;
	&lt;parameter estimate="true" id="x" name="stateNode" value="1.0" /&gt;
    &lt;/state&gt;

    &lt;distribution idref="posterior" /&gt;

    &lt;operator spec="beast.evolution.operators.RealRandomWalkOperator"
	      windowSize="0.1"
	      useGaussian="true"
	      weight="1.0"
	      parameter="@x" /&gt;

    &lt;logger id="screenlog" logEvery="1000000"&gt;
	&lt;log idref="x" /&gt;
    &lt;/logger&gt;

    &lt;logger fileName="beast.csv"
	    id="tracelog"
	    logEvery="10000"
	    model="@posterior"&gt;
	&lt;log idref="posterior" /&gt;
	&lt;log idref="x" /&gt;
    &lt;/logger&gt;

&lt;/run&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4b5fd60" class="outline-4">
<h4 id="org4b5fd60">Running the sampler</h4>
<div class="outline-text-4" id="text-org4b5fd60">
<p>
Here is the command to actually run this program.
</p>

<div class="org-src-container">
<pre class="src src-sh">java -jar beast.jar -seed 1 -overwrite example-01.xml
</pre>
</div>

<p>
I have used the <code>-overwrite</code> flag because otherwise it will prompt you each time
unless you change the output file name.
</p>
</div>
</div>

<div id="outline-container-orgd534e41" class="outline-4">
<h4 id="orgd534e41">Visualising the results</h4>
<div class="outline-text-4" id="text-orgd534e41">
<p>
Here is a visualisation of the resulting samples along with the distribution we
were sampling from.
</p>


<div id="orgb02cbd5" class="figure">
<p><img src="../images/beast-demo.png" alt="beast-demo.png" width="800px" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">library(ggplot2)
library(cowplot)

beast_samples &lt;- read.table("beast.csv",
  sep = "\t",
  comment.char = "#",
  header = TRUE
)

g1 &lt;- ggplot() +
  geom_line(
    data = beast_samples,
    mapping = aes(x = Sample, y = x)
  ) +
  labs(x = "Sample", y = "X") +
  theme_classic()

g2 &lt;- ggplot() +
  geom_histogram(
    data = beast_samples,
    mapping = aes(x = x, y = ..density..),
    bins = 10
  ) +
  stat_function(
    fun = \(x) dnorm(x),
    geom = "line"
  ) +
  labs(x = "X", y = "Density") +
  theme_classic()

g &lt;- plot_grid(g1, g2)

ggsave("beast-demo.png",
       g,
       height = 10.5,
       width = 14.8,
       units = "cm")
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdcc938c" class="outline-3">
<h3 id="orgdcc938c">BEAST2 as an MCMC engine: part II</h3>
<div class="outline-text-3" id="text-orgdcc938c">
<p>
This example looks at estimating the probability of heads in coin flips. We
start with at beta prior distribution and take values of the number of observed
heads and tails from the command line.
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;beast version="2.0"&gt;

    &lt;distribution id="posterior" spec="beast.core.util.CompoundDistribution" &gt;
	&lt;distribution id="prior" spec="beast.math.distributions.Prior" x="@p"&gt;
	    &lt;distr spec="beast.math.distributions.Beta" alpha="0.5" beta="0.5" /&gt;
	&lt;/distribution&gt;

	&lt;distribution id="likelihood" spec="beast.math.distributions.Prior" x="@p"&gt;
	    &lt;distr spec="beast.math.distributions.Beta" alpha="$(heads)" beta="$(tails)" /&gt;
	&lt;/distribution&gt;
    &lt;/distribution&gt;

    &lt;run chainLength="10000000" id="mcmc" preBurnin="100" spec="beast.core.MCMC"&gt;

	&lt;state id="state" storeEvery="1000"&gt;
	    &lt;parameter estimate="true" id="p" name="stateNode" value="0.5" /&gt;
	&lt;/state&gt;

	&lt;distribution idref="posterior" /&gt;

	&lt;operator spec="beast.evolution.operators.RealRandomWalkOperator" windowSize="0.1" useGaussian="true" weight="1.0" parameter="@p" /&gt;

	&lt;logger id="screenlog" logEvery="1000000"&gt;
	    &lt;log idref="p" /&gt;
	&lt;/logger&gt;

	&lt;logger fileName="beast-02.csv" id="tracelog" logEvery="10000" model="@posterior"&gt;
	    &lt;log idref="posterior" /&gt;
	    &lt;log idref="p" /&gt;
	&lt;/logger&gt;

    &lt;/run&gt;

&lt;/beast&gt;
</pre>
</div>
</div>

<div id="outline-container-org1ae5e30" class="outline-4">
<h4 id="org1ae5e30">Running the sampler</h4>
<div class="outline-text-4" id="text-org1ae5e30">
<p>
Here is the command to actually run this program.
</p>

<div class="org-src-container">
<pre class="src src-sh">java -jar beast.jar -seed 1 -overwrite -D "heads=3,tails=7" example-02.xml
</pre>
</div>

<p>
The <code>-D</code> flag has been used to specify how many times the coin came up heads and
tails.
</p>
</div>
</div>

<div id="outline-container-org80195f7" class="outline-4">
<h4 id="org80195f7">Visualising the results</h4>
<div class="outline-text-4" id="text-org80195f7">
<p>
Here is a visualisation of the resulting samples along with the distribution we
were sampling from.
</p>


<div id="orgc2549ce" class="figure">
<p><img src="../images/beast-02.png" alt="beast-02.png" width="800px" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">library(ggplot2)
library(cowplot)

beast_samples &lt;- read.table("beast-02.csv",
  sep = "\t",
  comment.char = "#",
  header = TRUE
)

g1 &lt;- ggplot() +
  geom_line(
    data = beast_samples,
    mapping = aes(x = Sample, y = p)
  ) +
  labs(x = "Sample", y = "p") +
  theme_classic()

g2 &lt;- ggplot() +
  geom_histogram(
    data = beast_samples,
    mapping = aes(x = p, y = ..density..),
    bins = 15
  ) +
  stat_function(
    fun = \(x) dbeta(x, 0.5 + 3, 0.5 + 7),
    geom = "line"
  ) +
  labs(x = "X", y = "Density") +
  theme_classic()

g &lt;- plot_grid(g1, g2)

ggsave("beast-02.png",
       g,
       height = 10.5,
       width = 14.8,
       units = "cm")
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2ce02e1" class="outline-3">
<h3 id="org2ce02e1">Birth-death simulation: Example I</h3>
<div class="outline-text-3" id="text-org2ce02e1">
<p>
In this example we will simulate sequences on a realisation of the birth-death
process and then attempt to estimate the birth rate from these sequences. We
will use <code>ape</code> to simulate the birth-death process and <code>phangorn</code> to simulate the
sequences. To ensure a correct XML specification we will use <code>beauti</code> to generate
the XML for the analysis. Finally, we will use <code>tracer</code> to check the results.
</p>
</div>

<div id="outline-container-org92e476e" class="outline-4">
<h4 id="org92e476e">Simulating the tree</h4>
<div class="outline-text-4" id="text-org92e476e">
<p>
We will use years as our unit of time. Assuming that an individual is infectious
for 7 days (\(1/52\) of a year) on average, and that \(1\%\) of infections are
sequenced we end up with the following equations for the rates: \(\mu + \psi =
52\) and \(\psi / (\psi + \mu) = 1 / 100\). Solving these give us \(\mu =
5148/100\) and \(\psi = 52/100\). If we have an \(\lambda / (\mu + \psi) = R_{0}
= 2\) then \(\lambda = 104\).
</p>

<div class="org-src-container">
<pre class="src src-R" id="org28e4cff">birth_rate &lt;- 104
death_rate &lt;- 5148 / 100
sampling_rate &lt;- 52 / 100
sim_duration &lt;- 0.15 # year
</pre>
</div>

<p>
The <code>rlineage</code> function returns a realisation of the birth-death process as a
<code>phylo</code> object.
</p>

<div class="org-src-container">
<pre class="src src-R" id="org1503d55">net_removal_rate &lt;- death_rate + sampling_rate
sim_tree &lt;- rlineage(birth_rate,
		     net_removal_rate,
		     Tmax = sim_duration)
</pre>
</div>

<p>
We include the tip dates as part of the tip labels because it makes it much
easier to read the data into Beauti if you can parse this information from the
top labels.
</p>

<div class="org-src-container">
<pre class="src src-R" id="orgab96185">num_tips &lt;- length(sim_tree$tip.label)
tip_fwd_times &lt;- node.depth.edgelength(sim_tree)[1:num_tips]
sim_tree$tip.label &lt;- sprintf("%s_%f",
			      sim_tree$tip.label,
			      2021 + tip_fwd_times)
</pre>
</div>

<p>
The reconstructed tree is the tree that remains when we sample the extinct tips
(ie those that are not extant). The probability that a tip is sequenced is
\(\psi / (\mu + \psi\)\).
</p>

<div class="org-src-container">
<pre class="src src-R" id="org653c758">extant_mask &lt;- tip_fwd_times &gt;= sim_duration
num_removed &lt;- sum(!extant_mask)
num_sampled &lt;- rbinom(n = 1,
		      size = num_removed,
		      prob = sampling_rate / net_removal_rate)
sampled_tips &lt;- sample(x = sim_tree$tip.label[!extant_mask],
		       size = num_sampled)
reconstructed_tree &lt;- keep.tip(phy = sim_tree,
			       tip = sampled_tips)
</pre>
</div>

<p>
We can combine all of this into a function
</p>

<div class="org-src-container">
<pre class="src src-R" id="org41f19e9">rand_reconstructed_tree &lt;- function(birth_rate,
				    death_rate,
				    sampling_rate,
				    duration) {
  net_removal_rate &lt;- death_rate + sampling_rate
  sim_tree &lt;- rlineage(birth_rate,
		       net_removal_rate,
		       Tmax = sim_duration)

  num_tips &lt;- length(sim_tree$tip.label)
  tip_fwd_times &lt;- node.depth.edgelength(sim_tree)[1:num_tips]
  sim_tree$tip.label &lt;- sprintf("%s_%f",
				sim_tree$tip.label,
				2021 + tip_fwd_times)

  extant_mask &lt;- tip_fwd_times &gt;= sim_duration
  num_removed &lt;- sum(!extant_mask)
  num_sampled &lt;- rbinom(n = 1,
			size = num_removed,
			prob = sampling_rate / net_removal_rate)
  sampled_tips &lt;- sample(x = sim_tree$tip.label[!extant_mask],
			 size = num_sampled)
  reconstructed_tree &lt;- keep.tip(phy = sim_tree,
				 tip = sampled_tips)

  return(reconstructed_tree)
}
</pre>
</div>

<p>
We want a simulation that has a reasonable number of sequences in it, so we
generate random trees until we have one with at least \(20\) tips.
</p>

<div class="org-src-container">
<pre class="src src-R">iter_count &lt;- 0
num_seqs &lt;- 0
while (iter_count &lt; 100 &amp;&amp; num_seqs &lt; 20) {
  reconstructed_tree &lt;- rand_reconstructed_tree(birth_rate,
						death_rate,
						sampling_rate,
						sim_duration)
  iter_count &lt;- iter_count + 1
  num_seqs &lt;- length(reconstructed_tree$tip.label)
  print(iter_count)
}
</pre>
</div>

<p>
This tree should be saved for later use.
</p>

<div class="org-src-container">
<pre class="src src-R">write.tree(phy = reconstructed_tree,
	   file = "reconstructed-tree.newick")
</pre>
</div>
</div>
</div>

<div id="outline-container-org4ec5d61" class="outline-4">
<h4 id="org4ec5d61">Simulating the sequences</h4>
<div class="outline-text-4" id="text-org4ec5d61">
<p>
Then we use the <code>simSeq</code> function to simulate a set of genomes for the leaves of
this tree. By default this function uses the JC model for the sequence
simulation with a rate of 1 (using the branch lengths as the units of time). RNA
viruses have a mutation rate of \(\approx 10^{-3}\) substitutions per site per
year. We are already working in units of years so we can use this as our rate.
The length of the sequence we will use is 2000 which is similar to the HA of
influenza.
</p>

<div class="org-src-container">
<pre class="src src-R">sim_seqs &lt;- simSeq(x = reconstructed_tree,
		   rate = 1e-3,
		   l = 2000,
		   type = "DNA")
</pre>
</div>

<p>
Then we write this to a file so we can read it into Beauti.
</p>

<div class="org-src-container">
<pre class="src src-R">write.phyDat(x = sim_seqs,
	     file = "sequences.fasta",
	     format = "fasta")
</pre>
</div>
</div>
</div>

<div id="outline-container-org0471480" class="outline-4">
<h4 id="org0471480">Constructing the XML</h4>
<div class="outline-text-4" id="text-org0471480">
<div class="org-src-container">
<pre class="src src-sh">java -cp ~/Documents/beast2/build/dist/beast.jar beast.app.beauti.Beauti
</pre>
</div>


<ol class="org-ol">
<li>Open Beauti and load in the alignment produced by the simulation above.</li>
<li>Open the <b>Tip Dates</b> tab and auto-configure to get the tip dates.
<ul class="org-ul">
<li>Since the sequences have been simulated with JC model with rate 1 nothing
special is needed for the <b>Site Model</b> and <b>Clock Model</b> tabs.</li>
</ul></li>
<li>Open the <b>Priors</b> tab and select the <b>Birth Death Skyline Serial</b> prior
<ul class="org-ul">
<li>The reproduction number has dimension 10 by default, we used constant rates
so this should be reduced to 1.</li>
<li>Go over the parameters and make sure that for each one the prior looks
sensible. To make things a bit easier, set informative priors for each
parameter.</li>
</ul></li>
<li>Save the analysis as an XML.</li>
</ol>
</div>
</div>

<div id="outline-container-org7b043fc" class="outline-4">
<h4 id="org7b043fc">Running the sampler</h4>
<div class="outline-text-4" id="text-org7b043fc">
<p>
Running the sampler for \(10^{6}\) iterations does not take very long and allows
us to see which variables are getting stuck. There are some suggested
adjustments to the operators which should be done before increasing the sample
size to \(10^{7}\).
</p>
</div>
</div>

<div id="outline-container-orga34635e" class="outline-4">
<h4 id="orga34635e">Analysing the posterior samples</h4>
<div class="outline-text-4" id="text-orga34635e">
<p>
Tracer can be used for preliminary investigation of the posterior samples as
shown in the following table (generated using <a href="#org4910f4c"><code>tracer-table</code></a>).
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Summary Statistic</th>
<th scope="col" class="org-right">Mean</th>
<th scope="col" class="org-left">95% HPD Interval</th>
<th scope="col" class="org-right">Effective Sample Size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">clock rate</td>
<td class="org-right">7.641E-4</td>
<td class="org-left">[3.9092E-4, 1.171E-3]</td>
<td class="org-right">496.5</td>
</tr>

<tr>
<td class="org-left">origin time</td>
<td class="org-right">0.1509</td>
<td class="org-left">[0.1146, 0.1935]</td>
<td class="org-right">254.7</td>
</tr>

<tr>
<td class="org-left">become uninfectious rate</td>
<td class="org-right">51.9713</td>
<td class="org-left">[50.0723, 53.9649]</td>
<td class="org-right">4406.5</td>
</tr>

<tr>
<td class="org-left">reproductive number</td>
<td class="org-right">2.0901</td>
<td class="org-left">[1.8752, 2.3189]</td>
<td class="org-right">581.7</td>
</tr>

<tr>
<td class="org-left">sampling proportion</td>
<td class="org-right">0.0204</td>
<td class="org-left">[1.9394E-3, 0.0435]</td>
<td class="org-right">116.5</td>
</tr>
</tbody>
</table>

<p>
To display the prior and posteriors on the same figure we need to resort to
<code>ggplot2</code> though. There appear to be some identifiability issues (which is to be
expected), but the estimates of the origin and basic reproduction number are
decent. The figure shows the prior distributions (solid lines), the marginal
posterior distribution (histogram) and the true values used in the simulation
(dashed red line).
</p>


<div id="org4fe6d83" class="figure">
<p><img src="../misc/beast2/bd-sim-ex-1/combined-results.png" alt="combined-results.png" width="800px" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">library(dplyr)
library(ggplot2)
library(magrittr)
library(purrr)
library(cowplot)

&lt;&lt;define-parameters&gt;&gt;

mcmc_samples &lt;- read.csv(
  "sequences.log",
  comment.char = "#",
  sep = "\t"
) |&gt;
  rename(
    clock_rate = clockRate,
    origin = origin_BDSKY_Serial,
    net_removal_rate = becomeUninfectiousRate_BDSKY_Serial,
    r_naught = reproductiveNumber_BDSKY_Serial,
    sampling_proportion = samplingProportion_BDSKY_Serial
  ) |&gt;
  select(
    clock_rate,
    origin,
    net_removal_rate,
    r_naught,
    sampling_proportion
  ) |&gt;
  tail(-1000)


g1 &lt;- ggplot() +
  geom_histogram(
    data = mcmc_samples,
    mapping = aes(x = r_naught, y = ..density..),
    bins = 40
  ) +
  stat_function(
    fun = function(x) dlnorm(x, meanlog = 0.0, sdlog = 1.0),
    geom = "line"
  ) +
  geom_vline(
    xintercept = birth_rate / (death_rate + sampling_rate),
    linetype = "dashed",
    colour = "red"
  ) +
  xlim(c(0.1, 3)) +
  labs(x = "R-naught", y = "Density") +
  theme_classic()

g2 &lt;- ggplot() +
  geom_histogram(
    data = mcmc_samples,
    mapping = aes(
      x = net_removal_rate,
      y = ..density..
    )
  ) +
  stat_function(
    fun = function(x) dnorm(x, mean = 52, sd = 1.0),
    geom = "line"
  ) +
  geom_vline(
    xintercept = death_rate + sampling_rate,
    linetype = "dashed",
    colour = "red"
  ) +
  xlim(c(48, 56)) +
  labs(x = "Net removal rate", y = "Density") +
  theme_classic()

g3 &lt;- ggplot() +
  geom_histogram(
    data = mcmc_samples,
    mapping = aes(x = sampling_proportion, y = ..density..),
    bins = 20
  ) +
  stat_function(
    fun = function(x) dbeta(x, shape1 = 2.0, shape2 = 97.0),
    geom = "line"
  ) +
  geom_vline(
    xintercept = sampling_rate / (death_rate + sampling_rate),
    linetype = "dashed",
    colour = "red"
  ) +
  xlim(c(0, 0.1)) +
  labs(x = "Sampling proportion", y = "Density") +
  theme_classic()

g4 &lt;- ggplot() +
  geom_histogram(
    data = mcmc_samples,
    mapping = aes(x = origin, y = ..density..),
    bins = 20
  ) +
  stat_function(
    fun = function(x) dlnorm(x, meanlog = log(0.1), sdlog = 1.25),
    geom = "line"
  ) +
  geom_vline(
    xintercept = sim_duration,
    linetype = "dashed",
    colour = "red"
  ) +
  xlim(c(0, 0.3)) +
  labs(x = "Origin", y = "Density") +
  theme_classic()

g5 &lt;- ggplot() +
  geom_histogram(
    data = mcmc_samples,
    mapping = aes(x = clock_rate, y = ..density..),
    bins = 40
  ) +
  stat_function(
    fun = function(x) dgamma(x, 10, 1e4),
    geom = "line"
  ) +
  geom_vline(
    xintercept = 1e-3,
    linetype = "dashed",
    colour = "red"
  ) +
  xlim(c(1e-5, 3e-3)) +
  labs(x = "Clock rate", y = "Density") +
  theme_classic()

g_comb &lt;- plot_grid(
  plot_grid(g1, g2, g3, nrow = 1, labels = LETTERS[1:3]),
  plot_grid(g4, g5, nrow = 1, labels = LETTERS[4:5]),
  nrow = 2
)

ggsave(
  filename = "combined-results.png",
  plot = g_comb,
  height = 14.8, width = 21.0,
  units = "cm"
)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org45be3f3" class="outline-3">
<h3 id="org45be3f3">Birth-death simulation: Example II</h3>
<div class="outline-text-3" id="text-org45be3f3">
<p>
In this example we will do pretty much the same thing as above, but will
simulate a second smaller epidemic in a different location where the sampling
proportion is two-thirds of the size. The goal it to analyse the two datasets
simultaneously to get tighter estimates on the common parameters but also get
the individual parameters.
</p>

<div class="org-src-container">
<pre class="src src-R">&lt;&lt;import-libraries&gt;&gt;

birth_rate &lt;- 104
death_rate &lt;- 5148 / 100
sampling_rate_1 &lt;- 52 / 100
sampling_rate_2 &lt;- 0.66 * 52 / 100
sim_duration &lt;- 0.15 # year

&lt;&lt;define-random-sampler&gt;&gt;

iter_count &lt;- 0
num_seqs &lt;- 0
while (iter_count &lt; 100 &amp;&amp; num_seqs &lt; 20) {
  reconstructed_tree_1 &lt;- rand_reconstructed_tree(
    birth_rate,
    death_rate,
    sampling_rate_1,
    sim_duration)
  iter_count &lt;- iter_count + 1
  num_seqs &lt;- length(reconstructed_tree_1$tip.label)
}

write.tree(phy = reconstructed_tree_1,
	   file = "reconstructed-tree-1.newick")

sim_seqs_1 &lt;- simSeq(x = reconstructed_tree_1,
		     rate = 1e-3,
		     l = 2000,
		     type = "DNA")

write.phyDat(x = sim_seqs_1,
	     file = "sequences-1.fasta",
	     format = "fasta")

iter_count &lt;- 0
num_seqs &lt;- 0
while (iter_count &lt; 100 &amp;&amp; num_seqs &lt; (0.66 * 20)) {
  reconstructed_tree_2 &lt;- rand_reconstructed_tree(
    birth_rate,
    death_rate,
    sampling_rate_2,
    sim_duration)
  iter_count &lt;- iter_count + 1
  num_seqs &lt;- length(reconstructed_tree_2$tip.label)
}

write.tree(phy = reconstructed_tree_2,
	   file = "reconstructed-tree-2.newick")

sim_seqs_2 &lt;- simSeq(x = reconstructed_tree_2,
		     rate = 1e-3,
		     l = 2000,
		     type = "DNA")

write.phyDat(x = sim_seqs_2,
	     file = "sequences-2.fasta",
	     format = "fasta")
</pre>
</div>

<p>
The resulting sequences can be given to Beauti and we can ask it to link the
genetic models. The generated XML has different tree priors but we want to link
the reproduction number and the becoming uninfectious rate and clock rate across
the two datasets so a bit of care needs to be taken to ensure that there is only
a single parameter for each of these things defined and that it is reused and
only has a single prior.
</p>

<p>
To ensure a fair comparison with the previous analysis we can copy the prior
specifications over. Although in doing this some minor tweaks need to be made to
ensure that every ID is unique.
</p>

<p>
Running the analysis and looking at the estimates in Tracer we get the following
table of estimates and HPDs which are very similar to those from the previous
analysis which is perhaps not that surprising given we haven't added all that
much additional data and the estimates were already tight. Note that the ratio
of sampling proportions is close to the true ratio.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Summary Statistic</th>
<th scope="col" class="org-right">Mean</th>
<th scope="col" class="org-left">95% HPD Interval</th>
<th scope="col" class="org-right">Effective Sample Size (ESS)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">clock rate</td>
<td class="org-right">9.1163E-4</td>
<td class="org-left">[5.2452E-4, 1.3203E-3]</td>
<td class="org-right">845.3</td>
</tr>

<tr>
<td class="org-left">origin time 1</td>
<td class="org-right">0.1455</td>
<td class="org-left">[0.1139, 0.1847]</td>
<td class="org-right">378.6</td>
</tr>

<tr>
<td class="org-left">origin time 2</td>
<td class="org-right">0.1417</td>
<td class="org-left">[0.1024, 0.1872]</td>
<td class="org-right">516</td>
</tr>

<tr>
<td class="org-left">become uninfectious rate</td>
<td class="org-right">52.0074</td>
<td class="org-left">[50.0846, 54.0113]</td>
<td class="org-right">8307.3</td>
</tr>

<tr>
<td class="org-left">reproductive number</td>
<td class="org-right">2.1148</td>
<td class="org-left">[1.9335, 2.3078]</td>
<td class="org-right">836.8</td>
</tr>

<tr>
<td class="org-left">sampling proportion 1</td>
<td class="org-right">0.024</td>
<td class="org-left">[4.511E-3, 0.0504]</td>
<td class="org-right">92</td>
</tr>

<tr>
<td class="org-left">sampling proportion 2</td>
<td class="org-right">0.0146</td>
<td class="org-left">[1.0711E-3, 0.033]</td>
<td class="org-right">437.3</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alex Zarebski</p>
<p class="date">Created: 2022-05-02 Mon 14:01</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
