<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-03-11 Fri 12:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>r-lang-aez-notes</title>
<meta name="author" content="Alex Zarebski" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet.css" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">r-lang-aez-notes</h1>
<p>
<a href="../index.html">Home</a>
</p>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org922a54b">Further reading</a></li>
</ul>
</li>
<li><a href="#org2329b9b">Programming in R (installation and administration)</a>
<ul>
<li><a href="#orgb8bf356">Installing and updating R</a></li>
</ul>
</li>
<li><a href="#org7988aa6">Programming in R (software development)</a>
<ul>
<li><a href="#orgbf2170f">Scripting with R</a></li>
<li><a href="#orgce2c209">Error handling</a></li>
<li><a href="#org0a1ba9e">R Packages by Wickham and Bryan</a></li>
<li><a href="#org17759e2">High performance computing</a></li>
<li><a href="#orgbcbe12a">Packages I like</a></li>
<li><a href="#org23a112d">Reshaping dataframes with <code>reshape2</code></a></li>
<li><a href="#org6b0fbcb">Command line arguments</a></li>
<li><a href="#orgb3d7bb3">Command line arguments with <code>argparse</code></a></li>
<li><a href="#org0902e5d">Working with JSON</a></li>
<li><a href="#orge319a1c">Working with HTML</a></li>
<li><a href="#org67f5070">Working with XML with <code>XML</code></a></li>
<li><a href="#org1edd2d1"><span class="todo TODO">TODO</span> Working with XML with <code>xml2</code></a></li>
<li><a href="#org4b67e7d">Working with Mustache templates</a></li>
<li><a href="#org7cbea13">Unit testing with <code>testthat</code></a></li>
<li><a href="#org3ff80a6">Dependency management with <code>packrat</code></a></li>
<li><a href="#orga8e9eb3">Package and project management with <code>usethis</code></a></li>
<li><a href="#org68b2ec7">String handling with <code>stringr</code></a></li>
<li><a href="#org6a8fc0c">Documentation with <code>roxygen2</code></a></li>
<li><a href="#orgca8ba00">Dates and times</a></li>
<li><a href="#org06301d4"><code>Rmath.h</code></a></li>
<li><a href="#org5aab4c4">Nifty utility functions</a></li>
<li><a href="#orgce5fad4">Cheat sheets</a></li>
<li><a href="#org49468e8">Data frames</a></li>
<li><a href="#org70acbca">Data structures</a></li>
</ul>
</li>
<li><a href="#orgf8eb2ff">Data munging</a>
<ul>
<li><a href="#orgd03c11f">Joins</a></li>
<li><a href="#org024a273">Aggregation</a></li>
</ul>
</li>
<li><a href="#org9b6e753">Programming in R (language and evaluation)</a>
<ul>
<li><a href="#orgec3c64b">Recommended reading</a></li>
<li><a href="#org0d0814c">Functional programming support</a></li>
<li><a href="#orgc2fa880">R/Haskell Prelude</a></li>
<li><a href="#orgf33891c">Program flow and control</a></li>
<li><a href="#org037d4e1">Numbers</a></li>
<li><a href="#org964ad19">Metaprogramming</a></li>
<li><a href="#org32ff53c">R6 and OOP</a></li>
</ul>
</li>
<li><a href="#org9c85378">Statistics with R</a>
<ul>
<li><a href="#org5880c2e">Linear regression <code>lm</code></a></li>
<li><a href="#org68eade3">Zero-inflated regression</a></li>
<li><a href="#orgd5684a6"><span class="todo TODO">TODO</span> Mathematical optimisation</a></li>
<li><a href="#orgb552a50">Computational geography and cartography</a></li>
<li><a href="#org5a74342">Differential equations with <code>deSolve</code></a></li>
<li><a href="#org6bc5c30">MCMC (without <code>Stan</code>)</a></li>
<li><a href="#orge8dc911">(Nonparametric) density estimation with <code>KernSmooth</code></a></li>
</ul>
</div>
</div>


<div id="org1e04859" class="figure">
<p><img src="../images/r-logo.png" alt="r-logo.png" width="250px" />
</p>
</div>

<div id="outline-container-org922a54b" class="outline-3">
<h3 id="org922a54b">Further reading</h3>
<div class="outline-text-3" id="text-org922a54b">
</div>
<div id="outline-container-org60196e9" class="outline-4">
<h4 id="org60196e9">Documentation</h4>
<div class="outline-text-4" id="text-org60196e9">
<ul class="org-ul">
<li><a href="https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-R.html">R Source Code Blocks in Org Mode</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2329b9b" class="outline-2">
<h2 id="org2329b9b">Programming in R (installation and administration)</h2>
<div class="outline-text-2" id="text-org2329b9b">
</div>
<div id="outline-container-orgb8bf356" class="outline-3">
<h3 id="orgb8bf356">Installing and updating R</h3>
<div class="outline-text-3" id="text-orgb8bf356">
<p>
<b>Last update was to 4.1.2 &#x2013; Bird Hippie</b>
</p>

<p>
R updates frequently and things break, so it is a good idea to keep your version
of R reasonably up to date. You can obtain the source code for every version of
R from <a href="https://cran.r-project.org/src/base/">CRAN</a>. The steps involved in getting a particular version of R are as
follows.
</p>

<ol class="org-ol">
<li>Ensure you have the nessessary dependencies with <code>sudo apt-get r-base</code>.</li>
<li>Download the relevant source, e.g. <code>R-4.1.2.tar.gz</code>, and unzip it: <code>tar -xvf
   R-X.Y.Z.tar.gz</code>.</li>
<li>Run <code>./configure</code> and then <code>make</code> and <code>make info</code> to compile R and the
documentation.</li>
<li>Check that the compilation has worked properly with <code>make check</code> and address
any issues that arise.</li>
<li>Install the executable with <code>sudo make install</code> and <code>sudo make install-info</code>.</li>
<li>Check it worked with <code>R -e "sessionInfo()"</code>.</li>
<li>Profit!</li>
</ol>

<p>
Note that step 3 takes the longest, but this still took less than 20 minutes on
my machine for <code>R-4.1.0</code>. After updating, you'll probably have lost all your
packages, the following command can help with this.
</p>

<div class="org-src-container">
<pre class="src src-R">my_pkgs <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> c<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"ape"</span>,
             <span style="color: #2d9574;">"argparse"</span>,
             <span style="color: #2d9574;">"coda"</span>,
             <span style="color: #2d9574;">"dplyr"</span>,
             <span style="color: #2d9574;">"purrr"</span>,
             <span style="color: #2d9574;">"magrittr"</span>,
             <span style="color: #2d9574;">"ggplot2"</span>,
             <span style="color: #2d9574;">"remotes"</span>,
             <span style="color: #2d9574;">"reshape2"</span>,
             <span style="color: #2d9574;">"future"</span>,
             <span style="color: #2d9574;">"furrr"</span>,
             <span style="color: #2d9574;">"stringr"</span><span style="color: #3a81c3;">)</span>
install.packages<span style="color: #3a81c3;">(</span>my_pkgs<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Last time when I updated the packages it said the default library was not
writable so I used a personal library instead. Running the session with <code>sudo</code>
fixed this. Old package versions hanging around can be found with <code>.libPaths()</code>.
</p>
</div>

<div id="outline-container-org0405186" class="outline-4">
<h4 id="org0405186">Notes</h4>
<div class="outline-text-4" id="text-org0405186">
<ul class="org-ul">
<li><code>R-4.1.2</code></li>
<li><code>R-4.1.0</code> introduces some new syntax: <code>|&gt;</code> for piping and some sugar for
anonymous functions, eg <code>\(x) x + 1</code> becomes <code>function(x) x+1</code>. After
upgrading I could not create plots interactively, instead there was a message
about <code>unable to start device X11cairo</code>. The fix for this was to set the
<code>DISPLAY</code> environment variable to <code>:1</code> where it was defaulting to <code>:0</code>.</li>
<li><code>R-4.0.4</code> Having some problems getting ggplot figures with transparency
working but only in the PDF output. It hasn't been a problem so far so leaving
it until next time. I was prompted to use a personal library for the packages
this time, it is at <code>/home/aez/R/x86_64-pc-linux-gnu-library/4.0</code>.</li>
<li><code>R-4.0.2</code> needed me to install <code>libpcre2-dev</code> to get the configuration step to
work. I also had to use <code>sudo make install</code> to install the executable where as
previously it had not needed this level of permission. The <code>update.packages</code>
command didn't work as expected this time, which prompted the installation
list. I also needed to install a package <code>build-dep</code> before building this.</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org7988aa6" class="outline-2">
<h2 id="org7988aa6">Programming in R (software development)</h2>
<div class="outline-text-2" id="text-org7988aa6">
</div>
<div id="outline-container-orgbf2170f" class="outline-3">
<h3 id="orgbf2170f">Scripting with R</h3>
<div class="outline-text-3" id="text-orgbf2170f">
</div>
<div id="outline-container-org335725c" class="outline-4">
<h4 id="org335725c">Running system commands</h4>
<div class="outline-text-4" id="text-org335725c">
<div class="org-src-container">
<pre class="src src-R">system2<span style="color: #3a81c3;">(</span>command, args = character<span style="color: #6c3163;">()</span>,
        wait = <span style="color: #4e3163;">TRUE</span>,
        timeout = <span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<ul class="org-ul">
<li>if <code>wait</code> is set to <code>FALSE</code> then this will run asynchronously</li>
<li>if <code>timeout</code> is set to a value greater than zero it will kill the process
after that amount of time if it has not finished.</li>
</ul>

<div class="org-src-container">
<pre class="src src-R">system2<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"ls"</span>, args = <span style="color: #2d9574;">"/home/aez/Documents"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org18ee203" class="outline-4">
<h4 id="org18ee203">Helper function for system commands</h4>
<div class="outline-text-4" id="text-org18ee203">
<p>
The following can be saved to a file and imported if you just need that one
function.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">message</span><span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"loading the run_command function."</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> Helper function for running system commands.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> Example</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> &gt; run_command("stack build")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> &gt; run_command("Rscript R/make-simulation-configuration-1.R")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #6c3163; font-weight: bold;">run_command</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>cmd, silent = <span style="color: #4e3163;">TRUE</span>, ...<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">message</span><span style="color: #6c3163;">(</span>sprintf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\nRunning command:\n\t%s"</span>, cmd<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  tmp <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> unlist<span style="color: #6c3163;">(</span>strsplit<span style="color: #2d9574;">(</span>cmd, <span style="color: #2d9574;">" "</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  cmd_name <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> head<span style="color: #6c3163;">(</span>tmp, <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>
  cmd_args <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> tail<span style="color: #6c3163;">(</span>tmp, -<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>
  std_val <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>silent<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #4e3163;">FALSE</span>
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2d9574;">""</span>
  <span style="color: #6c3163;">}</span>
  result <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> system2<span style="color: #6c3163;">(</span>
    cmd_name,
    args = cmd_args,
    stdout = std_val,
    stderr = std_val,
    ...
  <span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>result != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3;">stop</span><span style="color: #2d9574;">(</span>sprintf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"command %s failed!"</span>, cmd<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3;">return</span><span style="color: #6c3163;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce2c209" class="outline-3">
<h3 id="orgce2c209">Error handling</h3>
<div class="outline-text-3" id="text-orgce2c209">
<p>
Hadley has a nice <a href="http://adv-r.had.co.nz/Exceptions-Debugging.html#condition-handling">description</a> of how to handle these things in more detail, but here is a small example (from him)
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">show_condition</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>code<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">tryCatch</span><span style="color: #6c3163;">(</span>code,
    error = <span style="color: #3a81c3;">function</span><span style="color: #2d9574;">(</span>c<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">"error"</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>
show_condition<span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">stop</span><span style="color: #6c3163;">(</span><span style="color: #2d9574;">"!"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">evaluates to the string "error"</span>
show_condition<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">10</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">evalates to the numeric 10</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a1ba9e" class="outline-3">
<h3 id="org0a1ba9e">R Packages by Wickham and Bryan</h3>
<div class="outline-text-3" id="text-org0a1ba9e">
<p>
There is a new edition of the <a href="https://r-pkgs.org/">R packages book available online</a>.
Here are some notes about package creation based on reading through that book.
</p>
</div>

<div id="outline-container-org161b79b" class="outline-4">
<h4 id="org161b79b">Package development loop</h4>
<div class="outline-text-4" id="text-org161b79b">
<ol class="org-ol">
<li><code>library(devtools)</code></li>
<li><code>create_package("~/path/to/my/package")</code></li>
<li><code>use_git()</code></li>
<li>Edit the <code>DESCRIPTION</code></li>
<li><code>use_mit_license("Alexander E. Zarebski")</code></li>
<li><code>use_testthat()</code></li>
<li>Include the function <code>foo</code> in <code>R/foo.R</code></li>
<li><code>load_all()</code> to bring the functions into the REPL</li>
<li><code>use_test("foo")</code> to template a test for the <code>foo</code> function</li>
<li><code>test()</code> to run the tests</li>
<li><code>check()</code> to check the package works</li>
<li><code>document()</code></li>
<li>Commit the good stuff to git</li>
<li><code>install()</code> to install on the current machine</li>
<li>Profit</li>
<li><code>uninstall("&lt;package&gt;")</code> to uninstall <code>&lt;package&gt;</code></li>
</ol>
</div>
</div>

<div id="outline-container-orgac2ea82" class="outline-4">
<h4 id="orgac2ea82">Package dependencies</h4>
<div class="outline-text-4" id="text-orgac2ea82">
<p>
The <code>DESCRIPTION</code> file is the place to go!
<i>Hadley says:</i> use <del><code>use_package("foo", "bar")</code></del> to have <code>foo</code> and <code>bar</code> added to the dependencies of the package being developed.
The <code>devtools::use_packag</code> function has been deprecated in favour of <code>usethis::use_package</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">usethis::use_package<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"foo"</span>, <span style="color: #2d9574;">"bar"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The <code>DESCRIPTION</code> will now have the following entry added
</p>

<div class="org-src-container">
<pre class="src src-text">Imports:
    foo,
    bar
</pre>
</div>

<p>
If the package depends on a specific version of the package this can be added too.
</p>

<div class="org-src-container">
<pre class="src src-text">Imports:
    foo (&gt;= 0.2),
    bar (&gt;= 0.3.0.1)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7cb272a" class="outline-4">
<h4 id="org7cb272a">Vignettes</h4>
<div class="outline-text-4" id="text-org7cb272a">
<p>
Create a template vignette with <code>usethis::use_vignette</code>.
There is an <a href="https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf">R Markdown Cheat Sheet</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org17759e2" class="outline-3">
<h3 id="org17759e2">High performance computing</h3>
<div class="outline-text-3" id="text-org17759e2">
<p>
<a href="https://cran.r-project.org/view=HighPerformanceComputing">CRAN Task View for High Performance Computing</a>
</p>

<p>
The package <a href="https://cran.r-project.org/web/packages/furrr/furrr.pdf"><code>furrr</code></a> provides <code>purrr</code> style functions which run in parallel. See
the following snippet for an example
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>future<span style="color: #3a81c3;">)</span>
plan<span style="color: #3a81c3;">(</span>multiprocess<span style="color: #3a81c3;">)</span>

y <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> furrr::future_map<span style="color: #3a81c3;">(</span>x, ~ f<span style="color: #6c3163;">(</span>.x<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
<b>WARNING</b> It looks like <code>furrr</code> will kick up a fuss if <code>f</code> attempts to perform
any IO. It's a good way to force the use of pure functions.
</p>
</div>
</div>

<div id="outline-container-orgbcbe12a" class="outline-3">
<h3 id="orgbcbe12a">Packages I like</h3>
<div class="outline-text-3" id="text-orgbcbe12a">
</div>
<div id="outline-container-org79060f6" class="outline-4">
<h4 id="org79060f6"><a href="https://cran.r-project.org/web/packages/ape/ape.pdf">ape</a> Analyses of Phylogenetics and Evolution</h4>
</div>
<div id="outline-container-orgcc61628" class="outline-4">
<h4 id="orgcc61628"><a href="https://cran.r-project.org/web/packages/deSolve/index.html">deSolve</a> Solvers for Initial Value Problems of Differential Equations</h4>
</div>
<div id="outline-container-orgdad4b6d" class="outline-4">
<h4 id="orgdad4b6d"><a href="https://cran.r-project.org/web/packages/lhs/vignettes/lhs_basics.html">lhs</a> Latin Hypercube Samples</h4>
<div class="outline-text-4" id="text-orgdad4b6d">
<ul class="org-ul">
<li><code>randomLHS(n,k)</code> generates \(n\) samples from \([0,1]^{k}\).</li>
</ul>
</div>
</div>
<div id="outline-container-orgd0cc00e" class="outline-4">
<h4 id="orgd0cc00e"><a href="https://cran.r-project.org/web/packages/magrittr/magrittr.pdf">magrittr</a> a forward pipe operator for R</h4>
<div class="outline-text-4" id="text-orgd0cc00e">
<p>
There are many useful aliases exported by <code>magrittr</code>, the table below has some examples.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Alias</th>
<th scope="col" class="org-left">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>extract</code></td>
<td class="org-left"><code>`[`</code></td>
</tr>

<tr>
<td class="org-left"><code>extract2</code></td>
<td class="org-left"><code>`[[`</code></td>
</tr>

<tr>
<td class="org-left"><code>use_series</code></td>
<td class="org-left"><code>`$`</code></td>
</tr>

<tr>
<td class="org-left"><code>is_in</code></td>
<td class="org-left"><code>`%in%`</code></td>
</tr>

<tr>
<td class="org-left"><code>is_greater_than</code></td>
<td class="org-left"><code>`&gt;`</code></td>
</tr>

<tr>
<td class="org-left"><code>set_colnames</code></td>
<td class="org-left"><code>`colnames&lt;-`</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge1d306e" class="outline-4">
<h4 id="orge1d306e"><a href="https://cran.r-project.org/web/packages/stringr/stringr.pdf">stringr</a> Simple, Consistent Wrappers for Common String Operations</h4>
</div>
<div id="outline-container-orgd1e0b2c" class="outline-4">
<h4 id="orgd1e0b2c"><a href="https://cran.r-project.org/web/packages/styler/styler.pdf">styler</a> Non-Invasive Pretty Printing of R Code</h4>
</div>
<div id="outline-container-org08b9825" class="outline-4">
<h4 id="org08b9825"><a href="https://cran.r-project.org/web/packages/testthat/testthat.pdf">testthat</a> Unit Testing for R</h4>
</div>
<div id="outline-container-org663e762" class="outline-4">
<h4 id="org663e762"><a href="https://cran.r-project.org/web/packages/truncnorm/truncnorm.pdf">truncnorm</a> Truncated Normal Distribution</h4>
</div>
</div>

<div id="outline-container-org23a112d" class="outline-3">
<h3 id="org23a112d">Reshaping dataframes with <code>reshape2</code></h3>
<div class="outline-text-3" id="text-org23a112d">
</div>
<div id="outline-container-orgab9ed6c" class="outline-4">
<h4 id="orgab9ed6c">Casting</h4>
<div class="outline-text-4" id="text-orgab9ed6c">
<p>
Casting is difficult, this figure made by <a href="https://seananderson.ca/2013/10/19/reshape/">Sean C. Anderson</a> helps
</p>


<div id="orgb8eaffc" class="figure">
<p><img src="../images/dcast-illustration.png" alt="dcast-illustration.png" width="700px" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org6b0fbcb" class="outline-3">
<h3 id="org6b0fbcb">Command line arguments</h3>
<div class="outline-text-3" id="text-org6b0fbcb">
<p>
The simplest example is probably what you'll need most of the time
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #ecf3ec;">## </span><span style="color: #2aa1ae; background-color: #ecf3ec;">demo.R</span>
args <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> commandArgs<span style="color: #3a81c3;">(</span>trailingOnly = <span style="color: #4e3163;">TRUE</span><span style="color: #3a81c3;">)</span>
print<span style="color: #3a81c3;">(</span>args<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
As an example consider the following command and output
</p>

<pre class="example">
$ Rscript demo.R 3 foo.csv
[1] "3"       "foo.csv"
</pre>

<p>
Be careful when passing in numbers because they are read in as strings.
</p>
</div>
</div>

<div id="outline-container-orgb3d7bb3" class="outline-3">
<h3 id="orgb3d7bb3">Command line arguments with <code>argparse</code></h3>
<div class="outline-text-3" id="text-orgb3d7bb3">
<p>
See the <a href="https://cran.r-project.org/web/packages/argparse/vignettes/argparse.html">vignette</a>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>argparse<span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create parser object</span>
parser <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> ArgumentParser<span style="color: #3a81c3;">()</span>

parser$add_argument<span style="color: #3a81c3;">(</span>
         <span style="color: #2d9574;">"-v"</span>,
         <span style="color: #2d9574;">"--verbose"</span>,
         action = <span style="color: #2d9574;">"store_true"</span>,
         default = <span style="color: #4e3163;">FALSE</span>,
         help = <span style="color: #2d9574;">"Verbose output"</span>
       <span style="color: #3a81c3;">)</span>
parser$add_argument<span style="color: #3a81c3;">(</span>
         <span style="color: #2d9574;">"-s"</span>,
         <span style="color: #2d9574;">"--seed"</span>,
         type = <span style="color: #2d9574;">"integer"</span>,
         default = <span style="color: #4e3163;">1</span>,
         help = <span style="color: #2d9574;">"PRNG seed"</span>
       <span style="color: #3a81c3;">)</span>
parser$add_argument<span style="color: #3a81c3;">(</span>
         <span style="color: #2d9574;">"-p"</span>,
         <span style="color: #2d9574;">"--parameters"</span>,
         type = <span style="color: #2d9574;">"character"</span>,
         help = <span style="color: #2d9574;">"Filepath to parameters JSON"</span>
       <span style="color: #3a81c3;">)</span>

args <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> parser$parse_args<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org0902e5d" class="outline-3">
<h3 id="org0902e5d">Working with JSON</h3>
<div class="outline-text-3" id="text-org0902e5d">
<p>
For parsing and encoding JSON there is the <code>jsonlite</code> package.
</p>

<p>
<b>WARNING:</b> by default <code>jsonlite::write_json</code> only uses 4 digits which is not
enough for many scientific applications, unless there is a good reason not to,
it is probably better to set <code>digits = 16</code>.
</p>
</div>

<div id="outline-container-org1cc35d8" class="outline-4">
<h4 id="org1cc35d8">Examples</h4>
<div class="outline-text-4" id="text-org1cc35d8">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>jsonlite<span style="color: #3a81c3;">)</span>
read_json<span style="color: #3a81c3;">(</span>&lt;filepath&gt;<span style="color: #3a81c3;">)</span>
write_json<span style="color: #3a81c3;">(</span>&lt;object&gt;, &lt;filepath&gt;, pretty = <span style="color: #4e3163;">TRUE</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
There are the <code>toJSON</code> and <code>fromJSON</code> functions but they are not needed most of
the time.
</p>
</div>
</div>
</div>

<div id="outline-container-orge319a1c" class="outline-3">
<h3 id="orge319a1c">Working with HTML</h3>
<div class="outline-text-3" id="text-orge319a1c">
<p>
There is the <code>htmltools</code> package for generating HTML in R.
</p>
</div>

<div id="outline-container-orgc6a0f65" class="outline-4">
<h4 id="orgc6a0f65">Example</h4>
<div class="outline-text-4" id="text-orgc6a0f65">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>htmltools<span style="color: #3a81c3;">)</span>

my_html <span style="color: #ba2f59; font-weight: bold;">&lt;-</span>
  tags$html<span style="color: #3a81c3;">(</span>
         tags$head<span style="color: #6c3163;">(</span>tags$title<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"My Title"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>,
         tags$body<span style="color: #6c3163;">(</span>
                tags$h1<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"Hello"</span><span style="color: #2d9574;">)</span>,
                tags$div<span style="color: #2d9574;">(</span>
                       tags$h3<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"Hello World"</span><span style="color: #67b11d;">)</span>,
                       tags$img<span style="color: #67b11d;">(</span>src = <span style="color: #2d9574;">"the-world.png"</span><span style="color: #67b11d;">)</span>,
                       tags$p<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"What a wonderful world!"</span><span style="color: #67b11d;">)</span>
                     <span style="color: #2d9574;">)</span>
              <span style="color: #6c3163;">)</span>
       <span style="color: #3a81c3;">)</span>

save_html<span style="color: #3a81c3;">(</span>
  doRenderTags<span style="color: #6c3163;">(</span>my_html<span style="color: #6c3163;">)</span>,
  file = <span style="color: #2d9574;">"world.html"</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
produces the following HTML
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #3a81c3;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">html</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">meta</span> <span style="color: #715ab1;">charset</span>=<span style="color: #2d9574;">"utf-8"</span>/&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">style</span>&gt;body{background-color:white;}&lt;/<span style="color: #6c3163; font-weight: bold;">style</span>&gt;


&lt;/<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">html</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">My Title</span>&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">body</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Hello</span>&lt;/<span style="color: #6c3163; font-weight: bold;">h1</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">div</span>&gt;
      &lt;<span style="color: #6c3163; font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">Hello World</span>&lt;/<span style="color: #6c3163; font-weight: bold;">h3</span>&gt;
      &lt;<span style="color: #6c3163; font-weight: bold;">img</span> <span style="color: #715ab1;">src</span>=<span style="color: #2d9574;">"the-world.png"</span>/&gt;
      &lt;<span style="color: #6c3163; font-weight: bold;">p</span>&gt;What a wonderful world!&lt;/<span style="color: #6c3163; font-weight: bold;">p</span>&gt;
    &lt;/<span style="color: #6c3163; font-weight: bold;">div</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">body</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">html</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">html</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org49a7275" class="outline-4">
<h4 id="org49a7275">Example: embedding PNG as string in HTML</h4>
<div class="outline-text-4" id="text-org49a7275">
<p>
The following function is useful if you want to avoid referencing external files
in your HTML but still want to include figures.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> An HTML tag encoding an image stored in a PNG.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> This uses the \code{base64enc} and \code{htmltools} packages.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #3a81c3; background-color: #ecf3ec;">@param</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #715ab1; background-color: #ecf3ec;">filepath</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> is the path to the PNG</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #3a81c3; background-color: #ecf3ec;">@param</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #715ab1; background-color: #ecf3ec;">...</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> is additional arguments to \code{tags$img} such as style.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #6c3163; font-weight: bold;">png_as_img</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>filepath, ...<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>tools::file_ext<span style="color: #2d9574;">(</span>filepath<span style="color: #2d9574;">)</span> == <span style="color: #2d9574;">"png"</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    b64 <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> base64enc::base64encode<span style="color: #2d9574;">(</span>what = filepath<span style="color: #2d9574;">)</span>
    tags$img<span style="color: #2d9574;">(</span>
           src = paste<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"data:image/png;base64"</span>, b64, sep = <span style="color: #2d9574;">","</span><span style="color: #67b11d;">)</span>,
           ...
         <span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3;">stop</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"Filepath given to png_as_img must be a PNG."</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9d8b62" class="outline-4">
<h4 id="orgc9d8b62">Example: including a table representation of a dataframe</h4>
<div class="outline-text-4" id="text-orgc9d8b62">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> An HTML tag encoding a data frame as a basic table.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> This uses the \code{xtable} package to generate the HTML for the table.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #3a81c3; background-color: #ecf3ec;">@param</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #715ab1; background-color: #ecf3ec;">df</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> data.frame to create an table from</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #3a81c3; background-color: #ecf3ec;">@param</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> </span><span style="color: #715ab1; background-color: #ecf3ec;">...</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> additional parameters for \code{xtable::xtable}.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #6c3163; font-weight: bold;">df_as_table</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>df, ...<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  tmp_file <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> tempfile<span style="color: #6c3163;">()</span>
  print<span style="color: #6c3163;">(</span>xtable::xtable<span style="color: #2d9574;">(</span>df, ...<span style="color: #2d9574;">)</span>,
        type = <span style="color: #2d9574;">"html"</span>,
        file = tmp_file<span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3;">return</span><span style="color: #6c3163;">(</span>tags$div<span style="color: #2d9574;">(</span>includeHTML<span style="color: #67b11d;">(</span>tmp_file<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org67f5070" class="outline-3">
<h3 id="org67f5070">Working with XML with <code>XML</code></h3>
<div class="outline-text-3" id="text-org67f5070">
<p>
<b>NOTE:</b> It looks like <code>xml2</code> might be a better choice for XML work, please see <a href="#org1edd2d1">these
notes</a> instead.
</p>
</div>

<div id="outline-container-org2e25f4c" class="outline-4">
<h4 id="org2e25f4c">Example I</h4>
<div class="outline-text-4" id="text-org2e25f4c">
<p>
The following snippet produces a file <code>demo.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>XML<span style="color: #3a81c3;">)</span>

kappa_node <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> xmlNode<span style="color: #3a81c3;">(</span>
  <span style="color: #2d9574;">"kappa"</span>,
  attrs = list<span style="color: #6c3163;">(</span>idref = <span style="color: #2d9574;">"hky.kappa"</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

input_node <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> xmlNode<span style="color: #3a81c3;">(</span>
  <span style="color: #2d9574;">"input"</span>,
  kappa_node,
  attrs = list<span style="color: #6c3163;">(</span>spec = <span style="color: #2d9574;">"HKY"</span>, id = <span style="color: #2d9574;">"hky"</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

z <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> xmlNode<span style="color: #3a81c3;">(</span>
  <span style="color: #2d9574;">"beast"</span>,
  input_node,
  attrs = list<span style="color: #6c3163;">(</span>version = <span style="color: #2d9574;">"2.0"</span>,
               namespace = <span style="color: #2d9574;">"beast.core:beast.evolution.operators"</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

saveXML<span style="color: #3a81c3;">(</span>
  z,
  file = <span style="color: #2d9574;">"demo.xml"</span>,
  prefix = <span style="color: #2d9574;">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;\n"</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
And here is the result
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8" standalone="no"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">beast</span> <span style="color: #715ab1;">version</span>=<span style="color: #2d9574;">"2.0"</span> <span style="color: #715ab1;">namespace</span>=<span style="color: #2d9574;">"beast.core:beast.evolution.operators"</span>&gt;
 &lt;<span style="color: #6c3163; font-weight: bold;">input</span> <span style="color: #715ab1;">spec</span>=<span style="color: #2d9574;">"HKY"</span> <span style="color: #715ab1;">id</span>=<span style="color: #2d9574;">"hky"</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">kappa</span> <span style="color: #715ab1;">idref</span>=<span style="color: #2d9574;">"hky.kappa"</span>/&gt;
 &lt;/<span style="color: #6c3163; font-weight: bold;">input</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">beast</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org33b3ec7" class="outline-4">
<h4 id="org33b3ec7">Example II</h4>
<div class="outline-text-4" id="text-org33b3ec7">
<p>
Given an XML file, <code>demo.xml</code>, we can read that into a list-like object:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>XML<span style="color: #3a81c3;">)</span>

xmlToList<span style="color: #3a81c3;">(</span>xmlParse<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"demo.xml"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb726cc8" class="outline-4">
<h4 id="orgb726cc8">Example III</h4>
<div class="outline-text-4" id="text-orgb726cc8">
<p>
We can read in the XML, edit one of the nodes by indexing into the object and
replacing it, and then write it back to another file.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>XML<span style="color: #3a81c3;">)</span>

foo <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> xmlTreeParse<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"demo.xml"</span><span style="color: #3a81c3;">)</span>$doc$children

bappa_node <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> xmlNode<span style="color: #3a81c3;">(</span>
  <span style="color: #2d9574;">"bappa"</span>,
  attrs = list<span style="color: #6c3163;">(</span>idref = <span style="color: #2d9574;">"hky.bappa"</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

foo<span style="color: #3a81c3;">[</span><span style="color: #6c3163;">[</span><span style="color: #2d9574;">"beast"</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">][</span><span style="color: #6c3163;">[</span><span style="color: #2d9574;">"input"</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">][</span><span style="color: #6c3163;">[</span><span style="color: #2d9574;">"kappa"</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> bappa_node

saveXML<span style="color: #3a81c3;">(</span>
  foo$beast, <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&lt;-- need to specify the node.</span>
  file = <span style="color: #2d9574;">"demo-again.xml"</span>,
  prefix = <span style="color: #2d9574;">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;\n"</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org421206a" class="outline-4">
<h4 id="org421206a">Example IV</h4>
<div class="outline-text-4" id="text-org421206a">
<p>
We can use <a href="https://www.w3schools.com/xml/xpath_syntax.asp">XPath syntax</a> to extract a particular node and then query its
attributes.
</p>

<div class="org-src-container">
<pre class="src src-R">foo <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> xmlTreeParse<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"demo.xml"</span><span style="color: #3a81c3;">)</span>$doc$children$beast
kappa_node <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> getNodeSet<span style="color: #3a81c3;">(</span>foo, <span style="color: #2d9574;">"//kappa[@idref='hky.kappa']"</span><span style="color: #3a81c3;">)[</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">]</span>
xmlGetAttr<span style="color: #3a81c3;">(</span>kappa_node, <span style="color: #2d9574;">"idref"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1edd2d1" class="outline-3">
<h3 id="org1edd2d1"><span class="todo TODO">TODO</span> Working with XML with <code>xml2</code></h3>
<div class="outline-text-3" id="text-org1edd2d1">
<ul class="org-ul">
<li><code>read_xml</code> and <code>write_xml</code> for IO or start a new node from text.</li>
<li><code>xml_text</code> (and <code>xml_set_text</code>) to get the text out of a node (and to modify it).</li>
<li><code>xml_set_attr</code> to set attributes on a node.</li>
<li><code>xml_add_child</code> to add a child node to a parent.</li>
</ul>
</div>

<div id="outline-container-org369a7e2" class="outline-4">
<h4 id="org369a7e2">Example I: creating a node and adding it to existing XML</h4>
<div class="outline-text-4" id="text-org369a7e2">
<p>
Start with the following XML in <code>demo.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;J K. Rowling&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2005&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;29.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
    &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>

<p>
then run the following script
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>xml2<span style="color: #3a81c3;">)</span>

bs <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read_xml<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"demo.xml"</span><span style="color: #3a81c3;">)</span>

new_book <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read_xml<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"&lt;book&gt;&lt;title/&gt;&lt;author/&gt;&lt;year/&gt;&lt;price/&gt;&lt;/book&gt;"</span><span style="color: #3a81c3;">)</span>

xml_set_attr<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_book, <span style="color: #2d9574;">"//title"</span><span style="color: #6c3163;">)</span>,
  attr = <span style="color: #2d9574;">"lang"</span>,
  value = <span style="color: #2d9574;">"en"</span><span style="color: #3a81c3;">)</span>
xml_set_text<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_book, <span style="color: #2d9574;">"//title"</span><span style="color: #6c3163;">)</span>,
  value = <span style="color: #2d9574;">"Nineteen Eighty-Four"</span>
<span style="color: #3a81c3;">)</span>
xml_set_text<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_book, <span style="color: #2d9574;">"//author"</span><span style="color: #6c3163;">)</span>,
  value = <span style="color: #2d9574;">"G Orwell"</span>
<span style="color: #3a81c3;">)</span>
xml_set_text<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_book, <span style="color: #2d9574;">"//year"</span><span style="color: #6c3163;">)</span>,
  value = <span style="color: #2d9574;">"1949"</span>
<span style="color: #3a81c3;">)</span>
xml_set_text<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_book, <span style="color: #2d9574;">"//price"</span><span style="color: #6c3163;">)</span>,
  value = <span style="color: #2d9574;">"8.99"</span>
<span style="color: #3a81c3;">)</span>

xml_add_child<span style="color: #3a81c3;">(</span>bs, new_book<span style="color: #3a81c3;">)</span>
write_xml<span style="color: #3a81c3;">(</span>bs, <span style="color: #2d9574;">"demo2.xml"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
to get the new file <code>demo2.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;J K. Rowling&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2005&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;29.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;G Orwell&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;1949&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;8.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org400dbbd" class="outline-4">
<h4 id="org400dbbd">Example II: swapping a node for a new one in existing XML</h4>
<div class="outline-text-4" id="text-org400dbbd">
<p>
Starting with <code>demo2.xml</code> from the <a href="#org369a7e2">previous example</a>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;J K. Rowling&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2005&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;29.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;G Orwell&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;1949&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;8.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>

<p>
we can use the script
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>xml2<span style="color: #3a81c3;">)</span>

bs <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read_xml<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"demo2.xml"</span><span style="color: #3a81c3;">)</span>

new_cd <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> read_xml<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"&lt;cd&gt;&lt;title/&gt;&lt;artist/&gt;&lt;year/&gt;&lt;/cd&gt;"</span><span style="color: #3a81c3;">)</span>

xml_set_text<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_cd, <span style="color: #2d9574;">"//title"</span><span style="color: #6c3163;">)</span>,
  value = <span style="color: #2d9574;">"Lateralus"</span>
<span style="color: #3a81c3;">)</span>
xml_set_text<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_cd, <span style="color: #2d9574;">"//artist"</span><span style="color: #6c3163;">)</span>,
  value = <span style="color: #2d9574;">"Tool"</span>
<span style="color: #3a81c3;">)</span>
xml_set_text<span style="color: #3a81c3;">(</span>
  x = xml_find_first<span style="color: #6c3163;">(</span>new_cd, <span style="color: #2d9574;">"//year"</span><span style="color: #6c3163;">)</span>,
  value = <span style="color: #2d9574;">"2001"</span>
<span style="color: #3a81c3;">)</span>

old_book <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> xml_find_first<span style="color: #3a81c3;">(</span>bs, <span style="color: #2d9574;">"//book[title='Harry Potter']"</span><span style="color: #3a81c3;">)</span>
xml_replace<span style="color: #3a81c3;">(</span>old_book, new_cd<span style="color: #3a81c3;">)</span>
write_xml<span style="color: #3a81c3;">(</span>bs, <span style="color: #2d9574;">"demo3.xml"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
which produces <code>demo3.xml</code> shown below
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">cd</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span>&gt;Lateralus&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">artist</span>&gt;Tool&lt;/<span style="color: #6c3163; font-weight: bold;">artist</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2001&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">cd</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;G Orwell&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;1949&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;8.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4b67e7d" class="outline-3">
<h3 id="org4b67e7d">Working with Mustache templates</h3>
<div class="outline-text-3" id="text-org4b67e7d">
</div>
<div id="outline-container-orgee5fc15" class="outline-4">
<h4 id="orgee5fc15">Example</h4>
<div class="outline-text-4" id="text-orgee5fc15">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>whisker<span style="color: #3a81c3;">)</span>

template <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> readLines<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"./template.html"</span><span style="color: #3a81c3;">)</span>
data <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> list<span style="color: #3a81c3;">(</span> name = <span style="color: #2d9574;">"Chris"</span>
            , value = <span style="color: #4e3163;">10000</span>
            , taxed_value = <span style="color: #4e3163;">10000</span> - <span style="color: #6c3163;">(</span><span style="color: #4e3163;">10000</span> * <span style="color: #4e3163;">0.4</span><span style="color: #6c3163;">)</span>
            , in_ca = <span style="color: #4e3163;">TRUE</span>
            <span style="color: #3a81c3;">)</span>

writeLines<span style="color: #3a81c3;">(</span>whisker.render<span style="color: #6c3163;">(</span>template, data<span style="color: #6c3163;">)</span>, <span style="color: #2d9574;">"./output.html"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
where <code>template.html</code> might look like the following
</p>

<pre class="example">
Hello {{name}}
You have just won ${{value}}!
{{#in_ca}}
Well, ${{taxed_value}}, after taxes.
{{/in_ca}}
</pre>
</div>
</div>
</div>

<div id="outline-container-org7cbea13" class="outline-3">
<h3 id="org7cbea13">Unit testing with <code>testthat</code></h3>
<div class="outline-text-3" id="text-org7cbea13">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Function</td>
<td class="org-left">Example</td>
</tr>

<tr>
<td class="org-left"><code>expect_true</code></td>
<td class="org-left"><code>expect_true(TRUE)</code></td>
</tr>

<tr>
<td class="org-left"><code>expect_equal</code></td>
<td class="org-left"><code>expect_equal(10.01, 10, tolerance = 0.02)</code></td>
</tr>

<tr>
<td class="org-left"><code>expect_error</code></td>
<td class="org-left"><code>expect_error(stop("Boo!"))</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org3ff80a6" class="outline-3">
<h3 id="org3ff80a6">Dependency management with <code>packrat</code></h3>
<div class="outline-text-3" id="text-org3ff80a6">
<p>
Packrat is developed by the team at RStudio. It relies on the notion of a
<i>project</i>, which we might think of as a single analysis or collection of related
analyses. A project should live in a single directory.
</p>
</div>

<div id="outline-container-orga377b3d" class="outline-4">
<h4 id="orga377b3d">Usage</h4>
<div class="outline-text-4" id="text-orga377b3d">
<p>
To start a packrat project use
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::init<span style="color: #3a81c3;">()</span>
</pre>
</div>

<p>
This creates a directory <code>packrat</code> and a <code>.Rprofile</code> file. The profile file is
how R knows to use the private library rather than the shared one. There is a
file <code>packrat/packrat.lock</code> which contains the package details.
</p>

<p>
Packages are installed as usual with <code>install.packages</code>, but now they will be
stored in the private packrat library. Packages are not added to the
<code>packrat.lock</code> file until a <i>snapshot</i> of the current packages is made
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::snapshot<span style="color: #3a81c3;">()</span>
</pre>
</div>

<p>
If you want a status report from packrat about how the packages there is
<code>packrat::status</code>. To install local packages, packrat needs to be told where
they live
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::set_opts<span style="color: #3a81c3;">(</span>local.repos = <span style="color: #2d9574;">"&lt;path/to/package&gt;"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
When moving a project between machines the installed packages will probably
break. However, the <code>packrat</code> directory stores copies of the source for each of
the packages so they can be <i>restored</i>.
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::restore<span style="color: #3a81c3;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb9806a" class="outline-4">
<h4 id="orgfb9806a">Version control</h4>
<div class="outline-text-4" id="text-orgfb9806a">
<p>
The following files should be included into version control:
</p>

<ul class="org-ul">
<li><code>.gitignore</code> can contain <code>packrat/lib</code> and <code>packrat/src</code>.</li>
<li><code>.Rprofile</code></li>
<li><code>packrat/packrat.opts</code></li>
<li><code>packrat/packrat.lock</code></li>
</ul>

<p>
The following explaination of the directory structure is given in the
<a href="https://rstudio.github.io/packrat/walkthrough.html">walkthrough</a>
</p>

<blockquote>
<p>
A packrat project contains a few extra files and directories. The <code>init()</code>
function creates these files for you, if they don’t already exist.
</p>

<ul class="org-ul">
<li><code>packrat/packrat.lock</code>: Lists the precise package versions that were used to
satisfy dependencies, including dependencies of dependencies. (This file
should never be edited by hand!)</li>
<li><code>packrat/packrat.opts</code>: Project-specific packrat options. These can be queried
and set with <code>get_opts</code> and <code>set_opts</code>; see <code>?"packrat-options"</code> for more
information.</li>
<li><code>packrat/lib/</code>: Private package library for this project.</li>
<li><code>packrat/src/</code>: Source packages of all the dependencies that packrat has been
made aware of.</li>
<li><code>.Rprofile</code>: Directs R to use the private package library (when it is started
from the project directory).</li>
</ul>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-orga8e9eb3" class="outline-3">
<h3 id="orga8e9eb3">Package and project management with <code>usethis</code></h3>
<div class="outline-text-3" id="text-orga8e9eb3">
<ul class="org-ul">
<li>Add dependencies to packages with <code>usethis::use_package</code> instead of
<code>devtools::use_package</code> which is now deprecated. It is the same deal with
<code>use_vignette</code>.</li>
</ul>
</div>
</div>

<div id="outline-container-org68b2ec7" class="outline-3">
<h3 id="org68b2ec7">String handling with <code>stringr</code></h3>
<div class="outline-text-3" id="text-org68b2ec7">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">function</th>
<th scope="col" class="org-left">use</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>str_detect</code></td>
<td class="org-left"><b>match</b> like <code>grepl</code></td>
</tr>

<tr>
<td class="org-left"><code>str_flatten</code></td>
<td class="org-left"><b>flatten</b> like <code>paste</code></td>
</tr>

<tr>
<td class="org-left"><code>str_interp</code></td>
<td class="org-left">string <b>interpolation</b> like <code>sprintf</code></td>
</tr>

<tr>
<td class="org-left"><code>str_replace</code></td>
<td class="org-left"><b>substitution</b> like <code>gsub</code></td>
</tr>

<tr>
<td class="org-left"><code>str_split</code></td>
<td class="org-left"><b>split</b> like <code>strsplit</code></td>
</tr>

<tr>
<td class="org-left"><code>str_subset</code></td>
<td class="org-left"><b>filters</b> strings like <code>grep</code></td>
</tr>

<tr>
<td class="org-left"><code>str_to_lower</code></td>
<td class="org-left">converts to lower case</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org6a8fc0c" class="outline-3">
<h3 id="org6a8fc0c">Documentation with <code>roxygen2</code></h3>
<div class="outline-text-3" id="text-org6a8fc0c">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">style</th>
<th scope="col" class="org-left">markup</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">italics</td>
<td class="org-left"><code>\emph{}</code></td>
</tr>

<tr>
<td class="org-left">bold</td>
<td class="org-left"><code>\strong{}</code></td>
</tr>

<tr>
<td class="org-left">mono-spaced</td>
<td class="org-left"><code>\code{}</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgca8ba00" class="outline-3">
<h3 id="orgca8ba00">Dates and times</h3>
<div class="outline-text-3" id="text-orgca8ba00">
<p>
<code>as.Date</code> is your friend.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Code</th>
<th scope="col" class="org-left">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>%d</code></td>
<td class="org-left">Day (integer)</td>
</tr>

<tr>
<td class="org-left"><code>%m</code></td>
<td class="org-left">Month (integer)</td>
</tr>

<tr>
<td class="org-left"><code>%b</code></td>
<td class="org-left">Abbreviated month (string)</td>
</tr>

<tr>
<td class="org-left"><code>%B</code></td>
<td class="org-left">Month (string)</td>
</tr>

<tr>
<td class="org-left"><code>%y</code></td>
<td class="org-left">Year (2 digits)</td>
</tr>

<tr>
<td class="org-left"><code>%Y</code></td>
<td class="org-left">Year (4 digits)</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org06301d4" class="outline-3">
<h3 id="org06301d4"><code>Rmath.h</code></h3>
<div class="outline-text-3" id="text-org06301d4">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">  To compile and run this I used the following...</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ sudo apt update</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ sudo apt install r-mathlib</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ sudo apt install r-base-dev</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ gcc -o mathlibtest demo.c -lRmath -lm</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ ./mathlibtest</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MATHLIB_STANDALONE</span> <span style="color: #4e3163;">1</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"Rmath.h"</span>


<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">fib</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">n</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>n &lt; <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3;">return</span><span style="color: #2d9574;">(</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3;">return</span><span style="color: #2d9574;">(</span>fib<span style="color: #67b11d;">(</span>n-<span style="color: #4e3163;">1</span><span style="color: #67b11d;">)</span> + fib<span style="color: #67b11d;">(</span>n-<span style="color: #4e3163;">2</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">ac</span>, <span style="color: #ba2f59; font-weight: bold;">char</span>** <span style="color: #715ab1;">av</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">n</span>;
  <span style="color: #ba2f59; font-weight: bold;">double</span> <span style="color: #715ab1;">foo</span>;

  <span style="color: #3a81c3;">for</span> <span style="color: #6c3163;">(</span> n = <span style="color: #4e3163;">0</span>; n &lt; <span style="color: #4e3163;">10</span>; n = n + <span style="color: #4e3163;">1</span> <span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%d\n"</span>, fib<span style="color: #67b11d;">(</span>n<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    foo = dnorm<span style="color: #2d9574;">(</span><span style="color: #4e3163;">1.0</span>, <span style="color: #4e3163;">0.0</span>, <span style="color: #4e3163;">1.0</span>, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%f\n"</span>, foo<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"hello, %s\n"</span>, <span style="color: #2d9574;">"world"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5aab4c4" class="outline-3">
<h3 id="org5aab4c4">Nifty utility functions</h3>
<div class="outline-text-3" id="text-org5aab4c4">
</div>
<div id="outline-container-orgbd0b04f" class="outline-4">
<h4 id="orgbd0b04f">Number of lines in a file</h4>
<div class="outline-text-4" id="text-orgbd0b04f">
<p>
The <code>num_lines_in_file</code> function returns the number of lines in a file which is
useful to help guard against attempting to parse an empty file with <code>read.csv</code>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">num_lines_in_file</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>fp<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  wc_stdout <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> system2<span style="color: #6c3163;">(</span>command = <span style="color: #2d9574;">"wc"</span>, args = c<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"-l"</span>, fp<span style="color: #2d9574;">)</span>, stdout = <span style="color: #4e3163;">TRUE</span><span style="color: #6c3163;">)</span>
  as.numeric<span style="color: #6c3163;">(</span>head<span style="color: #2d9574;">(</span>unlist<span style="color: #67b11d;">(</span>strsplit<span style="color: #b1951d;">(</span>x = wc_stdout, split = <span style="color: #2d9574;">" "</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>,<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4aff8df" class="outline-4">
<h4 id="org4aff8df">Julian day of the year</h4>
<div class="outline-text-4" id="text-org4aff8df">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> Julian day of the year</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> &gt; j_day("2014-01-03", "2014-01-01")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec; font-weight: bold;">'</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> 3</span>
<span style="color: #6c3163; font-weight: bold;">j_day</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>date_string, first_day_of_year_string<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  as.integer<span style="color: #6c3163;">(</span>as.Date<span style="color: #2d9574;">(</span>date_string<span style="color: #2d9574;">)</span> - as.Date<span style="color: #2d9574;">(</span>first_day_of_year_string<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> + <span style="color: #4e3163;">1</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce5fad4" class="outline-3">
<h3 id="orgce5fad4">Cheat sheets</h3>
<div class="outline-text-3" id="text-orgce5fad4">
<ul class="org-ul">
<li><a href="https://stuff.mit.edu/afs/athena/software/r/current/RStudio/resources/roxygen_help.html">roxygen(2)</a></li>
<li><a href="https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf">rmarkdown</a></li>
<li><a href="https://evoldyn.gitlab.io/evomics-2018/ref-sheets/R_purrr.pdf">purrr</a></li>
<li><a href="../resources/ess-cheat-sheet.pdf">ESS</a></li>
</ul>
</div>
</div>

<div id="outline-container-org49468e8" class="outline-3">
<h3 id="org49468e8">Data frames</h3>
<div class="outline-text-3" id="text-org49468e8">
</div>
<div id="outline-container-org5b619da" class="outline-4">
<h4 id="org5b619da">Sorting rows of a data frame</h4>
<div class="outline-text-4" id="text-org5b619da">
<div class="org-src-container">
<pre class="src src-R">iris<span style="color: #3a81c3;">[</span>order<span style="color: #6c3163;">(</span>iris$Sepal.Length<span style="color: #6c3163;">)</span>,<span style="color: #3a81c3;">]</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org70acbca" class="outline-3">
<h3 id="org70acbca">Data structures</h3>
<div class="outline-text-3" id="text-org70acbca">
</div>
<div id="outline-container-org1bfc16c" class="outline-4">
<h4 id="org1bfc16c">Hashmap</h4>
<div class="outline-text-4" id="text-org1bfc16c">
<p>
The environment builtin data structure can be used as a hashmap (since it hashes
by default), a.k.a. map, dictionary, loopkup&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-R">my_dict <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> new.env<span style="color: #3a81c3;">(</span>hash = <span style="color: #4e3163;">TRUE</span><span style="color: #3a81c3;">)</span>
my_dict<span style="color: #3a81c3;">[</span><span style="color: #6c3163;">[</span><span style="color: #2d9574;">"key"</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">]</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">2</span>
my_dict<span style="color: #3a81c3;">[</span><span style="color: #6c3163;">[</span><span style="color: #2d9574;">"key"</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">]</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">will return 2.</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf8eb2ff" class="outline-2">
<h2 id="orgf8eb2ff">Data munging</h2>
<div class="outline-text-2" id="text-orgf8eb2ff">
</div>
<div id="outline-container-orgd03c11f" class="outline-3">
<h3 id="orgd03c11f">Joins</h3>
<div class="outline-text-3" id="text-orgd03c11f">
<p>
There are several ways to join data frames using <code>dplyr</code>, the folling snippet
demonstrates a full join which duplicates records where necessary and will fill
in missing values. Although the data in the joined data frame does not depend on
the order of the arguments, the ordering of the rows does.
</p>

<div class="org-src-container">
<pre class="src src-R">foo <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>x = <span style="color: #4e3163;">1</span>:<span style="color: #4e3163;">3</span>, y = letters<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span>:<span style="color: #4e3163;">3</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
bar <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>x = c<span style="color: #6c3163;">(</span><span style="color: #4e3163;">2</span>:<span style="color: #4e3163;">4</span>,<span style="color: #4e3163;">2</span>:<span style="color: #4e3163;">4</span><span style="color: #6c3163;">)</span>, z = LETTERS<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span>:<span style="color: #4e3163;">6</span><span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
dplyr::full_join<span style="color: #3a81c3;">(</span>foo,bar<span style="color: #3a81c3;">)</span>
</pre>
</div>

<pre class="example">
Joining, by = "x"
  x    y    z
1 1    a &lt;NA&gt;
2 2    b    A
3 2    b    D
4 3    c    B
5 3    c    E
6 4 &lt;NA&gt;    C
7 4 &lt;NA&gt;    F
</pre>
</div>
</div>

<div id="outline-container-org024a273" class="outline-3">
<h3 id="org024a273">Aggregation</h3>
<div class="outline-text-3" id="text-org024a273">
<div class="org-src-container">
<pre class="src src-R">aggregate<span style="color: #3a81c3;">(</span>formula = Petal.Length ~ Species, FUN = mean, data = iris<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
is equivalent to
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>dplyr<span style="color: #3a81c3;">)</span>
iris <span style="color: #715ab1;">%&gt;%</span>
  group_by<span style="color: #3a81c3;">(</span>Species<span style="color: #3a81c3;">)</span> <span style="color: #715ab1;">%&gt;%</span>
  summarise<span style="color: #3a81c3;">(</span>mean_petal_length = mean<span style="color: #6c3163;">(</span>Petal.Length<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9b6e753" class="outline-2">
<h2 id="org9b6e753">Programming in R (language and evaluation)</h2>
<div class="outline-text-2" id="text-org9b6e753">
</div>
<div id="outline-container-orgec3c64b" class="outline-3">
<h3 id="orgec3c64b">Recommended reading</h3>
<div class="outline-text-3" id="text-orgec3c64b">
<ul class="org-ul">
<li><a href="https://www.r-bloggers.com/2019/07/bang-bang-how-to-program-with-dplyr/">Bang Bang - How to program with dplyr</a> (explains quotation stuff for dyplr)</li>
<li><a href="https://www.r-bloggers.com/2019/06/curly-curly-the-successor-of-bang-bang-2/">Curly-Curly, the successor of Bang-Bang</a> (new rlang syntax for extending dplyr)</li>
</ul>
</div>
</div>

<div id="outline-container-org0d0814c" class="outline-3">
<h3 id="org0d0814c">Functional programming support</h3>
<div class="outline-text-3" id="text-org0d0814c">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>magrittr<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>purrr<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here is a mapping between common functions in Haskell and their approximate
analogue in R.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Haskell</th>
<th scope="col" class="org-left">R</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>all</code></td>
<td class="org-left"><code>all</code></td>
</tr>

<tr>
<td class="org-left"><code>filter</code></td>
<td class="org-left"><code>keep</code> and <code>discard</code></td>
</tr>

<tr>
<td class="org-left"><code>map</code></td>
<td class="org-left"><code>map</code></td>
</tr>

<tr>
<td class="org-left"><code>scanl</code></td>
<td class="org-left"><code>accumulate</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgc2fa880" class="outline-3">
<h3 id="orgc2fa880">R/Haskell Prelude</h3>
<div class="outline-text-3" id="text-orgc2fa880">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #ecf3ec;">## </span><span style="color: #2aa1ae; background-color: #ecf3ec;">See https://hackage.haskell.org/package/base-4.15.0.0/docs/Prelude.html#v:dropWhile</span>
<span style="color: #6c3163; font-weight: bold;">drop_while</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>p, xs<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>length<span style="color: #2d9574;">(</span>xs<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    xs
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #6c3163;">{</span>
    x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> head<span style="color: #2d9574;">(</span>xs, <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>
    remaining <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> tail<span style="color: #2d9574;">(</span>xs, -<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>
    <span style="color: #3a81c3;">if</span> <span style="color: #2d9574;">(</span>p<span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      drop_while<span style="color: #67b11d;">(</span>p, remaining<span style="color: #67b11d;">)</span>
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #2d9574;">{</span>
      remaining
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">## </span><span style="color: #2aa1ae; background-color: #ecf3ec;">See https://hackage.haskell.org/package/base-4.15.0.0/docs/Prelude.html#v:takeWhile</span>
<span style="color: #6c3163; font-weight: bold;">take_while</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>p, xs<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>length<span style="color: #2d9574;">(</span>xs<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    xs
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #6c3163;">{</span>
    x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> head<span style="color: #2d9574;">(</span>xs, <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>
    remaining <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> tail<span style="color: #2d9574;">(</span>xs, -<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>
    <span style="color: #3a81c3;">if</span> <span style="color: #2d9574;">(</span>p<span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      c<span style="color: #67b11d;">(</span>x, take_while<span style="color: #b1951d;">(</span>p, remaining<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #2d9574;">{</span>
      c<span style="color: #67b11d;">()</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf33891c" class="outline-3">
<h3 id="orgf33891c">Program flow and control</h3>
<div class="outline-text-3" id="text-orgf33891c">
</div>
<div id="outline-container-org8dfccad" class="outline-4">
<h4 id="org8dfccad">Ternary operator</h4>
<div class="outline-text-4" id="text-org8dfccad">
<div class="org-src-container">
<pre class="src src-R">ifelse<span style="color: #3a81c3;">(</span>test, yes, no<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbab1a83" class="outline-4">
<h4 id="orgbab1a83">Switch/case/which</h4>
<div class="outline-text-4" id="text-orgbab1a83">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #6c3163; font-weight: bold;">centre</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>x, type<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">switch</span><span style="color: #6c3163;">(</span>type,
         mean = mean<span style="color: #2d9574;">(</span>x<span style="color: #2d9574;">)</span>,
         median = median<span style="color: #2d9574;">(</span>x<span style="color: #2d9574;">)</span>,
         trimmed = mean<span style="color: #2d9574;">(</span>x, trim = .1<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org037d4e1" class="outline-3">
<h3 id="org037d4e1">Numbers</h3>
<div class="outline-text-3" id="text-org037d4e1">
</div>
<div id="outline-container-org3e1e3a8" class="outline-4">
<h4 id="org3e1e3a8">Rounding</h4>
<div class="outline-text-4" id="text-org3e1e3a8">
<ul class="org-ul">
<li><code>ceiling</code> <code>floor</code> and <code>round</code> behave as expected.</li>
<li><code>signif</code> (significant figures) and <code>round</code> have a <code>digits</code> argument which can
be used to specify the number of digits to use.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org964ad19" class="outline-3">
<h3 id="org964ad19">Metaprogramming</h3>
<div class="outline-text-3" id="text-org964ad19">
<p>
The following snippet demonstrates how to get the value of a variable given a string containing its symbol.
There is a synonym <code>as.name</code> which derives from S terminology while "symbol" is LISP lingo.
</p>

<div class="org-src-container">
<pre class="src src-R">a <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">1</span>
eval<span style="color: #3a81c3;">(</span>as.symbol<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"a"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
This doesn't seem to work unless you have string literals.
Instead we can do the following
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">this has a syntax error</span>
data.frame<span style="color: #3a81c3;">(</span>letters<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> = <span style="color: #4e3163;">2</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">this works!</span>
eval<span style="color: #3a81c3;">(</span>parse<span style="color: #6c3163;">(</span>text = sprintf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"data.frame(%s = 2)"</span>, letters<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org32ff53c" class="outline-3">
<h3 id="org32ff53c">R6 and OOP</h3>
<div class="outline-text-3" id="text-org32ff53c">
<ul class="org-ul">
<li>R6 classes are a popular way to bring traditional OOP to R, they have reference semantics.</li>
<li>R6 is available on CRAN</li>
<li>The <code>R6Class</code> function is used to declare classes, the (public) <code>initialize</code> function is used to create instances of this class with <code>$new</code>.</li>
<li><code>self</code> is available within the class to describe the current object.</li>
<li>Assignment of fields is done with <code>&lt;-</code> e.g., <code>self$foo &lt;- "bar"</code></li>
<li>Returning <code>self</code> invisibly (<code>invisible(self)</code>) makes methods <i>chainable</i>.</li>
<li>Active bindings are a way to carry out side effects when assigning values which has a syntax which looks like you are just assigning to a field.</li>
<li>Fields containing reference objects should be set in the <code>initialize</code> method unless you want the object to be shared across all instances of the class.</li>
<li>By default, objects get a <code>clone</code> method, which is shallow; deep cloning can be achieved by passing <code>deep=TRUE</code>.</li>
<li>There was a <a href="https://github.com/r-lib/R6/issues/82#issue-133982435">request for interfaces in R6</a>, however Hadley suggested that this departed from the very minimalist goals of R6 so it will not be implemented.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org9c85378" class="outline-2">
<h2 id="org9c85378">Statistics with R</h2>
<div class="outline-text-2" id="text-org9c85378">
</div>
<div id="outline-container-org5880c2e" class="outline-3">
<h3 id="org5880c2e">Linear regression <code>lm</code></h3>
<div class="outline-text-3" id="text-org5880c2e">
<p>
<a href="./statistics-notes.html">NOTES</a>
</p>
</div>
</div>

<div id="outline-container-org68eade3" class="outline-3">
<h3 id="org68eade3">Zero-inflated regression</h3>
<div class="outline-text-3" id="text-org68eade3">
<p>
The following snippet demonstrates how to perform a zero-inflated Poisson
regression.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>pscl<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>boot<span style="color: #3a81c3;">)</span>
set.seed<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">1</span><span style="color: #3a81c3;">)</span>

n <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">1000</span>
x1 <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rnorm<span style="color: #3a81c3;">(</span>n = n<span style="color: #3a81c3;">)</span>
x2 <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rnorm<span style="color: #3a81c3;">(</span>n = n<span style="color: #3a81c3;">)</span>
z1 <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rnorm<span style="color: #3a81c3;">(</span>n = n<span style="color: #3a81c3;">)</span>
z2 <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rnorm<span style="color: #3a81c3;">(</span>n = n<span style="color: #3a81c3;">)</span>
true_prob_zinf <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> inv.logit<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">2</span> * z1 + <span style="color: #4e3163;">0</span> * z2<span style="color: #3a81c3;">)</span>
zero_inflation <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rbernoulli<span style="color: #3a81c3;">(</span>n = n,
                             p = true_prob_zinf<span style="color: #3a81c3;">)</span>

true_count_means <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> exp<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">2</span> * x1 - <span style="color: #4e3163;">1</span> * x2 + <span style="color: #4e3163;">1</span><span style="color: #3a81c3;">)</span>
maybe_count <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> rpois<span style="color: #3a81c3;">(</span>n = n,
                     lambda = true_count_means<span style="color: #3a81c3;">)</span>

y <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> ifelse<span style="color: #3a81c3;">(</span>zero_inflation, <span style="color: #4e3163;">0</span>, maybe_count<span style="color: #3a81c3;">)</span>

df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>y = y,
                 x1 = x1,
                 x2 = x2,
                 z1 = z1,
                 z2 = z2<span style="color: #3a81c3;">)</span>

my_zinb <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> zeroinfl<span style="color: #3a81c3;">(</span>formula = y ~ x1 + x2 | z1 + z2,
                    data = df, dist = <span style="color: #2d9574;">"poisson"</span><span style="color: #3a81c3;">)</span>

true_mean <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> true_prob_zinf * <span style="color: #4e3163;">0</span> + <span style="color: #3a81c3;">(</span><span style="color: #4e3163;">1</span> - true_prob_zinf<span style="color: #3a81c3;">)</span> * true_count_means

plot<span style="color: #3a81c3;">(</span>log<span style="color: #6c3163;">(</span>true_mean<span style="color: #6c3163;">)</span>, log<span style="color: #6c3163;">(</span>fitted<span style="color: #2d9574;">(</span>my_zinb<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
abline<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">0</span>,<span style="color: #4e3163;">1</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd5684a6" class="outline-3">
<h3 id="orgd5684a6"><span class="todo TODO">TODO</span> Mathematical optimisation</h3>
<div class="outline-text-3" id="text-orgd5684a6">
<p>
<a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/nlm.html"><code>nlm</code></a>
</p>
</div>
</div>

<div id="outline-container-orgb552a50" class="outline-3">
<h3 id="orgb552a50">Computational geography and cartography</h3>
<div class="outline-text-3" id="text-orgb552a50">
<p>
See <a href="./computational-geography-notes.html">my other notes on this</a>.
</p>
</div>
</div>

<div id="outline-container-org5a74342" class="outline-3">
<h3 id="org5a74342">Differential equations with <code>deSolve</code></h3>
<div class="outline-text-3" id="text-org5a74342">
</div>
<div id="outline-container-org4e59401" class="outline-4">
<h4 id="org4e59401">Basic SIR example</h4>
<div class="outline-text-4" id="text-org4e59401">
<p>
Simple SIR model
</p>

<p>
\[
\frac{ds}{dt} = -\beta s i \quad\text{and}\quad \frac{di}{dt} = \beta s i - \gamma i.
\]
</p>

<p>
The following demonstrates how to solve this system with <code>deSolve</code>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>deSolve<span style="color: #3a81c3;">)</span>

<span style="color: #6c3163; font-weight: bold;">sir_diff</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>time, state, params<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
    with<span style="color: #6c3163;">(</span>as.list<span style="color: #2d9574;">(</span>c<span style="color: #67b11d;">(</span>params, state<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">{</span>
        ds <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> - beta * susceptible * infectious
        di <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> beta * susceptible * infectious - gamma * infectious
        list<span style="color: #67b11d;">(</span>c<span style="color: #b1951d;">(</span>ds, di<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #2d9574;">}</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

params <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> c<span style="color: #3a81c3;">(</span>beta = <span style="color: #4e3163;">1.2</span>, gamma = <span style="color: #4e3163;">1</span><span style="color: #3a81c3;">)</span>
state <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> c<span style="color: #3a81c3;">(</span>susceptible = <span style="color: #4e3163;">0.99</span>, infectious = <span style="color: #4e3163;">0.01</span><span style="color: #3a81c3;">)</span>
times <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> seq<span style="color: #3a81c3;">(</span>from = <span style="color: #4e3163;">0</span>, to = <span style="color: #4e3163;">20</span>, length = <span style="color: #4e3163;">100</span><span style="color: #3a81c3;">)</span>
pd <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> matrix<span style="color: #3a81c3;">(</span>nrow = <span style="color: #4e3163;">2</span>, ncol = <span style="color: #4e3163;">2</span>, data = <span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span>
out1 <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> deSolve::ode<span style="color: #3a81c3;">(</span>state, times, sir_diff, parms = params<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org252c7e1" class="outline-4">
<h4 id="org252c7e1">SIR example with C implementation</h4>
<div class="outline-text-4" id="text-org252c7e1">
<p>
Then we can implement the differential in C as
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">file sirmod.c</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">R.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3;">static</span> <span style="color: #ba2f59; font-weight: bold;">double</span> <span style="color: #715ab1;">params</span><span style="color: #3a81c3;">[</span><span style="color: #4e3163;">2</span><span style="color: #3a81c3;">]</span>;
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">beta</span> params<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">0</span><span style="color: #3a81c3;">]</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">gamma</span> params<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">1</span><span style="color: #3a81c3;">]</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">initializer</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">initmod</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163;">(</span>* <span style="color: #6c3163; font-weight: bold;">odeparams</span><span style="color: #6c3163;">)(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">N</span>=<span style="color: #4e3163;">2</span>;
  odeparams<span style="color: #6c3163;">(</span>&amp;N, params<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Derivatives and 1 output variable</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">derivs</span> <span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">neq</span>, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">t</span>, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">y</span>, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">ydot</span>,
             <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">yout</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">ip</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>ip<span style="color: #2d9574;">[</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">]</span> &lt;<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> error<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"nout should be at least 1"</span><span style="color: #6c3163;">)</span>;
  ydot<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span> = -beta*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span>*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span>;
  ydot<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> = beta*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span>*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> - gamma*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span>;
  yout<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span> = <span style="color: #4e3163;">1.0</span>-y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span>+y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">END file sirmod.c</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
</pre>
</div>

<p>
Then we need to compile this and load the object for use of <code>deSovle</code>
</p>

<div class="org-src-container">
<pre class="src src-R">system<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"R CMD SHLIB sirmod.c"</span><span style="color: #3a81c3;">)</span>
dyn.load<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"sirmod.so"</span><span style="color: #3a81c3;">)</span>
out2 <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> deSolve::ode<span style="color: #3a81c3;">(</span>state, times, func = <span style="color: #2d9574;">"derivs"</span>, parms = params,
                     dllname = <span style="color: #2d9574;">"sirmod"</span>, initfunc = <span style="color: #2d9574;">"initmod"</span>, nout = <span style="color: #4e3163;">1</span>,
                     outnames = <span style="color: #2d9574;">"recovered"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6bc5c30" class="outline-3">
<h3 id="org6bc5c30">MCMC (without <code>Stan</code>)</h3>
<div class="outline-text-3" id="text-org6bc5c30">
<p>
There is the package <code>mcmc</code> which looks like it does a solid job of the basics,
although it takes an opinionated stance on how this should be done. Be careful
with how you interpret the <code>batch</code> arguments. The interface is designed for
testing out tuning parameters to find something that works; make the most of
this design.
</p>

<p>
<a href="https://cran.r-project.org/web/packages/coda/coda.pdf"><code>coda</code></a> is probably what you want to use to check the output beyond basic
diagnostic plots.
</p>
</div>

<div id="outline-container-org804f2c3" class="outline-4">
<h4 id="org804f2c3">Thinning (destructive)</h4>
<div class="outline-text-4" id="text-org804f2c3">
<p>
This snippet demonstrates how to subset a data frame. It is a destructive
change, but since MCMC samples can be large you may not want the additional cost
of creating a copy.
</p>

<div class="org-src-container">
<pre class="src src-R">demo_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>x = <span style="color: #4e3163;">1</span>:<span style="color: #4e3163;">100</span>, y = rnorm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">100</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">## </span><span style="color: #2aa1ae; background-color: #ecf3ec;">take every third sample</span>
thinning_factor <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">3</span>

demo_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> demo_df<span style="color: #3a81c3;">[</span>seq<span style="color: #6c3163;">(</span>from = <span style="color: #4e3163;">1</span>, to = nrow<span style="color: #2d9574;">(</span>demo_df<span style="color: #2d9574;">)</span>, by = thinning_factor<span style="color: #6c3163;">)</span>, <span style="color: #3a81c3;">]</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge8dc911" class="outline-3">
<h3 id="orge8dc911">(Nonparametric) density estimation with <code>KernSmooth</code></h3>
<div class="outline-text-3" id="text-orge8dc911">
<p>
Here is an example looking at how to use <code>KernSmooth</code>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #3a81c3;">library</span><span style="color: #3a81c3;">(</span>KernSmooth<span style="color: #3a81c3;">)</span>

set.seed<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">1</span><span style="color: #3a81c3;">)</span>

x <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> c<span style="color: #3a81c3;">(</span>rpois<span style="color: #6c3163;">(</span>n = <span style="color: #4e3163;">500</span>, lambda=<span style="color: #4e3163;">10</span><span style="color: #6c3163;">)</span>,
       rpois<span style="color: #6c3163;">(</span>n = <span style="color: #4e3163;">500</span>, lambda = <span style="color: #4e3163;">30</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #6c3163; font-weight: bold;">f_x</span> <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #3a81c3;">function</span><span style="color: #3a81c3;">(</span>x, ...<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #4e3163;">0.5</span> * <span style="color: #6c3163;">(</span>dpois<span style="color: #2d9574;">(</span>x = x, lambda = <span style="color: #4e3163;">10</span>, ...<span style="color: #2d9574;">)</span> +
         dpois<span style="color: #2d9574;">(</span>x = x, lambda = <span style="color: #4e3163;">30</span>, ...<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>

x_mesh <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> <span style="color: #4e3163;">0</span>:<span style="color: #4e3163;">100</span>
y_mesh <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> f_x<span style="color: #3a81c3;">(</span>x_mesh<span style="color: #3a81c3;">)</span>


kde_obj <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> bkde<span style="color: #3a81c3;">(</span>x, bandwidth = <span style="color: #4e3163;">3</span>, range.x = c<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span>,<span style="color: #4e3163;">100</span><span style="color: #6c3163;">)</span>, gridsize = <span style="color: #4e3163;">101</span><span style="color: #3a81c3;">)</span>

r_kde_samples <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> sample<span style="color: #3a81c3;">(</span>x = kde_obj$x,
                       size = length<span style="color: #6c3163;">(</span>x<span style="color: #6c3163;">)</span>,
                       replace = <span style="color: #4e3163;">TRUE</span>,
                       prob = pmax<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span>, kde_obj$y<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

type_char <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> c<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"true"</span>, <span style="color: #2d9574;">"estimate"</span><span style="color: #3a81c3;">)</span>

density_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>x = c<span style="color: #6c3163;">(</span>x_mesh, x_mesh<span style="color: #6c3163;">)</span>,
                         y = c<span style="color: #6c3163;">(</span>y_mesh, pmax<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span>, kde_obj$y<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>,
                         type = rep<span style="color: #6c3163;">(</span>type_char, each = <span style="color: #4e3163;">101</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

sample_df <span style="color: #ba2f59; font-weight: bold;">&lt;-</span> data.frame<span style="color: #3a81c3;">(</span>x = c<span style="color: #6c3163;">(</span>x, r_kde_samples<span style="color: #6c3163;">)</span>,
                        type = rep<span style="color: #6c3163;">(</span>type_char,
                                   each = length<span style="color: #2d9574;">(</span>x<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

ggplot<span style="color: #3a81c3;">()</span> +
  geom_histogram<span style="color: #3a81c3;">(</span>data = sample_df,
                 mapping = aes<span style="color: #6c3163;">(</span>x = x, y = ..density.., fill = type<span style="color: #6c3163;">)</span>,
                 bins = <span style="color: #4e3163;">25</span>,
                 size = <span style="color: #4e3163;">3</span>,
                 position = <span style="color: #2d9574;">"dodge"</span><span style="color: #3a81c3;">)</span> +
  geom_line<span style="color: #3a81c3;">(</span>data = density_df,
            mapping = aes<span style="color: #6c3163;">(</span>x = x, y = y, colour = type<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alex Zarebski</p>
<p class="date">Created: 2022-03-11 Fri 12:09</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
