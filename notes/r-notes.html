<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-02-21 Fri 17:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>R notes</title>
<meta name="author" content="Alexander E. Zarebski" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="icon" type="image/png" href="../resources/nicemacs-favicon.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
<link rel="stylesheet" href="../microgram.css">
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">R notes</h1>
<p>
<a href="../notes.html">Home</a>
</p>


<div id="orgeed6e1a" class="figure">
<p><img src="../images/r-logo.png" alt="r-logo.png" width="250px" />
</p>
</div>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgd5649df">Programming in R (markdown and reproducibility)</a>
<ul>
<li><a href="#org5d82290">Quarto</a></li>
</ul>
</li>
<li><a href="#org4ab527b">Programming in R (installation and administration)</a>
<ul>
<li><a href="#org84e2b16">Installing and updating R</a></li>
<li><a href="#orge6f5edf">Managing R installations</a></li>
</ul>
</li>
<li><a href="#org991f14b">Programming in R (software development)</a>
<ul>
<li><a href="#org012077e">Linting code</a></li>
<li><a href="#orgb144e91">Debugging</a></li>
<li><a href="#org0ea08ac">Scripting with R</a></li>
<li><a href="#org0e1aea6">Working with files</a></li>
<li><a href="#org1977102">Error handling</a></li>
<li><a href="#org055cf46"><i>R Packages</i> by Wickham and Bryan</a></li>
<li><a href="#orga37a9c6">High performance computing</a></li>
<li><a href="#org0e685fa">Packages I like</a></li>
<li><a href="#orgeb7eaf7">Reshaping dataframes with <code>reshape2</code></a></li>
<li><a href="#org1b17710">Command line arguments</a></li>
<li><a href="#orgcb2efb5">Command line arguments with <code>argparse</code></a></li>
<li><a href="#org2e3a3a2">Working with JSON</a></li>
<li><a href="#orgc681e10">Working with HTML</a></li>
<li><a href="#org75af42e">OUTDATED: Working with XML with <code>XML</code></a></li>
<li><a href="#orgbea32ff">Working with Mustache templates</a></li>
<li><a href="#testthat-expectations">Unit testing with <code>testthat</code></a></li>
<li><a href="#orgb5cfe2f">Dependency management with <code>packrat</code></a></li>
<li><a href="#org4eb0f85">Package and project management with <code>usethis</code></a></li>
<li><a href="#org2f9c14a">Date handling with <code>lubridate</code></a></li>
<li><a href="#org39d005e">String handling with <code>stringr</code></a></li>
<li><a href="#orgedbca21">Documentation with <code>roxygen2</code></a></li>
<li><a href="#orga8d448e">Dates and times</a></li>
<li><a href="#org7121ea9"><code>Rmath.h</code></a></li>
<li><a href="#org64d7078">Cheat sheets</a></li>
<li><a href="#org38ab189">Data structures</a></li>
</ul>
</li>
<li><a href="#orge0ccf69">Programming in R (language and evaluation)</a>
<ul>
<li><a href="#orgcc73556">Recommended reading</a></li>
<li><a href="#orgedb3a72">Memory usage</a></li>
<li><a href="#org8850e36">Benchmarking and optimising impementations</a></li>
<li><a href="#org159d694">Functional programming support</a></li>
<li><a href="#org1b9cf9c">R/Haskell Prelude</a></li>
<li><a href="#org6e5eccd">Program flow and control</a></li>
<li><a href="#orgc9d071c">Numbers</a></li>
<li><a href="#orgc6f743a">Metaprogramming and nonstandard evaluation</a></li>
<li><a href="#org055bd50">Object-oriented programming</a></li>
</ul>
</li>
<li><a href="#org9b28efd">Data munging</a>
<ul>
<li><a href="#orgb4672cf">IO with R Data Serialisation (RDS)</a></li>
<li><a href="#orged6fe6c">Working with XML</a></li>
<li><a href="#org47a3ab5">Joins</a></li>
<li><a href="#org44dc284">Aggregation</a></li>
<li><a href="#orgec7e7c2">Selecting columns</a></li>
<li><a href="#org0f64bbe">Sorting rows</a></li>
<li><a href="#orgf1f1809">Renaming columns</a></li>
</ul>
</li>
<li><a href="#org8dfbfa7">Statistics with R</a>
<ul>
<li><a href="#org403cebc">GLM</a></li>
<li><a href="#org2207bc1">Linear regression <code>lm</code></a></li>
<li><a href="#org6bb7ddb">Zero-inflated regression</a></li>
<li><a href="#orgd553b6b"><span class="todo TODO">TODO</span> Mathematical optimisation</a></li>
<li><a href="#orga5422d2">Computational geography and cartography</a></li>
<li><a href="#org2788fd7">Differential equations with <code>deSolve</code></a></li>
<li><a href="#orgbed2ac8">MCMC (without <code>Stan</code>)</a></li>
<li><a href="#org1173aa8">(Nonparametric) density estimation with <code>KernSmooth</code></a></li>
</ul>
</li>
<li><a href="#org40d0a50">Miscellaneous functions</a>
<ul>
<li><a href="#orga9afa4d">Function to save a ggplot to both PNG and SVG</a></li>
<li><a href="#org88992cd">Quantile functions of truncated distributions</a></li>
<li><a href="#orge05ef43">Read BEAST2 log file</a></li>
<li><a href="#org186584b">Generating LaTeX summary of GLM</a></li>
<li><a href="#orgb0e8227">Mini test suite</a></li>
<li><a href="#orga212bdc">Step function</a></li>
<li><a href="#org203219d">Number of lines in a file</a></li>
<li><a href="#orgf6aff2e">Julian day of the year</a></li>
</ul>
</li>
<li><a href="#org3660b02">RStudio</a>
<ul>
<li><a href="#org57905f2">Making it comfortable to work in</a></li>
</ul>
</li>
<li><a href="#org4fdf2f0">Further reading</a>
<ul>
<li><a href="#orgafedaca">Articles</a></li>
<li><a href="#org3be346c">Blogs</a></li>
<li><a href="#org8516fcf">Books</a></li>
<li><a href="#org4cbf996">Documentation</a></li>
<li><a href="#orgb9aa869">Curated packages</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgd5649df" class="outline-2">
<h2 id="orgd5649df">Programming in R (markdown and reproducibility)</h2>
<div class="outline-text-2" id="text-orgd5649df">
</div>
<div id="outline-container-org5d82290" class="outline-3">
<h3 id="org5d82290">Quarto</h3>
<div class="outline-text-3" id="text-org5d82290">
<p>
<code>.qmd</code> files can be rendered to HTML or PDF from RStudio or the
command line. To compile these from the command line use the following
</p>

<div class="org-src-container">
<pre class="src src-sh">quarto render &lt;path/to/file.qmd&gt;
</pre>
</div>

<p>
The default settings during PDF generation are the following:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">format</span>:
<span style="color: #BA36A5;">pdf</span>:
  <span style="color: #BA36A5;">documentclass</span>: scrartcl
  <span style="color: #BA36A5;">papersize</span>: letter
</pre>
</div>
</div>

<div id="outline-container-org18b3b1b" class="outline-4">
<h4 id="org18b3b1b">Code chunks</h4>
<div class="outline-text-4" id="text-org18b3b1b">
<p>
When loading libraries, you can avoid messages being printed with the
following:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">| message: false</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb489841" class="outline-4">
<h4 id="orgb489841">Table of contents</h4>
<div class="outline-text-4" id="text-orgb489841">
<p>
To include a table of contents, extend the preamble:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">format</span>:
  <span style="color: #BA36A5;">pdf</span>:
    <span style="color: #BA36A5;">toc</span>: <span style="color: #D0372D;">true</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org4ab527b" class="outline-2">
<h2 id="org4ab527b">Programming in R (installation and administration)</h2>
<div class="outline-text-2" id="text-org4ab527b">
</div>
<div id="outline-container-org84e2b16" class="outline-3">
<h3 id="org84e2b16">Installing and updating R</h3>
<div class="outline-text-3" id="text-org84e2b16">
<p>
<b>Last update was to 4.3.0 &#x2013; Already Tomorrow</b>
</p>

<p>
R updates frequently and things can break, so it is a good idea to keep your
version of R reasonably up to date. You can obtain the source code for every
version of R from <a href="https://cran.r-project.org/src/base/">CRAN</a>. The steps involved in getting a particular version of R
are as follows.
</p>

<ol class="org-ol">
<li>Ensure you have the necessary dependencies with <code>sudo apt-get r-base</code>.</li>
<li>Download the relevant source, e.g. <code>R-4.2.1.tar.gz</code>, and unzip it: <code>tar -xvf
   R-X.Y.Z.tar.gz</code>.</li>
<li>Run <code>./configure</code> be sure to double check the output for configuration errors.
<ul class="org-ul">
<li>If you are using this with RStudio, you will need to use <code>--enable-R-shlib</code>.</li>
<li>If you are using SVG you may need to include <code>--with-cairo</code>.</li>
<li>If you are using Wayland you might need <code>--with-x=no</code>.</li>
<li>If you want extra optimisations add <code>CFLAGS='-O3' CXXFLAGS='-O3' FFLAGS='-O3'</code></li>
</ul></li>
<li>Run <code>make</code> and <code>make info</code> to compile R and the documentation.
<ul class="org-ul">
<li>If you want to speed up compilation, <code>make -j4</code> runs it in
parallel across 4 coures.</li>
</ul></li>
<li>Check that the compilation has worked properly with <code>make check</code> and address
any issues that arise.</li>
<li>Install the executable with <code>sudo make install</code> and <code>sudo make install-info</code>.</li>
<li>Check it worked with <code>R -e "sessionInfo()"</code>.</li>
<li>Profit!</li>
</ol>

<p>
Note that step 3 takes the longest, but this still took less than 20 minutes on
my machine for <code>R-4.1.0</code>. After updating, you'll probably have lost all your
packages, the following command can help with this.
</p>

<div class="org-src-container">
<pre class="src src-R">my_pkgs <span style="color: #D0372D;">&lt;-</span> c(<span style="color: #008000;">"ape"</span>,
             <span style="color: #008000;">"argparse"</span>,
             <span style="color: #008000;">"coda"</span>,
             <span style="color: #008000;">"cowplot"</span>,
             <span style="color: #008000;">"dplyr"</span>,
             <span style="color: #008000;">"devtools"</span>,
             <span style="color: #008000;">"deSolve"</span>,
             <span style="color: #008000;">"future"</span>,
             <span style="color: #008000;">"furrr"</span>,
             <span style="color: #008000;">"ggplot2"</span>,
             <span style="color: #008000;">"htmltools"</span>,
             <span style="color: #008000;">"jsonlite"</span>,
             <span style="color: #008000;">"phangorn"</span>,
             <span style="color: #008000;">"purrr"</span>,
             <span style="color: #008000;">"mcmc"</span>,
             <span style="color: #008000;">"remotes"</span>,
             <span style="color: #008000;">"reshape2"</span>,
             <span style="color: #008000;">"stringr"</span>,
             <span style="color: #008000;">"targets"</span>,
             <span style="color: #008000;">"xml2"</span>)
install.packages(my_pkgs)
</pre>
</div>

<p>
Last time when I updated the packages it said the default library was not
writable so I used a personal library instead. Running the session with <code>sudo</code>
fixed this. Old package versions hanging around can be found with <code>.libPaths()</code>.
</p>
</div>

<div id="outline-container-org635527a" class="outline-4">
<h4 id="org635527a">Notes</h4>
<div class="outline-text-4" id="text-org635527a">
<ul class="org-ul">
<li><code>R.4.4.2</code> I needed to install a few packages because this was a new
machine, but essentially the same as last time.</li>
<li><code>R.4.3.0</code> I needed to install <code>xorg-dev</code> prior to configuration to
get this working with X.</li>
<li><code>R.4.2.3</code> I needed to use <code>--with-x=no</code> because I don't have X on the new
laptop. Sadly, this seems to break plots. Also, <code>make install</code> put the binary
in <code>/usr/local/bin</code> which appeared on the path after the location where the
default installation is.</li>
<li><code>R.4.2.1</code></li>
<li><code>R.4.2.0</code> extends the pipe syntax, and some cases where <code>if</code> and <code>while</code> previously
threw a warning now throw and error.</li>
<li><code>R-4.1.2</code></li>
<li><code>R-4.1.0</code> introduces some new syntax: <code>|&gt;</code> for piping and some sugar for
anonymous functions, eg <code>\(x) x + 1</code> becomes <code>function(x) x+1</code>. After
upgrading I could not create plots interactively, instead there was a message
about <code>unable to start device X11cairo</code>. The fix for this was to set the
<code>DISPLAY</code> environment variable to <code>:1</code> where it was defaulting to <code>:0</code>.</li>
<li><code>R-4.0.4</code> Having some problems getting ggplot figures with transparency
working but only in the PDF output. It hasn't been a problem so far so leaving
it until next time. I was prompted to use a personal library for the packages
this time, it is at <code>/home/aez/R/x86_64-pc-linux-gnu-library/4.0</code>.</li>
<li><code>R-4.0.2</code> needed me to install <code>libpcre2-dev</code> to get the configuration step to
work. I also had to use <code>sudo make install</code> to install the executable where as
previously it had not needed this level of permission. The <code>update.packages</code>
command didn't work as expected this time, which prompted the installation
list. I also needed to install a package <code>build-dep</code> before building this.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge6f5edf" class="outline-3">
<h3 id="orge6f5edf">Managing R installations</h3>
<div class="outline-text-3" id="text-orge6f5edf">
<p>
There is an R package, <a href="https://github.com/r-lib/rim">rim</a>, which manages installations: R installation manager.
</p>
</div>
</div>
</div>

<div id="outline-container-org991f14b" class="outline-2">
<h2 id="org991f14b">Programming in R (software development)</h2>
<div class="outline-text-2" id="text-org991f14b">
</div>
<div id="outline-container-org012077e" class="outline-3">
<h3 id="org012077e">Linting code</h3>
<div class="outline-text-3" id="text-org012077e">
<p>
There is the <code>stylr</code> package for formating code. The following script
makes it easy to format every R file in a directory from the command
line.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env Rscript</span>
<span style="color: #8D8D84;">##</span>
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">Usage</span>
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">=====</span>
<span style="color: #8D8D84;">##</span>
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">./stylr.R &lt;path_to_directory&gt;</span>
<span style="color: #8D8D84;">##</span>
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">Styles all the R files in the specified directory.</span>
<span style="color: #8D8D84;">##</span>
<span style="color: #D0372D;">library</span>(styler)


<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Style the R files in the specified directory</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">dir_path</span><span style="color: #8D8D84; font-style: italic;"> The path to the directory containing the R files</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">style_r_files</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(dir_path) {
  <span style="color: #0000FF;">if</span> (!grepl(<span style="color: #008000;">"/$"</span>, dir_path)) {
    dir_path <span style="color: #D0372D;">&lt;-</span> paste0(dir_path, <span style="color: #008000;">"/"</span>)
  }

  files <span style="color: #D0372D;">&lt;-</span> list.files(dir_path, pattern = <span style="color: #008000;">"\\.R$"</span>, full.names = <span style="color: #6434A3;">TRUE</span>)
  lapply(files, style_file)

  <span style="color: #0000FF;">if</span> (length(files) &gt; 0) {
    cat(<span style="color: #008000;">"Styled files:\n"</span>, paste(files, collapse = <span style="color: #008000;">"\n"</span>), <span style="color: #008000;">"\n"</span>)
  } <span style="color: #0000FF;">else</span> {
    cat(<span style="color: #008000;">"No R files found in the specified directory.\n"</span>)
  }
}


<span style="color: #006699;">main</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>() {
  args <span style="color: #D0372D;">&lt;-</span> commandArgs(trailingOnly = <span style="color: #6434A3;">TRUE</span>)
  <span style="color: #0000FF;">if</span> (length(args) == 0) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"No directory specified. Usage: ./stylr.R &lt;path_to_directory&gt;"</span>, call. = <span style="color: #6434A3;">FALSE</span>)
  }

  style_r_files(args[1])
}

main()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb144e91" class="outline-3">
<h3 id="orgb144e91">Debugging</h3>
<div class="outline-text-3" id="text-orgb144e91">
<p>
R makes it easy to shoot yourself in the foot, but it also makes it
easy to patch your foot up again afterwards.
</p>

<dl class="org-dl">
<dt><code>browser()</code></dt><dd>to create a breakpoint in your source code</dd>
<dt><code>debugonce()</code></dt><dd>to enter the debugger next time you run a
particular function.</dd>
</dl>
</div>
</div>

<div id="outline-container-org0ea08ac" class="outline-3">
<h3 id="org0ea08ac">Scripting with R</h3>
<div class="outline-text-3" id="text-org0ea08ac">
</div>
<div id="outline-container-org3cd247f" class="outline-4">
<h4 id="org3cd247f">Running system commands with <code>base</code></h4>
<div class="outline-text-4" id="text-org3cd247f">
<div class="org-src-container">
<pre class="src src-R">system2(command, args = character(),
        wait = <span style="color: #6434A3;">TRUE</span>,
        timeout = 0)
</pre>
</div>

<ul class="org-ul">
<li>if <code>wait</code> is set to <code>FALSE</code> then this will run asynchronously</li>
<li>if <code>timeout</code> is set to a value greater than zero it will kill the process
after that amount of time if it has not finished.</li>
</ul>

<div class="org-src-container">
<pre class="src src-R">system2(<span style="color: #008000;">"ls"</span>, args = <span style="color: #008000;">"/home/aez/Documents"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ac6bb4" class="outline-4">
<h4 id="org6ac6bb4">Running system commands with <code>processx</code></h4>
<div class="outline-text-4" id="text-org6ac6bb4">
<p>
There is the <code>run</code> command (from the library) which is a convenience function,
otherwise you can use <code>process$new(...)</code> to create an instance of a new process.
</p>
</div>
</div>

<div id="outline-container-org794e1ea" class="outline-4">
<h4 id="org794e1ea">Helper function for system commands</h4>
<div class="outline-text-4" id="text-org794e1ea">
<p>
The following can be saved to a file and imported if you just need that one
function.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">message</span>(<span style="color: #008000;">"loading the run_command function."</span>)

<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Helper function for running system commands.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Example</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> &gt; run_command("stack build")</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> &gt; run_command("Rscript R/make-simulation-configuration-1.R")</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">run_command</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(cmd, silent = <span style="color: #6434A3;">TRUE</span>, ...) {
  <span style="color: #D0372D;">message</span>(sprintf(<span style="color: #008000;">"\nRunning command:\n\t%s"</span>, cmd))
  tmp <span style="color: #D0372D;">&lt;-</span> unlist(strsplit(cmd, <span style="color: #008000;">" "</span>))
  cmd_name <span style="color: #D0372D;">&lt;-</span> head(tmp, 1)
  cmd_args <span style="color: #D0372D;">&lt;-</span> tail(tmp, -1)
  std_val <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">if</span> (silent) {
    <span style="color: #6434A3;">FALSE</span>
  } <span style="color: #0000FF;">else</span> {
    <span style="color: #008000;">""</span>
  }
  result <span style="color: #D0372D;">&lt;-</span> system2(
    cmd_name,
    args = cmd_args,
    stdout = std_val,
    stderr = std_val,
    ...
  )
  <span style="color: #0000FF;">if</span> (result != 0) {
    <span style="color: #0000FF;">stop</span>(sprintf(<span style="color: #008000;">"command %s failed!"</span>, cmd))
  }
  <span style="color: #0000FF;">return</span>(<span style="color: #6434A3;">NULL</span>)
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0e1aea6" class="outline-3">
<h3 id="org0e1aea6">Working with files</h3>
<div class="outline-text-3" id="text-org0e1aea6">
<p>
In addition to the built-in functions described in <a href="#orgcde5f03">this table</a>, there
is a package <a href="https://fs.r-lib.org/">fs</a> which aims to provide a consistent interface across
operating systems and may be more appropriate if you are doing a lot
of file manipulation.
</p>

<table id="orgcde5f03" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Some functions for working with filepaths.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Function</th>
<th scope="col" class="org-left">Use</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>tempfile</code></td>
<td class="org-left">create temporary file</td>
</tr>

<tr>
<td class="org-left"><code>basename</code></td>
<td class="org-left">get the file's name</td>
</tr>

<tr>
<td class="org-left"><code>dirname</code></td>
<td class="org-left">get the file's directory</td>
</tr>

<tr>
<td class="org-left"><code>file.exists</code></td>
<td class="org-left">predicate for file existance</td>
</tr>

<tr>
<td class="org-left"><code>dir.exists</code></td>
<td class="org-left">predicate for directory existance</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org1977102" class="outline-3">
<h3 id="org1977102">Error handling</h3>
<div class="outline-text-3" id="text-org1977102">
<p>
Hadley has a nice <a href="http://adv-r.had.co.nz/Exceptions-Debugging.html#condition-handling">description</a> of how to handle these things in more detail, but here is a small example (from him)
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #006699;">show_condition</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(code) {
  <span style="color: #0000FF;">tryCatch</span>(code,
    error = <span style="color: #0000FF;">function</span>(c) <span style="color: #008000;">"error"</span>
  )
}
show_condition(<span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"!"</span>)) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">evaluates to the string "error"</span>
show_condition(10) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">evalates to the numeric 10</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org055cf46" class="outline-3">
<h3 id="org055cf46"><i>R Packages</i> by Wickham and Bryan</h3>
<div class="outline-text-3" id="text-org055cf46">
<p>
There is a new edition of the <a href="https://r-pkgs.org/">R packages book available online</a>. Here
are some notes about package creation based on reading through that
book. <i>R Packages</i> tries to be friendly for those getting started and
<a href="https://cran.r-project.org/doc/manuals/R-exts.html#Top">Writing R Extensions</a> is the definitive reference.
</p>
</div>

<div id="outline-container-org7b8f14f" class="outline-4">
<h4 id="org7b8f14f">Package development loop</h4>
<div class="outline-text-4" id="text-org7b8f14f">
<ol class="org-ol">
<li><code>library(devtools)</code></li>
<li><code>create_package("~/path/to/my/package")</code> to set up the package</li>
<li><code>use_git()</code></li>
<li><code>use_r("funky")</code> will set up an appropriate file for the named
function. The standard is to use <code>R/funky.R</code>.</li>
<li><code>load_all()</code> to bring the functions into the REPL to check it</li>
<li><code>use_mit_license("Alexander E. Zarebski")</code></li>
<li>Edit the <code>DESCRIPTION</code></li>
<li><code>document()</code></li>
<li><code>check()</code> to check the package works</li>
<li><code>install()</code> to install on the current machine</li>
<li>Testing:
<ol class="org-ol">
<li><code>use_testthat()</code></li>
<li><code>use_test("funky")</code> to template a test for the <code>funky</code> function</li>
<li><code>test()</code> to run the tests</li>
<li>See <a href="#testthat-expectations">these notes</a> for details on how to write tests.</li>
</ol></li>
<li><code>use_package("package_name")</code> adds the named package as a
dependency.</li>
<li><code>use_readme_rmd()</code> sets up a README.</li>
<li><code>uninstall("&lt;package&gt;")</code> to uninstall <code>&lt;package&gt;</code></li>
</ol>

<p>
This information is also summarised in <a href="https://r-pkgs.org/whole-game.html#fig-package-dev-workflow">Section 1.20</a>.
</p>
</div>
</div>

<div id="outline-container-org4de82fa" class="outline-4">
<h4 id="org4de82fa">Package dependencies</h4>
<div class="outline-text-4" id="text-org4de82fa">
<p>
The <code>DESCRIPTION</code> file is the place to go! <i>Hadley says:</i> add
dependencies <code>foo</code> and <code>bar</code> with <code>use_package("foo", "bar")</code>. Use
<code>usethis::use_package</code> as they have deprecated <code>devtools::use_packag</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">usethis::use_package(<span style="color: #008000;">"foo"</span>, <span style="color: #008000;">"bar"</span>)
</pre>
</div>

<p>
The <code>DESCRIPTION</code> will now have the following entry added
</p>

<div class="org-src-container">
<pre class="src src-text">Imports:
    foo,
    bar
</pre>
</div>

<p>
If the package depends on a specific version of the package this can be added too.
</p>

<div class="org-src-container">
<pre class="src src-text">Imports:
    foo (&gt;= 0.2),
    bar (&gt;= 0.3.0.1)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9394458" class="outline-4">
<h4 id="org9394458">Vignettes</h4>
<div class="outline-text-4" id="text-org9394458">
<p>
Create a template vignette with <code>usethis::use_vignette</code>.
There is an <a href="https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf">R Markdown Cheat Sheet</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orga37a9c6" class="outline-3">
<h3 id="orga37a9c6">High performance computing</h3>
<div class="outline-text-3" id="text-orga37a9c6">
<p>
<a href="https://cran.r-project.org/view=HighPerformanceComputing">CRAN Task View for High Performance Computing</a>
</p>

<p>
The package <a href="https://cran.r-project.org/web/packages/furrr/furrr.pdf"><code>furrr</code></a> provides <code>purrr</code> style functions which run in parallel. See
the following snippet for an example
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(future)
plan(multiprocess)

y <span style="color: #D0372D;">&lt;-</span> furrr::future_map(x, ~ f(.x))
</pre>
</div>

<p>
<b>WARNING</b> It looks like <code>furrr</code> will kick up a fuss if <code>f</code> attempts to perform
any IO. It's a good way to force the use of pure functions.
</p>
</div>
</div>

<div id="outline-container-org0e685fa" class="outline-3">
<h3 id="org0e685fa">Packages I like</h3>
<div class="outline-text-3" id="text-org0e685fa">
</div>
<div id="outline-container-org4c56a0c" class="outline-4">
<h4 id="org4c56a0c"><a href="https://cran.r-project.org/web/packages/ape/ape.pdf">ape</a> Analyses of Phylogenetics and Evolution</h4>
</div>
<div id="outline-container-orgf4d285a" class="outline-4">
<h4 id="orgf4d285a"><a href="https://cran.r-project.org/web/packages/deSolve/index.html">deSolve</a> Solvers for Initial Value Problems of Differential Equations</h4>
</div>
<div id="outline-container-orga73215c" class="outline-4">
<h4 id="orga73215c"><a href="https://cran.r-project.org/web/packages/lhs/vignettes/lhs_basics.html">lhs</a> Latin Hypercube Samples</h4>
<div class="outline-text-4" id="text-orga73215c">
<ul class="org-ul">
<li><code>randomLHS(n,k)</code> generates \(n\) samples from \([0,1]^{k}\).</li>
</ul>
</div>
</div>
<div id="outline-container-orgfbf0964" class="outline-4">
<h4 id="orgfbf0964"><a href="https://cran.r-project.org/web/packages/magrittr/magrittr.pdf">magrittr</a> a forward pipe operator for R</h4>
<div class="outline-text-4" id="text-orgfbf0964">
<p>
There are many useful aliases exported by <code>magrittr</code>, the table below has some examples.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Alias</th>
<th scope="col" class="org-left">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>extract</code></td>
<td class="org-left"><code>`[`</code></td>
</tr>

<tr>
<td class="org-left"><code>extract2</code></td>
<td class="org-left"><code>`[[`</code></td>
</tr>

<tr>
<td class="org-left"><code>use_series</code></td>
<td class="org-left"><code>`$`</code></td>
</tr>

<tr>
<td class="org-left"><code>is_in</code></td>
<td class="org-left"><code>`%in%`</code></td>
</tr>

<tr>
<td class="org-left"><code>is_greater_than</code></td>
<td class="org-left"><code>`&gt;`</code></td>
</tr>

<tr>
<td class="org-left"><code>set_colnames</code></td>
<td class="org-left"><code>`colnames&lt;-`</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgae3469c" class="outline-4">
<h4 id="orgae3469c"><a href="https://cran.r-project.org/web/packages/stringr/stringr.pdf">stringr</a> Simple, Consistent Wrappers for Common String Operations</h4>
</div>
<div id="outline-container-orgadea67a" class="outline-4">
<h4 id="orgadea67a"><a href="https://cran.r-project.org/web/packages/styler/styler.pdf">styler</a> Non-Invasive Pretty Printing of R Code</h4>
</div>
<div id="outline-container-org7e56299" class="outline-4">
<h4 id="org7e56299"><a href="https://cran.r-project.org/web/packages/testthat/testthat.pdf">testthat</a> Unit Testing for R</h4>
</div>
<div id="outline-container-org5c54a9c" class="outline-4">
<h4 id="org5c54a9c"><a href="https://cran.r-project.org/web/packages/truncnorm/truncnorm.pdf">truncnorm</a> Truncated Normal Distribution</h4>
</div>
</div>

<div id="outline-container-orgeb7eaf7" class="outline-3">
<h3 id="orgeb7eaf7">Reshaping dataframes with <code>reshape2</code></h3>
<div class="outline-text-3" id="text-orgeb7eaf7">
</div>
<div id="outline-container-org3e63bdc" class="outline-4">
<h4 id="org3e63bdc">Casting</h4>
<div class="outline-text-4" id="text-org3e63bdc">
<p>
Casting is difficult, this figure made by <a href="https://seananderson.ca/2013/10/19/reshape/">Sean C. Anderson</a> helps
</p>


<div id="org603fc32" class="figure">
<p><img src="../images/dcast-illustration.png" alt="dcast-illustration.png" width="700px" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org1b17710" class="outline-3">
<h3 id="org1b17710">Command line arguments</h3>
<div class="outline-text-3" id="text-org1b17710">
<p>
The simplest example is probably what you'll need most of the time
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">demo.R</span>
args <span style="color: #D0372D;">&lt;-</span> commandArgs(trailingOnly = <span style="color: #6434A3;">TRUE</span>)
print(args)
</pre>
</div>

<p>
As an example consider the following command and output
</p>

<pre class="example">
$ Rscript demo.R 3 foo.csv
[1] "3"       "foo.csv"
</pre>

<p>
Be careful when passing in numbers because they are read in as strings.
</p>
</div>
</div>

<div id="outline-container-orgcb2efb5" class="outline-3">
<h3 id="orgcb2efb5">Command line arguments with <code>argparse</code></h3>
<div class="outline-text-3" id="text-orgcb2efb5">
<p>
See the <a href="https://cran.r-project.org/web/packages/argparse/vignettes/argparse.html">vignette</a>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(argparse)

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">create parser object</span>
parser <span style="color: #D0372D;">&lt;-</span> ArgumentParser()

parser$add_argument(
         <span style="color: #008000;">"-v"</span>,
         <span style="color: #008000;">"--verbose"</span>,
         action = <span style="color: #008000;">"store_true"</span>,
         default = <span style="color: #6434A3;">FALSE</span>,
         help = <span style="color: #008000;">"Verbose output"</span>
       )
parser$add_argument(
         <span style="color: #008000;">"-s"</span>,
         <span style="color: #008000;">"--seed"</span>,
         type = <span style="color: #008000;">"integer"</span>,
         default = 1,
         help = <span style="color: #008000;">"PRNG seed"</span>
       )
parser$add_argument(
         <span style="color: #008000;">"-p"</span>,
         <span style="color: #008000;">"--parameters"</span>,
         type = <span style="color: #008000;">"character"</span>,
         help = <span style="color: #008000;">"Filepath to parameters JSON"</span>
       )

args <span style="color: #D0372D;">&lt;-</span> parser$parse_args()
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e3a3a2" class="outline-3">
<h3 id="org2e3a3a2">Working with JSON</h3>
<div class="outline-text-3" id="text-org2e3a3a2">
<p>
For parsing and encoding JSON there is the <code>jsonlite</code> package.
</p>

<p>
<b>WARNING:</b> by default <code>jsonlite::write_json</code> only uses 4 digits which is not
enough for many scientific applications, unless there is a good reason not to,
it is probably better to set <code>digits = 16</code>.
</p>
</div>

<div id="outline-container-org8bed764" class="outline-4">
<h4 id="org8bed764">Examples</h4>
<div class="outline-text-4" id="text-org8bed764">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(jsonlite)
read_json(&lt;filepath&gt;)
write_json(&lt;object&gt;, &lt;filepath&gt;, pretty = <span style="color: #6434A3;">TRUE</span>)
</pre>
</div>

<p>
There are the <code>toJSON</code> and <code>fromJSON</code> functions but they are not needed most of
the time.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc681e10" class="outline-3">
<h3 id="orgc681e10">Working with HTML</h3>
<div class="outline-text-3" id="text-orgc681e10">
<p>
There is the <code>htmltools</code> package for generating HTML in R.
</p>
</div>

<div id="outline-container-org203a92e" class="outline-4">
<h4 id="org203a92e">Example</h4>
<div class="outline-text-4" id="text-org203a92e">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(htmltools)

my_html <span style="color: #D0372D;">&lt;-</span>
  tags$html(
         tags$head(tags$title(<span style="color: #008000;">"My Title"</span>)),
         tags$body(
                tags$h1(<span style="color: #008000;">"Hello"</span>),
                tags$div(
                       tags$h3(<span style="color: #008000;">"Hello World"</span>),
                       tags$img(src = <span style="color: #008000;">"the-world.png"</span>),
                       tags$p(<span style="color: #008000;">"What a wonderful world!"</span>)
                     )
              )
       )

save_html(
  doRenderTags(my_html),
  file = <span style="color: #008000;">"world.html"</span>
)
</pre>
</div>

<p>
produces the following HTML
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000FF;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #006699;">html</span> <span style="color: #BA36A5;">lang</span>=<span style="color: #008000;">"en"</span>&gt;
&lt;<span style="color: #006699;">head</span>&gt;
&lt;<span style="color: #006699;">meta</span> <span style="color: #BA36A5;">charset</span>=<span style="color: #008000;">"utf-8"</span>/&gt;
&lt;<span style="color: #006699;">style</span>&gt;body{background-color:white;}&lt;/<span style="color: #006699;">style</span>&gt;


&lt;/<span style="color: #006699;">head</span>&gt;
&lt;<span style="color: #006699;">html</span>&gt;
  &lt;<span style="color: #006699;">head</span>&gt;
    &lt;<span style="color: #006699;">title</span>&gt;<span style="color: #000000; font-weight: bold; text-decoration: underline;">My Title</span>&lt;/<span style="color: #006699;">title</span>&gt;
  &lt;/<span style="color: #006699;">head</span>&gt;
  &lt;<span style="color: #006699;">body</span>&gt;
    &lt;<span style="color: #006699;">h1</span>&gt;<span style="color: #000000; font-weight: bold; text-decoration: underline;">Hello</span>&lt;/<span style="color: #006699;">h1</span>&gt;
    &lt;<span style="color: #006699;">div</span>&gt;
      &lt;<span style="color: #006699;">h3</span>&gt;<span style="color: #1A1A1A; font-style: italic; text-decoration: underline;">Hello World</span>&lt;/<span style="color: #006699;">h3</span>&gt;
      &lt;<span style="color: #006699;">img</span> <span style="color: #BA36A5;">src</span>=<span style="color: #008000;">"the-world.png"</span>/&gt;
      &lt;<span style="color: #006699;">p</span>&gt;What a wonderful world!&lt;/<span style="color: #006699;">p</span>&gt;
    &lt;/<span style="color: #006699;">div</span>&gt;
  &lt;/<span style="color: #006699;">body</span>&gt;
&lt;/<span style="color: #006699;">html</span>&gt;
&lt;/<span style="color: #006699;">html</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org1adf4cf" class="outline-4">
<h4 id="org1adf4cf">Example: embedding PNG as string in HTML</h4>
<div class="outline-text-4" id="text-org1adf4cf">
<p>
The following function is useful if you want to avoid referencing external files
in your HTML but still want to include figures.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> An HTML tag encoding an image stored in a PNG.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> This uses the \code{base64enc} and \code{htmltools} packages.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">filepath</span><span style="color: #8D8D84; font-style: italic;"> is the path to the PNG</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">...</span><span style="color: #8D8D84; font-style: italic;"> is additional arguments to \code{tags$img} such as style.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">png_as_img</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(filepath, ...) {
  <span style="color: #0000FF;">if</span> (tools::file_ext(filepath) == <span style="color: #008000;">"png"</span>) {
    b64 <span style="color: #D0372D;">&lt;-</span> base64enc::base64encode(what = filepath)
    tags$img(
           src = paste(<span style="color: #008000;">"data:image/png;base64"</span>, b64, sep = <span style="color: #008000;">","</span>),
           ...
         )
  } <span style="color: #0000FF;">else</span> {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"Filepath given to png_as_img must be a PNG."</span>)
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org449ab0e" class="outline-4">
<h4 id="org449ab0e">Example: including a table representation of a dataframe</h4>
<div class="outline-text-4" id="text-org449ab0e">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> An HTML tag encoding a data frame as a basic table.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> This uses the \code{xtable} package to generate the HTML for the table.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">df</span><span style="color: #8D8D84; font-style: italic;"> data.frame to create an table from</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">...</span><span style="color: #8D8D84; font-style: italic;"> additional parameters for \code{xtable::xtable}.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">df_as_table</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(df, ...) {
  tmp_file <span style="color: #D0372D;">&lt;-</span> tempfile()
  print(xtable::xtable(df, ...),
        type = <span style="color: #008000;">"html"</span>,
        file = tmp_file)
  <span style="color: #0000FF;">return</span>(tags$div(includeHTML(tmp_file)))
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org75af42e" class="outline-3">
<h3 id="org75af42e">OUTDATED: Working with XML with <code>XML</code></h3>
<div class="outline-text-3" id="text-org75af42e">
<p>
<b>NOTE:</b> It looks like <code>xml2</code> might be a better choice for XML work, please see <a href="#orged6fe6c">these notes</a> instead.
</p>
</div>

<div id="outline-container-org7230348" class="outline-4">
<h4 id="org7230348">Example I</h4>
<div class="outline-text-4" id="text-org7230348">
<p>
The following snippet produces a file <code>demo.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(XML)

kappa_node <span style="color: #D0372D;">&lt;-</span> xmlNode(
  <span style="color: #008000;">"kappa"</span>,
  attrs = list(idref = <span style="color: #008000;">"hky.kappa"</span>)
)

input_node <span style="color: #D0372D;">&lt;-</span> xmlNode(
  <span style="color: #008000;">"input"</span>,
  kappa_node,
  attrs = list(spec = <span style="color: #008000;">"HKY"</span>, id = <span style="color: #008000;">"hky"</span>)
)

z <span style="color: #D0372D;">&lt;-</span> xmlNode(
  <span style="color: #008000;">"beast"</span>,
  input_node,
  attrs = list(version = <span style="color: #008000;">"2.0"</span>,
               namespace = <span style="color: #008000;">"beast.core:beast.evolution.operators"</span>)
)

saveXML(
  z,
  file = <span style="color: #008000;">"demo.xml"</span>,
  prefix = <span style="color: #008000;">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;\n"</span>
)
</pre>
</div>

<p>
And here is the result
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #0000FF;">xml</span> <span style="color: #036A07;">version="1.0" encoding="UTF-8" standalone="no"</span>?&gt;
&lt;<span style="color: #AE1B9A;">beast</span> <span style="color: #BA36A5;">version</span>=<span style="color: #008000;">"2.0"</span> <span style="color: #BA36A5;">namespace</span>=<span style="color: #008000;">"beast.core:beast.evolution.operators"</span>&gt;
 &lt;<span style="color: #AE1B9A;">input</span> <span style="color: #BA36A5;">spec</span>=<span style="color: #008000;">"HKY"</span> <span style="color: #BA36A5;">id</span>=<span style="color: #008000;">"hky"</span>&gt;
  &lt;<span style="color: #AE1B9A;">kappa</span> <span style="color: #BA36A5;">idref</span>=<span style="color: #008000;">"hky.kappa"</span>/&gt;
 &lt;/<span style="color: #AE1B9A;">input</span>&gt;
&lt;/<span style="color: #AE1B9A;">beast</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org978f388" class="outline-4">
<h4 id="org978f388">Example II</h4>
<div class="outline-text-4" id="text-org978f388">
<p>
Given an XML file, <code>demo.xml</code>, we can read that into a list-like object:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(XML)

xmlToList(xmlParse(<span style="color: #008000;">"demo.xml"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9fa078" class="outline-4">
<h4 id="orgf9fa078">Example III</h4>
<div class="outline-text-4" id="text-orgf9fa078">
<p>
We can read in the XML, edit one of the nodes by indexing into the object and
replacing it, and then write it back to another file.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(XML)

foo <span style="color: #D0372D;">&lt;-</span> xmlTreeParse(<span style="color: #008000;">"demo.xml"</span>)$doc$children

bappa_node <span style="color: #D0372D;">&lt;-</span> xmlNode(
  <span style="color: #008000;">"bappa"</span>,
  attrs = list(idref = <span style="color: #008000;">"hky.bappa"</span>)
)

foo[[<span style="color: #008000;">"beast"</span>]][[<span style="color: #008000;">"input"</span>]][[<span style="color: #008000;">"kappa"</span>]] <span style="color: #D0372D;">&lt;-</span> bappa_node

saveXML(
  foo$beast, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">&lt;-- need to specify the node.</span>
  file = <span style="color: #008000;">"demo-again.xml"</span>,
  prefix = <span style="color: #008000;">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;\n"</span>
)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf608736" class="outline-4">
<h4 id="orgf608736">Example IV</h4>
<div class="outline-text-4" id="text-orgf608736">
<p>
We can use <a href="https://www.w3schools.com/xml/xpath_syntax.asp">XPath syntax</a> to extract a particular node and then query its
attributes.
</p>

<div class="org-src-container">
<pre class="src src-R">foo <span style="color: #D0372D;">&lt;-</span> xmlTreeParse(<span style="color: #008000;">"demo.xml"</span>)$doc$children$beast
kappa_node <span style="color: #D0372D;">&lt;-</span> getNodeSet(foo, <span style="color: #008000;">"//kappa[@idref='hky.kappa']"</span>)[[1]]
xmlGetAttr(kappa_node, <span style="color: #008000;">"idref"</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbea32ff" class="outline-3">
<h3 id="orgbea32ff">Working with Mustache templates</h3>
<div class="outline-text-3" id="text-orgbea32ff">
</div>
<div id="outline-container-org513f2c6" class="outline-4">
<h4 id="org513f2c6">Example</h4>
<div class="outline-text-4" id="text-org513f2c6">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(whisker)

template <span style="color: #D0372D;">&lt;-</span> readLines(<span style="color: #008000;">"./template.html"</span>)
data <span style="color: #D0372D;">&lt;-</span> list( name = <span style="color: #008000;">"Chris"</span>
            , value = 10000
            , taxed_value = 10000 - (10000 * 0.4)
            , in_ca = <span style="color: #6434A3;">TRUE</span>
            )

writeLines(whisker.render(template, data), <span style="color: #008000;">"./output.html"</span>)
</pre>
</div>

<p>
where <code>template.html</code> might look like the following
</p>

<pre class="example">
Hello {{name}}
You have just won ${{value}}!
{{#in_ca}}
Well, ${{taxed_value}}, after taxes.
{{/in_ca}}
</pre>
</div>
</div>
</div>

<div id="outline-container-testthat-expectations" class="outline-3">
<h3 id="testthat-expectations">Unit testing with <code>testthat</code></h3>
<div class="outline-text-3" id="text-testthat-expectations">
<p>
Here are the functions listed in Table 1 of the <a href="https://vita.had.co.nz/papers/testthat.pdf">testthat paper</a> by
Hadley.
</p>

<div class="org-src-container">
<pre class="src src-R">expect_true(x) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">takes a logical.</span>
expect_false(x)
expect_is(x, y)
expect_equal(x, y) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">has a tolerance argument.</span>
expect_equivalent(x, y)
expect_identical(x, y)
expect_matches(x, y)
expect_output(x, y)
expect_message(x, y)
expect_warning(x, y)
expect_error(x, y) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">y is an regex for a error message.</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5cfe2f" class="outline-3">
<h3 id="orgb5cfe2f">Dependency management with <code>packrat</code></h3>
<div class="outline-text-3" id="text-orgb5cfe2f">
<p>
Packrat is developed by the team at RStudio. It relies on the notion of a
<i>project</i>, which we might think of as a single analysis or collection of related
analyses. A project should live in a single directory.
</p>
</div>

<div id="outline-container-org73f0b7c" class="outline-4">
<h4 id="org73f0b7c">Usage</h4>
<div class="outline-text-4" id="text-org73f0b7c">
<p>
To start a packrat project use
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::init()
</pre>
</div>

<p>
This creates a directory <code>packrat</code> and a <code>.Rprofile</code> file. The profile file is
how R knows to use the private library rather than the shared one. There is a
file <code>packrat/packrat.lock</code> which contains the package details.
</p>

<p>
Packages are installed as usual with <code>install.packages</code>, but now they will be
stored in the private packrat library. Packages are not added to the
<code>packrat.lock</code> file until a <i>snapshot</i> of the current packages is made
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::snapshot()
</pre>
</div>

<p>
If you want a status report from packrat about how the packages there is
<code>packrat::status</code>. To install local packages, packrat needs to be told where
they live
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::set_opts(local.repos = <span style="color: #008000;">"&lt;path/to/package&gt;"</span>)
</pre>
</div>

<p>
When moving a project between machines the installed packages will probably
break. However, the <code>packrat</code> directory stores copies of the source for each of
the packages so they can be <i>restored</i>.
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::restore()
</pre>
</div>
</div>
</div>

<div id="outline-container-org134b2e9" class="outline-4">
<h4 id="org134b2e9">Version control</h4>
<div class="outline-text-4" id="text-org134b2e9">
<p>
The following files should be included into version control:
</p>

<ul class="org-ul">
<li><code>.gitignore</code> can contain <code>packrat/lib</code> and <code>packrat/src</code>.</li>
<li><code>.Rprofile</code></li>
<li><code>packrat/packrat.opts</code></li>
<li><code>packrat/packrat.lock</code></li>
</ul>

<p>
The following explaination of the directory structure is given in the
<a href="https://rstudio.github.io/packrat/walkthrough.html">walkthrough</a>
</p>

<blockquote>
<p>
A packrat project contains a few extra files and directories. The <code>init()</code>
function creates these files for you, if they dont already exist.
</p>

<ul class="org-ul">
<li><code>packrat/packrat.lock</code>: Lists the precise package versions that were used to
satisfy dependencies, including dependencies of dependencies. (This file
should never be edited by hand!)</li>
<li><code>packrat/packrat.opts</code>: Project-specific packrat options. These can be queried
and set with <code>get_opts</code> and <code>set_opts</code>; see <code>?"packrat-options"</code> for more
information.</li>
<li><code>packrat/lib/</code>: Private package library for this project.</li>
<li><code>packrat/src/</code>: Source packages of all the dependencies that packrat has been
made aware of.</li>
<li><code>.Rprofile</code>: Directs R to use the private package library (when it is started
from the project directory).</li>
</ul>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org4eb0f85" class="outline-3">
<h3 id="org4eb0f85">Package and project management with <code>usethis</code></h3>
<div class="outline-text-3" id="text-org4eb0f85">
<ul class="org-ul">
<li>Add dependencies to packages with <code>usethis::use_package</code> instead of
<code>devtools::use_package</code> which is now deprecated. It is the same deal with
<code>use_vignette</code>.</li>
</ul>
</div>
</div>

<div id="outline-container-org2f9c14a" class="outline-3">
<h3 id="org2f9c14a">Date handling with <code>lubridate</code></h3>
<div class="outline-text-3" id="text-org2f9c14a">
<p>
You may think you don't need to use this, but you are probably wrong.
It won't take long before you need something that is painful to do in
base date types, you may as well start out using this. It's part of
the tidyverse, so it's safe.
</p>
</div>

<div id="outline-container-org4aaaef0" class="outline-4">
<h4 id="org4aaaef0">Key data types for <code>lubridate</code></h4>
<div class="outline-text-4" id="text-org4aaaef0">
<ul class="org-ul">
<li>An <i>instant</i> is an exact point in time,</li>
<li>an <i>interval</i> is the length of time between two instants,</li>
<li>a <i>duration</i> is the number of seconds between to instants,</li>
<li>a <i>period</i> is the length of time measured in units bigger than seconds (and hence only has a <span class="underline">relative</span> value).</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org39d005e" class="outline-3">
<h3 id="org39d005e">String handling with <code>stringr</code></h3>
<div class="outline-text-3" id="text-org39d005e">
<p>
Strings are another place where the built-in support is sufficient, but
unpleasant to work with. The <code>stringr</code> package from the tidyverse makes this
much easier and is organised to work well with the modern piping style.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">function</th>
<th scope="col" class="org-left">use</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>str_detect</code></td>
<td class="org-left"><b>match</b> like <code>grepl</code>, returning matches</td>
</tr>

<tr>
<td class="org-left"><code>str_flatten</code></td>
<td class="org-left"><b>flatten</b> like <code>paste</code></td>
</tr>

<tr>
<td class="org-left"><code>str_interp</code></td>
<td class="org-left">string <b>interpolation</b> like <code>sprintf</code></td>
</tr>

<tr>
<td class="org-left"><code>str_replace</code></td>
<td class="org-left"><b>substitution</b> like <code>gsub</code></td>
</tr>

<tr>
<td class="org-left"><code>str_split</code></td>
<td class="org-left"><b>split</b> like <code>strsplit</code></td>
</tr>

<tr>
<td class="org-left"><code>str_subset</code></td>
<td class="org-left"><b>filters</b> strings like <code>grep</code></td>
</tr>

<tr>
<td class="org-left"><code>str_extract</code></td>
<td class="org-left"><b>extracts</b> pattern match</td>
</tr>

<tr>
<td class="org-left"><code>str_to_lower</code></td>
<td class="org-left">converts to lower case</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgedbca21" class="outline-3">
<h3 id="orgedbca21">Documentation with <code>roxygen2</code></h3>
<div class="outline-text-3" id="text-orgedbca21">
<p>
<a href="https://r-pkgs.org/man.html#sec-man-roxygen-comments">R Packages: Function documentation</a>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">style</th>
<th scope="col" class="org-left">markup</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">italics</td>
<td class="org-left"><code>\emph{}</code></td>
</tr>

<tr>
<td class="org-left">bold</td>
<td class="org-left"><code>\strong{}</code></td>
</tr>

<tr>
<td class="org-left">mono-spaced</td>
<td class="org-left"><code>\code{}</code></td>
</tr>
</tbody>
</table>

<p>
Here is an example from <i>R Packages</i>:
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Remove duplicated strings</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> `str_unique()` removes duplicated values, with optional control over</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> how duplication is measured.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">string</span><span style="color: #8D8D84; font-style: italic;"> Input vector. Either a character vector, or something</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">  coercible to one.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">...</span><span style="color: #8D8D84; font-style: italic;"> Other options used to control matching behavior between duplicate</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   strings. Passed on to [stringi::stri_opts_collator()].</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@returns</span><span style="color: #8D8D84; font-style: italic;"> A character vector, usually shorter than `string`.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@seealso</span><span style="color: #8D8D84; font-style: italic;"> [unique()], [stringi::stri_unique()] which this function wraps.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@examples</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> str_unique(c("a", "b", "c", "b", "a"))</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">@export</span>
<span style="color: #006699;">str_unique</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(string, ...) {
  ...
}
</pre>
</div>

<p>
For some mysterious reason, when you document a package and build a
PDF of the manual it will include documentation for functions that you
have not exported. There will be documentation for functions that are
not made available to the user!
</p>

<p>
The solution appears to be to remove the corresponding <code>.Rd</code> files
from <code>man/</code> and then to build the manual from the remaining files. If
you do not want to do this manually, the following script might help.
<b>WARNING:</b> this assumes that you are only putting one function per
file.
</p>

<div class="org-src-container">
<pre class="src src-R">my_namespace <span style="color: #D0372D;">&lt;-</span> readLines(<span style="color: #008000;">"NAMESPACE"</span>)
my_exported <span style="color: #D0372D;">&lt;-</span> gsub(
  <span style="color: #008000;">"export\\((.*)\\)"</span>,
  <span style="color: #008000;">"\\1"</span>,
  grep(<span style="color: #008000;">"export"</span>, my_namespace, value = <span style="color: #6434A3;">TRUE</span>)
)

all_my_rd_files <span style="color: #D0372D;">&lt;-</span>
  list.files(<span style="color: #008000;">"man"</span>, pattern = <span style="color: #008000;">"\\.Rd$"</span>, full.names = <span style="color: #6434A3;">TRUE</span>)

not_exported_mask <span style="color: #D0372D;">&lt;-</span>
  !gsub(<span style="color: #008000;">"man/(.*)\\.Rd"</span>, <span style="color: #008000;">"\\1"</span>, all_my_rd_files) <span style="color: #D0372D;">%in%</span> my_exported
file.remove(all_my_rd_files[not_exported_mask])
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8d448e" class="outline-3">
<h3 id="orga8d448e">Dates and times</h3>
<div class="outline-text-3" id="text-orga8d448e">
<p>
<code>as.Date</code> is your friend.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Code</th>
<th scope="col" class="org-left">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>%d</code></td>
<td class="org-left">Day (integer)</td>
</tr>

<tr>
<td class="org-left"><code>%m</code></td>
<td class="org-left">Month (integer)</td>
</tr>

<tr>
<td class="org-left"><code>%b</code></td>
<td class="org-left">Abbreviated month (string)</td>
</tr>

<tr>
<td class="org-left"><code>%B</code></td>
<td class="org-left">Month (string)</td>
</tr>

<tr>
<td class="org-left"><code>%y</code></td>
<td class="org-left">Year (2 digits)</td>
</tr>

<tr>
<td class="org-left"><code>%Y</code></td>
<td class="org-left">Year (4 digits)</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org7121ea9" class="outline-3">
<h3 id="org7121ea9"><code>Rmath.h</code></h3>
<div class="outline-text-3" id="text-org7121ea9">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #8D8D84;">/*</span>

<span style="color: #8D8D84; font-style: italic;">  To compile and run this I used the following...</span>


<span style="color: #8D8D84; font-style: italic;">  $ sudo apt update</span>
<span style="color: #8D8D84; font-style: italic;">  $ sudo apt install r-mathlib</span>
<span style="color: #8D8D84; font-style: italic;">  $ sudo apt install r-base-dev</span>
<span style="color: #8D8D84; font-style: italic;">  $ gcc -o mathlibtest demo.c -lRmath -lm</span>
<span style="color: #8D8D84; font-style: italic;">  $ ./mathlibtest</span>

<span style="color: #8D8D84;"> */</span>

<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;stdio.h&gt;</span>

<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">MATHLIB_STANDALONE</span> 1
<span style="color: #808080;">#include</span> <span style="color: #008000;">"Rmath.h"</span>


<span style="color: #6434A3;">int</span> <span style="color: #006699;">fib</span>(<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">n</span>) {
  <span style="color: #0000FF;">if</span> (n &lt; 2) {
    <span style="color: #0000FF;">return</span>(1);
  } <span style="color: #0000FF;">else</span> {
    <span style="color: #0000FF;">return</span>(fib(n-1) + fib(n-2));
  }
}

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span>(<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">ac</span>, <span style="color: #6434A3;">char</span>** <span style="color: #BA36A5;">av</span>)
{
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">n</span>;
  <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">foo</span>;

  <span style="color: #0000FF;">for</span> ( n = 0; n &lt; 10; n = n + 1 ) {
    printf(<span style="color: #008000;">"%d\n"</span>, fib(n));
    foo = dnorm(1.0, 0.0, 1.0, 0);
    printf(<span style="color: #008000;">"%f\n"</span>, foo);
  }

  printf(<span style="color: #008000;">"hello, %s\n"</span>, <span style="color: #008000;">"world"</span>);
  <span style="color: #0000FF;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org64d7078" class="outline-3">
<h3 id="org64d7078">Cheat sheets</h3>
<div class="outline-text-3" id="text-org64d7078">
<ul class="org-ul">
<li><a href="../resources/r-cheatsheet-regex.pdf">Regex cheatsheet for <code>stringr</code></a></li>
<li><a href="https://stuff.mit.edu/afs/athena/software/r/current/RStudio/resources/roxygen_help.html">roxygen(2)</a></li>
<li><a href="https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf">rmarkdown</a></li>
<li><a href="https://evoldyn.gitlab.io/evomics-2018/ref-sheets/R_purrr.pdf">purrr</a></li>
<li><a href="../resources/ess-cheat-sheet.pdf">ESS</a></li>
</ul>
</div>
</div>

<div id="outline-container-org38ab189" class="outline-3">
<h3 id="org38ab189">Data structures</h3>
<div class="outline-text-3" id="text-org38ab189">
</div>
<div id="outline-container-orgf216603" class="outline-4">
<h4 id="orgf216603">Hashmap</h4>
<div class="outline-text-4" id="text-orgf216603">
<p>
The environment builtin data structure can be used as a hashmap (since it hashes
by default), a.k.a. map, dictionary, loopkup&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-R">my_dict <span style="color: #D0372D;">&lt;-</span> new.env(hash = <span style="color: #6434A3;">TRUE</span>)
my_dict[[<span style="color: #008000;">"key"</span>]] <span style="color: #D0372D;">&lt;-</span> 2
my_dict[[<span style="color: #008000;">"key"</span>]] <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">will return 2.</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orge0ccf69" class="outline-2">
<h2 id="orge0ccf69">Programming in R (language and evaluation)</h2>
<div class="outline-text-2" id="text-orge0ccf69">
</div>
<div id="outline-container-orgcc73556" class="outline-3">
<h3 id="orgcc73556">Recommended reading</h3>
<div class="outline-text-3" id="text-orgcc73556">
<ul class="org-ul">
<li><a href="https://www.r-bloggers.com/2019/07/bang-bang-how-to-program-with-dplyr/">Bang Bang - How to program with dplyr</a> (explains quotation stuff for dyplr)</li>
<li><a href="https://www.r-bloggers.com/2019/06/curly-curly-the-successor-of-bang-bang-2/">Curly-Curly, the successor of Bang-Bang</a> (new rlang syntax for extending dplyr)</li>
<li><a href="https://github.com/jimhester/lookup">lookup</a> is an R package from Jim Hester which simplifies the process of reading source code (even for compiled functions).</li>
</ul>
</div>
</div>

<div id="outline-container-orgedb3a72" class="outline-3">
<h3 id="orgedb3a72">Memory usage</h3>
<div class="outline-text-3" id="text-orgedb3a72">
<p>
To get the size of an object <code>x</code> in terms of its memory usage, run the
following command:
</p>

<div class="org-src-container">
<pre class="src src-R">print(format(object.size(x), units = <span style="color: #008000;">"auto"</span>))
</pre>
</div>

<p>
You can get a print out of the current memory usage (and trigger a
garbage collection) with the <code>gc</code> function. This can be helpful to
call immediately after calling <code>rm</code> on large objects that are no
longer needed.
</p>
</div>
</div>

<div id="outline-container-org8850e36" class="outline-3">
<h3 id="org8850e36">Benchmarking and optimising impementations</h3>
<div class="outline-text-3" id="text-org8850e36">
<p>
This script demonstrates how to use the microbenchmark package in R to
compare the performance of different implementations of the Fibonacci
sequence. There are three different implementations of a function:
<code>fib_recursive</code>, <code>fib_iterative</code>, and <code>fib_memoised</code>.
</p>

<p>
The script runs two sets of benchmarks:
</p>

<ul class="org-ul">
<li><code>mb_small</code>: It runs each function 100 times on the input value
of 20.</li>
<li><code>mb_large</code>: Measures the performance of the iterative and memoized
versions when computing the 150th Fibonacci number. The recursive
version is not included because it would take an impractical amount
of time to compute.</li>
</ul>

<p>
This demonstrates that the memoized version is faster than the
iterative (<sub>when</sub> evaluated multiple times_).
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(microbenchmark)

fib_true <span style="color: #D0372D;">&lt;-</span> c(1,1,2,3,5,8,13)

<span style="color: #006699;">fib_recursive</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(n) {
  <span style="color: #0000FF;">if</span> (n &lt;= 2) {
    <span style="color: #0000FF;">return</span>(1)
  } <span style="color: #0000FF;">else</span> {
    <span style="color: #0000FF;">return</span>(fib_recursive(n - 1) + fib_recursive(n - 2))
  }
}

<span style="color: #006699;">fib_iterative</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(n) {
  <span style="color: #0000FF;">if</span> (n &lt;= 2) {
    <span style="color: #0000FF;">return</span>(1)
  }
  fib_values <span style="color: #D0372D;">&lt;-</span> numeric(n)
  fib_values[1:2] <span style="color: #D0372D;">&lt;-</span> 1
  <span style="color: #0000FF;">for</span> (i <span style="color: #0000FF;">in</span> 3:n) {
    fib_values[i] <span style="color: #D0372D;">&lt;-</span> fib_values[i - 1] + fib_values[i - 2]
  }
  <span style="color: #0000FF;">return</span>(fib_values[n])
}


<span style="color: #006699;">memoise</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(f) {
  memo <span style="color: #D0372D;">&lt;-</span> new.env(parent = emptyenv())
  <span style="color: #0000FF;">function</span>(n) {
    <span style="color: #0000FF;">if</span> (!exists(as.character(n), where = memo, inherits = <span style="color: #6434A3;">FALSE</span>)) {
      memo[[as.character(n)]] <span style="color: #D0372D;">&lt;-</span> f(n)
    }
    memo[[as.character(n)]]
  }
}

fib_memoised <span style="color: #D0372D;">&lt;-</span> memoise(<span style="color: #0000FF;">function</span>(n) {
  <span style="color: #0000FF;">if</span> (n &lt;= 2) {
    <span style="color: #0000FF;">return</span>(1)
  } <span style="color: #0000FF;">else</span> {
    <span style="color: #0000FF;">return</span>(fib_memoised(n - 1) + fib_memoised(n - 2))
  }
})

stopifnot(all(sapply(X = 1:7, FUN = fib_recursive) == fib_true))
stopifnot(all(sapply(X = 1:7, FUN = fib_iterative) == fib_true))
stopifnot(all(sapply(X = 1:7, FUN = fib_memoised) == fib_true))

mb_small <span style="color: #D0372D;">&lt;-</span> microbenchmark(
  fib_recursive(20),
  fib_iterative(20),
  fib_memoised(20),
  times = 100L
)
print(mb_small)

mb_large <span style="color: #D0372D;">&lt;-</span> microbenchmark(
  fib_iterative(150),
  fib_memoised(150),
  times = 1000L
)
print(mb_large)
</pre>
</div>
</div>
</div>

<div id="outline-container-org159d694" class="outline-3">
<h3 id="org159d694">Functional programming support</h3>
<div class="outline-text-3" id="text-org159d694">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(magrittr)
<span style="color: #D0372D;">library</span>(purrr)
</pre>
</div>

<p>
Here is a mapping between common functions in Haskell and their approximate
analogue in R. These are mainly for use with lists of vectors.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Haskell</th>
<th scope="col" class="org-left">R (package)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>all</code></td>
<td class="org-left"><code>all</code></td>
</tr>

<tr>
<td class="org-left"><code>filter</code></td>
<td class="org-left"><code>keep</code> and <code>discard</code> (<code>purrr</code>)</td>
</tr>

<tr>
<td class="org-left"><code>map</code></td>
<td class="org-left"><code>map</code> (<code>purrr</code>)</td>
</tr>

<tr>
<td class="org-left"><code>scanl</code></td>
<td class="org-left"><code>accumulate</code> (<code>purrr</code>)</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-orgf27c497" class="outline-4">
<h4 id="orgf27c497"><span class="todo TODO">TODO</span> Built-in functionality</h4>
<div class="outline-text-4" id="text-orgf27c497">
<ul class="org-ul">
<li><code>|&gt;</code> pipes with <code>_</code> for named arguments.</li>
<li><code>\(x) x + 1</code> becomes <code>function(x) x+1</code> (but you need to wrap the
function in <code>()</code> when using it in a pipeline).</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org1b9cf9c" class="outline-3">
<h3 id="org1b9cf9c">R/Haskell Prelude</h3>
<div class="outline-text-3" id="text-org1b9cf9c">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">See https://hackage.haskell.org/package/base-4.15.0.0/docs/Prelude.html#v:dropWhile</span>
<span style="color: #006699;">drop_while</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(p, xs) {
  <span style="color: #0000FF;">if</span> (length(xs) == 0) {
    xs
  } <span style="color: #0000FF;">else</span> {
    x <span style="color: #D0372D;">&lt;-</span> head(xs, 1)
    remaining <span style="color: #D0372D;">&lt;-</span> tail(xs, -1)
    <span style="color: #0000FF;">if</span> (p(x)) {
      drop_while(p, remaining)
    } <span style="color: #0000FF;">else</span> {
      remaining
    }
  }
}

<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">See https://hackage.haskell.org/package/base-4.15.0.0/docs/Prelude.html#v:takeWhile</span>
<span style="color: #006699;">take_while</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(p, xs) {
  <span style="color: #0000FF;">if</span> (length(xs) == 0) {
    xs
  } <span style="color: #0000FF;">else</span> {
    x <span style="color: #D0372D;">&lt;-</span> head(xs, 1)
    remaining <span style="color: #D0372D;">&lt;-</span> tail(xs, -1)
    <span style="color: #0000FF;">if</span> (p(x)) {
      c(x, take_while(p, remaining))
    } <span style="color: #0000FF;">else</span> {
      c()
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e5eccd" class="outline-3">
<h3 id="org6e5eccd">Program flow and control</h3>
<div class="outline-text-3" id="text-org6e5eccd">
</div>
<div id="outline-container-org2691c41" class="outline-4">
<h4 id="org2691c41">Ternary operator</h4>
<div class="outline-text-4" id="text-org2691c41">
<div class="org-src-container">
<pre class="src src-R">ifelse(test, yes, no)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d62f03" class="outline-4">
<h4 id="org9d62f03">Switch/case/which</h4>
<div class="outline-text-4" id="text-org9d62f03">
<p>
This is similar to the <code>match</code> statement in <a href="./python-notes.html">Python</a>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #006699;">centre</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(x, type) {
  <span style="color: #0000FF;">switch</span>(type,
         mean = mean(x),
         median = median(x),
         trimmed = mean(x, trim = .1))
}

centre(rnorm(100), <span style="color: #008000;">"mean"</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc9d071c" class="outline-3">
<h3 id="orgc9d071c">Numbers</h3>
<div class="outline-text-3" id="text-orgc9d071c">
<ul class="org-ul">
<li><code>options(digits = 20)</code> will cause the REPL to start printing 20 digits of the
number.</li>
<li><code>ceiling</code> <code>floor</code> and <code>round</code> behave as expected.</li>
<li><code>signif</code> (significant figures) and <code>round</code> have a <code>digits</code> argument which can
be used to specify the number of digits to use.</li>
</ul>
</div>
</div>

<div id="outline-container-orgc6f743a" class="outline-3">
<h3 id="orgc6f743a">Metaprogramming and nonstandard evaluation</h3>
<div class="outline-text-3" id="text-orgc6f743a">
<p>
The following snippet demonstrates how to get the value of a variable given a string containing its symbol.
There is a synonym <code>as.name</code> which derives from S terminology while "symbol" is LISP lingo.
</p>

<div class="org-src-container">
<pre class="src src-R">a <span style="color: #D0372D;">&lt;-</span> 1
eval(as.symbol(<span style="color: #008000;">"a"</span>))
</pre>
</div>

<p>
This doesn't seem to work unless you have string literals.
Instead we can do the following
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">this has a syntax error</span>
data.frame(letters[1] = 2)

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">this works!</span>
eval(parse(text = sprintf(<span style="color: #008000;">"data.frame(%s = 2)"</span>, letters[1])))
</pre>
</div>
</div>

<div id="outline-container-org9aeb0f2" class="outline-4">
<h4 id="org9aeb0f2">Local aliases</h4>
<div class="outline-text-4" id="text-org9aeb0f2">
<p>
The <code>with</code> function provides a way to define local variables based on a data frame
or list, etc.
</p>

<div class="org-src-container">
<pre class="src src-R">with(mtcars, mpg[cyl == 8  &amp;  disp &gt; 350])
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">is the same as, but nicer than</span>
mtcars$mpg[mtcars$cyl == 8  &amp;  mtcars$disp &gt; 350]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org055bd50" class="outline-3">
<h3 id="org055bd50">Object-oriented programming</h3>
<div class="outline-text-3" id="text-org055bd50">
</div>
<div id="outline-container-org9b616cc" class="outline-4">
<h4 id="org9b616cc">S3</h4>
<div class="outline-text-4" id="text-org9b616cc">
<ul class="org-ul">
<li>You can use the <code>methods</code> function which takes the name of a class as an argument to find a list of the methods available for that class.</li>
</ul>
</div>
</div>

<div id="outline-container-org60fe830" class="outline-4">
<h4 id="org60fe830">R6 system</h4>
<div class="outline-text-4" id="text-org60fe830">
<ul class="org-ul">
<li>R6 classes are a popular way to bring traditional OOP to R, they have reference semantics.</li>
<li>R6 is available on CRAN</li>
<li>The <code>R6Class</code> function is used to declare classes, the (public) <code>initialize</code> function is used to create instances of this class with <code>$new</code>.</li>
<li><code>self</code> is available within the class to describe the current object.</li>
<li>Assignment of fields is done with <code>&lt;-</code> e.g., <code>self$foo &lt;- "bar"</code></li>
<li>Returning <code>self</code> invisibly (<code>invisible(self)</code>) makes methods <i>chainable</i>.</li>
<li>Active bindings are a way to carry out side effects when assigning values which has a syntax which looks like you are just assigning to a field.</li>
<li>Fields containing reference objects should be set in the <code>initialize</code> method unless you want the object to be shared across all instances of the class.</li>
<li>By default, objects get a <code>clone</code> method, which is shallow; deep cloning can be achieved by passing <code>deep=TRUE</code>.</li>
<li>There was a <a href="https://github.com/r-lib/R6/issues/82#issue-133982435">request for interfaces in R6</a>, however Hadley suggested that this departed from the very minimalist goals of R6 so it will not be implemented.</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org9b28efd" class="outline-2">
<h2 id="org9b28efd">Data munging</h2>
<div class="outline-text-2" id="text-org9b28efd">
</div>
<div id="outline-container-orgb4672cf" class="outline-3">
<h3 id="orgb4672cf">IO with R Data Serialisation (RDS)</h3>
<div class="outline-text-3" id="text-orgb4672cf">
<p>
<a href="http://www.sthda.com/english/wiki/saving-data-into-r-data-format-rds-and-rdata">RDS</a> provides a simple (and very quick) way to save R objects to disk.
This is a binary format and is computationally efficient, but is
incompatible with other languages and not human readable, so there is
a real trade-off there. It is <i>very</i> easy to use.
</p>

<div class="org-src-container">
<pre class="src src-R">obj <span style="color: #D0372D;">&lt;-</span> list(foo = <span style="color: #008000;">"bar"</span>)

saveRDS(obj, <span style="color: #008000;">"demo.rds"</span>)
new_obj <span style="color: #D0372D;">&lt;-</span> readRDS(<span style="color: #008000;">"demo.rds"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orged6fe6c" class="outline-3">
<h3 id="orged6fe6c">Working with XML</h3>
<div class="outline-text-3" id="text-orged6fe6c">
<p>
The modern way for working with XML is via the <code>xml2</code> package.
</p>

<ul class="org-ul">
<li><code>read_xml</code> and <code>write_xml</code> for IO or start a new node from text.</li>
<li><code>xml_text</code> (and <code>xml_set_text</code>) to get the text out of a node (and to modify it).</li>
<li><code>xml_set_attr</code> to set attributes on a node. Note that if you want to set
multiple attributes in a single command there is the function <code>xml_set_attrs</code>
which takes a node and a named vector.</li>
<li><code>xml_add_child</code> to add a child node to a parent.</li>
</ul>
</div>

<div id="outline-container-org8e3faf1" class="outline-4">
<h4 id="org8e3faf1">Example I: creating a node and adding it to existing XML</h4>
<div class="outline-text-4" id="text-org8e3faf1">
<p>
Start with the following XML in <code>demo.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #0000FF;">xml</span> <span style="color: #036A07;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #AE1B9A;">bookstore</span>&gt;
    &lt;<span style="color: #AE1B9A;">book</span>&gt;
        &lt;<span style="color: #AE1B9A;">title</span> <span style="color: #BA36A5;">lang</span>=<span style="color: #008000;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #AE1B9A;">title</span>&gt;
        &lt;<span style="color: #AE1B9A;">author</span>&gt;J K. Rowling&lt;/<span style="color: #AE1B9A;">author</span>&gt;
        &lt;<span style="color: #AE1B9A;">year</span>&gt;2005&lt;/<span style="color: #AE1B9A;">year</span>&gt;
        &lt;<span style="color: #AE1B9A;">price</span>&gt;29.99&lt;/<span style="color: #AE1B9A;">price</span>&gt;
    &lt;/<span style="color: #AE1B9A;">book</span>&gt;
&lt;/<span style="color: #AE1B9A;">bookstore</span>&gt;
</pre>
</div>

<p>
then run the following script
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(xml2)

bs <span style="color: #D0372D;">&lt;-</span> read_xml(<span style="color: #008000;">"demo.xml"</span>)

new_book <span style="color: #D0372D;">&lt;-</span> read_xml(<span style="color: #008000;">"&lt;book&gt;&lt;title/&gt;&lt;author/&gt;&lt;year/&gt;&lt;price/&gt;&lt;/book&gt;"</span>)

xml_set_attr(
  x = xml_find_first(new_book, <span style="color: #008000;">"//title"</span>),
  attr = <span style="color: #008000;">"lang"</span>,
  value = <span style="color: #008000;">"en"</span>)
xml_set_text(
  x = xml_find_first(new_book, <span style="color: #008000;">"//title"</span>),
  value = <span style="color: #008000;">"Nineteen Eighty-Four"</span>
)
xml_set_text(
  x = xml_find_first(new_book, <span style="color: #008000;">"//author"</span>),
  value = <span style="color: #008000;">"G Orwell"</span>
)
xml_set_text(
  x = xml_find_first(new_book, <span style="color: #008000;">"//year"</span>),
  value = <span style="color: #008000;">"1949"</span>
)
xml_set_text(
  x = xml_find_first(new_book, <span style="color: #008000;">"//price"</span>),
  value = <span style="color: #008000;">"8.99"</span>
)

xml_add_child(bs, new_book)
write_xml(bs, <span style="color: #008000;">"demo2.xml"</span>)
</pre>
</div>

<p>
to get the new file <code>demo2.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #0000FF;">xml</span> <span style="color: #036A07;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #AE1B9A;">bookstore</span>&gt;
  &lt;<span style="color: #AE1B9A;">book</span>&gt;
    &lt;<span style="color: #AE1B9A;">title</span> <span style="color: #BA36A5;">lang</span>=<span style="color: #008000;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #AE1B9A;">title</span>&gt;
    &lt;<span style="color: #AE1B9A;">author</span>&gt;J K. Rowling&lt;/<span style="color: #AE1B9A;">author</span>&gt;
    &lt;<span style="color: #AE1B9A;">year</span>&gt;2005&lt;/<span style="color: #AE1B9A;">year</span>&gt;
    &lt;<span style="color: #AE1B9A;">price</span>&gt;29.99&lt;/<span style="color: #AE1B9A;">price</span>&gt;
  &lt;/<span style="color: #AE1B9A;">book</span>&gt;
  &lt;<span style="color: #AE1B9A;">book</span>&gt;
    &lt;<span style="color: #AE1B9A;">title</span> <span style="color: #BA36A5;">lang</span>=<span style="color: #008000;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #AE1B9A;">title</span>&gt;
    &lt;<span style="color: #AE1B9A;">author</span>&gt;G Orwell&lt;/<span style="color: #AE1B9A;">author</span>&gt;
    &lt;<span style="color: #AE1B9A;">year</span>&gt;1949&lt;/<span style="color: #AE1B9A;">year</span>&gt;
    &lt;<span style="color: #AE1B9A;">price</span>&gt;8.99&lt;/<span style="color: #AE1B9A;">price</span>&gt;
  &lt;/<span style="color: #AE1B9A;">book</span>&gt;
&lt;/<span style="color: #AE1B9A;">bookstore</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c88f9e" class="outline-4">
<h4 id="org7c88f9e">Example II: swapping a node for a new one in existing XML</h4>
<div class="outline-text-4" id="text-org7c88f9e">
<p>
Starting with <code>demo2.xml</code> from the <a href="#org8e3faf1">previous example</a>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #0000FF;">xml</span> <span style="color: #036A07;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #AE1B9A;">bookstore</span>&gt;
  &lt;<span style="color: #AE1B9A;">book</span>&gt;
    &lt;<span style="color: #AE1B9A;">title</span> <span style="color: #BA36A5;">lang</span>=<span style="color: #008000;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #AE1B9A;">title</span>&gt;
    &lt;<span style="color: #AE1B9A;">author</span>&gt;J K. Rowling&lt;/<span style="color: #AE1B9A;">author</span>&gt;
    &lt;<span style="color: #AE1B9A;">year</span>&gt;2005&lt;/<span style="color: #AE1B9A;">year</span>&gt;
    &lt;<span style="color: #AE1B9A;">price</span>&gt;29.99&lt;/<span style="color: #AE1B9A;">price</span>&gt;
  &lt;/<span style="color: #AE1B9A;">book</span>&gt;
  &lt;<span style="color: #AE1B9A;">book</span>&gt;
    &lt;<span style="color: #AE1B9A;">title</span> <span style="color: #BA36A5;">lang</span>=<span style="color: #008000;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #AE1B9A;">title</span>&gt;
    &lt;<span style="color: #AE1B9A;">author</span>&gt;G Orwell&lt;/<span style="color: #AE1B9A;">author</span>&gt;
    &lt;<span style="color: #AE1B9A;">year</span>&gt;1949&lt;/<span style="color: #AE1B9A;">year</span>&gt;
    &lt;<span style="color: #AE1B9A;">price</span>&gt;8.99&lt;/<span style="color: #AE1B9A;">price</span>&gt;
  &lt;/<span style="color: #AE1B9A;">book</span>&gt;
&lt;/<span style="color: #AE1B9A;">bookstore</span>&gt;
</pre>
</div>

<p>
we can use the script
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(xml2)

bs <span style="color: #D0372D;">&lt;-</span> read_xml(<span style="color: #008000;">"demo2.xml"</span>)

new_cd <span style="color: #D0372D;">&lt;-</span> read_xml(<span style="color: #008000;">"&lt;cd&gt;&lt;title/&gt;&lt;artist/&gt;&lt;year/&gt;&lt;/cd&gt;"</span>)

xml_set_text(
  x = xml_find_first(new_cd, <span style="color: #008000;">"//title"</span>),
  value = <span style="color: #008000;">"Lateralus"</span>
)
xml_set_text(
  x = xml_find_first(new_cd, <span style="color: #008000;">"//artist"</span>),
  value = <span style="color: #008000;">"Tool"</span>
)
xml_set_text(
  x = xml_find_first(new_cd, <span style="color: #008000;">"//year"</span>),
  value = <span style="color: #008000;">"2001"</span>
)

old_book <span style="color: #D0372D;">&lt;-</span> xml_find_first(bs, <span style="color: #008000;">"//book[title='Harry Potter']"</span>)
xml_replace(old_book, new_cd)
write_xml(bs, <span style="color: #008000;">"demo3.xml"</span>)
</pre>
</div>

<p>
which produces <code>demo3.xml</code> shown below
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #0000FF;">xml</span> <span style="color: #036A07;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #AE1B9A;">bookstore</span>&gt;
  &lt;<span style="color: #AE1B9A;">cd</span>&gt;
    &lt;<span style="color: #AE1B9A;">title</span>&gt;Lateralus&lt;/<span style="color: #AE1B9A;">title</span>&gt;
    &lt;<span style="color: #AE1B9A;">artist</span>&gt;Tool&lt;/<span style="color: #AE1B9A;">artist</span>&gt;
    &lt;<span style="color: #AE1B9A;">year</span>&gt;2001&lt;/<span style="color: #AE1B9A;">year</span>&gt;
  &lt;/<span style="color: #AE1B9A;">cd</span>&gt;
  &lt;<span style="color: #AE1B9A;">book</span>&gt;
    &lt;<span style="color: #AE1B9A;">title</span> <span style="color: #BA36A5;">lang</span>=<span style="color: #008000;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #AE1B9A;">title</span>&gt;
    &lt;<span style="color: #AE1B9A;">author</span>&gt;G Orwell&lt;/<span style="color: #AE1B9A;">author</span>&gt;
    &lt;<span style="color: #AE1B9A;">year</span>&gt;1949&lt;/<span style="color: #AE1B9A;">year</span>&gt;
    &lt;<span style="color: #AE1B9A;">price</span>&gt;8.99&lt;/<span style="color: #AE1B9A;">price</span>&gt;
  &lt;/<span style="color: #AE1B9A;">book</span>&gt;
&lt;/<span style="color: #AE1B9A;">bookstore</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5f9cb73" class="outline-4">
<h4 id="org5f9cb73">Example III: A helpful function for getting and setting attributes</h4>
<div class="outline-text-4" id="text-org5f9cb73">
<p>
The functions in this snippet allows you to look up a node with XPath syntax and
then read one of the attributes or set its value. There is an optional argument
in the former to get the value returned as a numeric.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Find the first matching node and return the named attribute</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">x</span><span style="color: #8D8D84; font-style: italic;"> the XML document</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">xp</span><span style="color: #8D8D84; font-style: italic;"> the xpath</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">the</span><span style="color: #8D8D84; font-style: italic;"> attribute</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">as_numeric</span><span style="color: #8D8D84; font-style: italic;"> boolean for casting to numeric (default is FALSE)</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">xml_find_attr</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(x, xp, attr, as_numeric=<span style="color: #6434A3;">FALSE</span>) {
  a <span style="color: #D0372D;">&lt;-</span> xml_attr(xml_find_first(x, xpath = xp), attr)
  <span style="color: #0000FF;">if</span> (!as_numeric) {
    a
  } <span style="color: #0000FF;">else</span> {
    as.numeric(a)
  }
}

<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Find the first matching node and set the named attribute</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">x</span><span style="color: #8D8D84; font-style: italic;"> the XML document</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">xp</span><span style="color: #8D8D84; font-style: italic;"> the xpath</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">attr</span><span style="color: #8D8D84; font-style: italic;"> the attribute</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">v</span><span style="color: #8D8D84; font-style: italic;"> the value for the attribute</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">xml_find_set_attr</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(x, xp, attr, v) {
  n <span style="color: #D0372D;">&lt;-</span> xml_find_first(x, xpath = xp)
  xml_set_attr(n, attr, v)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org90423d0" class="outline-4">
<h4 id="org90423d0">Example IV: linting/formatting/beautifying XML</h4>
<div class="outline-text-4" id="text-org90423d0">
<p>
If you have the <code>js-beautify</code> node package installed, the following function will
lint a file in place.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Format an XML file in place using js-beautify</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">x</span><span style="color: #8D8D84; font-style: italic;"> is the filepath</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">beautify_xml</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(x) {
  system2(command = <span style="color: #008000;">"html-beautify"</span>, args = c(<span style="color: #008000;">"-f"</span>, x, <span style="color: #008000;">"-r"</span>))
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org47a3ab5" class="outline-3">
<h3 id="org47a3ab5">Joins</h3>
<div class="outline-text-3" id="text-org47a3ab5">
<p>
There are several ways to join data frames using <code>dplyr</code>, the folling snippet
demonstrates a full join which duplicates records where necessary and will fill
in missing values. Although the data in the joined data frame does not depend on
the order of the arguments, the ordering of the rows does.
</p>

<div class="org-src-container">
<pre class="src src-R">foo <span style="color: #D0372D;">&lt;-</span> data.frame(x = 1:3, y = letters[1:3])
bar <span style="color: #D0372D;">&lt;-</span> data.frame(x = c(2:4,2:4), z = LETTERS[1:6])
dplyr::full_join(foo,bar)
</pre>
</div>

<pre class="example">
Joining, by = "x"
  x    y    z
1 1    a &lt;NA&gt;
2 2    b    A
3 2    b    D
4 3    c    B
5 3    c    E
6 4 &lt;NA&gt;    C
7 4 &lt;NA&gt;    F
</pre>
</div>
</div>

<div id="outline-container-org44dc284" class="outline-3">
<h3 id="org44dc284">Aggregation</h3>
<div class="outline-text-3" id="text-org44dc284">
<div class="org-src-container">
<pre class="src src-R">aggregate(formula = Petal.Length ~ Species, FUN = mean, data = iris)
</pre>
</div>

<p>
is equivalent to
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(dplyr)
iris <span style="color: #D0372D;">%&gt;%</span>
  group_by(Species) <span style="color: #D0372D;">%&gt;%</span>
  summarise(mean_petal_length = mean(Petal.Length))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec7e7c2" class="outline-3">
<h3 id="orgec7e7c2">Selecting columns</h3>
<div class="outline-text-3" id="text-orgec7e7c2">
<p>
See <code>starts_with</code> and <code>ends_with</code>, and <code>matches</code> which takes strings
to describe columns.
</p>
</div>
</div>

<div id="outline-container-org0f64bbe" class="outline-3">
<h3 id="org0f64bbe">Sorting rows</h3>
<div class="outline-text-3" id="text-org0f64bbe">
</div>
<div id="outline-container-orgc686a76" class="outline-4">
<h4 id="orgc686a76">Base R approach</h4>
<div class="outline-text-4" id="text-orgc686a76">
<div class="org-src-container">
<pre class="src src-R">iris[order(iris$Sepal.Length),]
</pre>
</div>
</div>
</div>

<div id="outline-container-org4dd8910" class="outline-4">
<h4 id="org4dd8910">Tidyverse approach</h4>
<div class="outline-text-4" id="text-org4dd8910">
<p>
You can use the following command to generate a figure that shows the
rows of <code>iris</code> are certainly not sorted by the length, although they
are sorted by species.
</p>

<div class="org-src-container">
<pre class="src src-R">plot(iris$Sepal.Length, col = iris$Species)
</pre>
</div>

<p>
The <code>dplyr::arrange</code> function will sort the rows of a data frame based
on a selected column, respecting groupings if the data are grouped.
The following demonstrates how this works.
</p>

<div class="org-src-container">
<pre class="src src-R">tmp1 <span style="color: #D0372D;">&lt;-</span> iris |&gt;
  dplyr::group_by(Species) |&gt;
  dplyr::arrange(Sepal.Length, .by_group = <span style="color: #6434A3;">TRUE</span>) |&gt;
  as.data.frame()

plot(tmp1$Sepal.Length, col = tmp1$Species)
</pre>
</div>

<p>
Note that if you forget to group in this way it will just sort all of
the rows!
</p>

<div class="org-src-container">
<pre class="src src-R">tmp2 <span style="color: #D0372D;">&lt;-</span> iris |&gt;
  dplyr::arrange(Sepal.Length) |&gt;
  as.data.frame()

plot(tmp2$Sepal.Length, col = tmp2$Species)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf1f1809" class="outline-3">
<h3 id="orgf1f1809">Renaming columns</h3>
<div class="outline-text-3" id="text-orgf1f1809">
<p>
If you want to programmatically rename the columns of a data frame the
<code>dplyr::rename_with</code> function takes a function <code>.fn</code> from strings to
strings defining a renaming rule. The columns that this get applied to
are <i>selected</i> with the argument to the <code>.cols</code> argument.
</p>
</div>
</div>
</div>

<div id="outline-container-org8dfbfa7" class="outline-2">
<h2 id="org8dfbfa7">Statistics with R</h2>
<div class="outline-text-2" id="text-org8dfbfa7">
</div>
<div id="outline-container-org403cebc" class="outline-3">
<h3 id="org403cebc">GLM</h3>
<div class="outline-text-3" id="text-org403cebc">
<ul class="org-ul">
<li><a href="./statistics-notes.html">Here</a> is an example of fitting a negative binomial GLM using the MASS
package.</li>
</ul>
</div>
</div>

<div id="outline-container-org2207bc1" class="outline-3">
<h3 id="org2207bc1">Linear regression <code>lm</code></h3>
<div class="outline-text-3" id="text-org2207bc1">
<p>
<a href="./statistics-notes.html">NOTES</a>
</p>
</div>
</div>

<div id="outline-container-org6bb7ddb" class="outline-3">
<h3 id="org6bb7ddb">Zero-inflated regression</h3>
<div class="outline-text-3" id="text-org6bb7ddb">
<p>
The following snippet demonstrates how to perform a zero-inflated Poisson
regression.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(pscl)
<span style="color: #D0372D;">library</span>(boot)
set.seed(1)

n <span style="color: #D0372D;">&lt;-</span> 1000
x1 <span style="color: #D0372D;">&lt;-</span> rnorm(n = n)
x2 <span style="color: #D0372D;">&lt;-</span> rnorm(n = n)
z1 <span style="color: #D0372D;">&lt;-</span> rnorm(n = n)
z2 <span style="color: #D0372D;">&lt;-</span> rnorm(n = n)
true_prob_zinf <span style="color: #D0372D;">&lt;-</span> inv.logit(2 * z1 + 0 * z2)
zero_inflation <span style="color: #D0372D;">&lt;-</span> rbernoulli(n = n,
                             p = true_prob_zinf)

true_count_means <span style="color: #D0372D;">&lt;-</span> exp(2 * x1 - 1 * x2 + 1)
maybe_count <span style="color: #D0372D;">&lt;-</span> rpois(n = n,
                     lambda = true_count_means)

y <span style="color: #D0372D;">&lt;-</span> ifelse(zero_inflation, 0, maybe_count)

df <span style="color: #D0372D;">&lt;-</span> data.frame(y = y,
                 x1 = x1,
                 x2 = x2,
                 z1 = z1,
                 z2 = z2)

my_zinb <span style="color: #D0372D;">&lt;-</span> zeroinfl(formula = y ~ x1 + x2 | z1 + z2,
                    data = df, dist = <span style="color: #008000;">"poisson"</span>)

true_mean <span style="color: #D0372D;">&lt;-</span> true_prob_zinf * 0 + (1 - true_prob_zinf) * true_count_means

plot(log(true_mean), log(fitted(my_zinb)))
abline(0,1)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd553b6b" class="outline-3">
<h3 id="orgd553b6b"><span class="todo TODO">TODO</span> Mathematical optimisation</h3>
<div class="outline-text-3" id="text-orgd553b6b">
<p>
<a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/nlm.html"><code>nlm</code></a>
</p>
</div>
</div>

<div id="outline-container-orga5422d2" class="outline-3">
<h3 id="orga5422d2">Computational geography and cartography</h3>
<div class="outline-text-3" id="text-orga5422d2">
<p>
See <a href="./computational-geography-notes.html">my other notes on this</a>.
</p>
</div>
</div>

<div id="outline-container-org2788fd7" class="outline-3">
<h3 id="org2788fd7">Differential equations with <code>deSolve</code></h3>
<div class="outline-text-3" id="text-org2788fd7">
</div>
<div id="outline-container-org63969b1" class="outline-4">
<h4 id="org63969b1">Basic SIR example</h4>
<div class="outline-text-4" id="text-org63969b1">
<p>
Simple SIR model
</p>

<p>
\[
\frac{ds}{dt} = -\beta s i \quad\text{and}\quad \frac{di}{dt} = \beta s i - \gamma i.
\]
</p>

<p>
The following demonstrates how to solve this system with <code>deSolve</code>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(deSolve)

<span style="color: #006699;">sir_diff</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(time, state, params) {
    with(as.list(c(params, state)), {
        ds <span style="color: #D0372D;">&lt;-</span> - beta * susceptible * infectious
        di <span style="color: #D0372D;">&lt;-</span> beta * susceptible * infectious - gamma * infectious
        list(c(ds, di))
    })
}

params <span style="color: #D0372D;">&lt;-</span> c(beta = 1.2, gamma = 1)
state <span style="color: #D0372D;">&lt;-</span> c(susceptible = 0.99, infectious = 0.01)
times <span style="color: #D0372D;">&lt;-</span> seq(from = 0, to = 20, length = 100)
pd <span style="color: #D0372D;">&lt;-</span> matrix(nrow = 2, ncol = 2, data = 0)
out1 <span style="color: #D0372D;">&lt;-</span> deSolve::ode(state, times, sir_diff, parms = params)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf79020c" class="outline-4">
<h4 id="orgf79020c">SIR example with C implementation</h4>
<div class="outline-text-4" id="text-orgf79020c">
<p>
Then we can implement the differential in C as
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">file sirmod.c</span><span style="color: #8D8D84;"> */</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;R.h&gt;</span>

<span style="color: #0000FF;">static</span> <span style="color: #6434A3;">double</span> <span style="color: #BA36A5;">params</span>[2];
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">beta</span> params[0]
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">gamma</span> params[1]

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">initializer</span><span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">void</span> <span style="color: #006699;">initmod</span>(<span style="color: #6434A3;">void</span> (* <span style="color: #006699;">odeparams</span>)(<span style="color: #6434A3;">int</span> *, <span style="color: #6434A3;">double</span> *))
{
  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">N</span>=2;
  odeparams(&amp;N, params);
}

<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">Derivatives and 1 output variable</span><span style="color: #8D8D84;"> */</span>
<span style="color: #6434A3;">void</span> <span style="color: #006699;">derivs</span> (<span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">neq</span>, <span style="color: #6434A3;">double</span> *<span style="color: #BA36A5;">t</span>, <span style="color: #6434A3;">double</span> *<span style="color: #BA36A5;">y</span>, <span style="color: #6434A3;">double</span> *<span style="color: #BA36A5;">ydot</span>,
             <span style="color: #6434A3;">double</span> *<span style="color: #BA36A5;">yout</span>, <span style="color: #6434A3;">int</span> *<span style="color: #BA36A5;">ip</span>)
{
  <span style="color: #0000FF;">if</span> (ip[0] &lt;1) error(<span style="color: #008000;">"nout should be at least 1"</span>);
  ydot[0] = -beta*y[0]*y[1];
  ydot[1] = beta*y[0]*y[1] - gamma*y[1];
  yout[0] = 1.0-y[0]+y[1];
}
<span style="color: #8D8D84;">/* </span><span style="color: #8D8D84; font-style: italic;">END file sirmod.c</span><span style="color: #8D8D84;"> */</span>
</pre>
</div>

<p>
Then we need to compile this and load the object for use of <code>deSovle</code>
</p>

<div class="org-src-container">
<pre class="src src-R">system(<span style="color: #008000;">"R CMD SHLIB sirmod.c"</span>)
dyn.load(<span style="color: #008000;">"sirmod.so"</span>)
out2 <span style="color: #D0372D;">&lt;-</span> deSolve::ode(state, times, func = <span style="color: #008000;">"derivs"</span>, parms = params,
                     dllname = <span style="color: #008000;">"sirmod"</span>, initfunc = <span style="color: #008000;">"initmod"</span>, nout = 1,
                     outnames = <span style="color: #008000;">"recovered"</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbed2ac8" class="outline-3">
<h3 id="orgbed2ac8">MCMC (without <code>Stan</code>)</h3>
<div class="outline-text-3" id="text-orgbed2ac8">
<p>
There is the package <code>mcmc</code> which looks like it does a solid job of the basics,
although it takes an opinionated stance on how this should be done. Be careful
with how you interpret the <code>batch</code> arguments. The interface is designed for
testing out tuning parameters to find something that works; make the most of
this design.
</p>

<p>
<a href="https://cran.r-project.org/web/packages/coda/coda.pdf"><code>coda</code></a> is probably what you want to use to check the output beyond basic
diagnostic plots.
</p>
</div>

<div id="outline-container-orgbe6e0af" class="outline-4">
<h4 id="orgbe6e0af">Thinning (destructive)</h4>
<div class="outline-text-4" id="text-orgbe6e0af">
<p>
This snippet demonstrates how to subset a data frame. It is a destructive
change, but since MCMC samples can be large you may not want the additional cost
of creating a copy.
</p>

<div class="org-src-container">
<pre class="src src-R">demo_df <span style="color: #D0372D;">&lt;-</span> data.frame(x = 1:100, y = rnorm(100))

<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">take every third sample</span>
thinning_factor <span style="color: #D0372D;">&lt;-</span> 3

demo_df <span style="color: #D0372D;">&lt;-</span> demo_df[seq(from = 1, to = nrow(demo_df), by = thinning_factor), ]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1173aa8" class="outline-3">
<h3 id="org1173aa8">(Nonparametric) density estimation with <code>KernSmooth</code></h3>
<div class="outline-text-3" id="text-org1173aa8">
<p>
Here is an example looking at how to use <code>KernSmooth</code>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(KernSmooth)

set.seed(1)

x <span style="color: #D0372D;">&lt;-</span> c(rpois(n = 500, lambda=10),
       rpois(n = 500, lambda = 30))

<span style="color: #006699;">f_x</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(x, ...) {
  0.5 * (dpois(x = x, lambda = 10, ...) +
         dpois(x = x, lambda = 30, ...))
}

x_mesh <span style="color: #D0372D;">&lt;-</span> 0:100
y_mesh <span style="color: #D0372D;">&lt;-</span> f_x(x_mesh)


kde_obj <span style="color: #D0372D;">&lt;-</span> bkde(x, bandwidth = 3, range.x = c(0,100), gridsize = 101)

r_kde_samples <span style="color: #D0372D;">&lt;-</span> sample(x = kde_obj$x,
                       size = length(x),
                       replace = <span style="color: #6434A3;">TRUE</span>,
                       prob = pmax(0, kde_obj$y))

type_char <span style="color: #D0372D;">&lt;-</span> c(<span style="color: #008000;">"true"</span>, <span style="color: #008000;">"estimate"</span>)

density_df <span style="color: #D0372D;">&lt;-</span> data.frame(x = c(x_mesh, x_mesh),
                         y = c(y_mesh, pmax(0, kde_obj$y)),
                         type = rep(type_char, each = 101))

sample_df <span style="color: #D0372D;">&lt;-</span> data.frame(x = c(x, r_kde_samples),
                        type = rep(type_char,
                                   each = length(x)))

ggplot() +
  geom_histogram(data = sample_df,
                 mapping = aes(x = x, y = ..density.., fill = type),
                 bins = 25,
                 size = 3,
                 position = <span style="color: #008000;">"dodge"</span>) +
  geom_line(data = density_df,
            mapping = aes(x = x, y = y, colour = type))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org40d0a50" class="outline-2">
<h2 id="org40d0a50">Miscellaneous functions</h2>
<div class="outline-text-2" id="text-org40d0a50">
</div>
<div id="outline-container-orga9afa4d" class="outline-3">
<h3 id="orga9afa4d">Function to save a ggplot to both PNG and SVG</h3>
<div class="outline-text-3" id="text-orga9afa4d">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Save a ggplot to both PNG and SVG.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">filepath</span><span style="color: #8D8D84; font-style: italic;"> is the path to save the plot to.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">plot</span><span style="color: #8D8D84; font-style: italic;"> is the ggplot object to save.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">...</span><span style="color: #8D8D84; font-style: italic;"> are additional arguments to pass to ggsave.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@examples</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> ggsave_plus("plot.png", ggplot() + geom_point(aes(x = 1:10, y = 1:10))</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">ggsave_plus</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(filepath, plot, ...) {
  <span style="color: #0000FF;">if</span> (stringr::str_ends(filepath, <span style="color: #008000;">".png"</span>)) {
    filepath_png <span style="color: #D0372D;">&lt;-</span> filepath
    filepath_svg <span style="color: #D0372D;">&lt;-</span> str_replace(filepath, <span style="color: #008000;">".png"</span>, <span style="color: #008000;">".svg"</span>)
  } <span style="color: #0000FF;">else</span> <span style="color: #0000FF;">if</span> (stringr::str_ends(filepath, <span style="color: #008000;">".svg"</span>)) {
    filepath_svg <span style="color: #D0372D;">&lt;-</span> filepath
    filepath_png <span style="color: #D0372D;">&lt;-</span> str_replace(filepath, <span style="color: #008000;">".svg"</span>, <span style="color: #008000;">".png"</span>)
  }

  ggplot2::ggsave(plot, filename = filepath_png, ...)
  ggplot2::ggsave(plot, filename = filepath_svg, ...)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org88992cd" class="outline-3">
<h3 id="org88992cd">Quantile functions of truncated distributions</h3>
<div class="outline-text-3" id="text-org88992cd">
<p>
The <code>truncnorm</code> package provides a clean way to work with normal
distributions that have been truncated to a finite range of values. I
wanted the analogous function for the quantile function of the
log-normal distribution but this wasn't in the package. Here is an
implementation and a basic test of such a quantile function.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #006699;">.qtruncnorm</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(p, a = -<span style="color: #6434A3;">Inf</span>, b = <span style="color: #6434A3;">Inf</span>, mean = 0, sd = 1) {
  ut_cdf_a <span style="color: #D0372D;">&lt;-</span> pnorm(a, mean = mean, sd = sd)
  ut_cdf_b <span style="color: #D0372D;">&lt;-</span> pnorm(b, mean = mean, sd = sd)
  ut_p <span style="color: #D0372D;">&lt;-</span> pnorm(a, mean = mean, sd = sd) + p * (pnorm(b, mean = mean, sd = sd) - pnorm(a, mean = mean, sd = sd))
  <span style="color: #0000FF;">return</span>(qnorm(ut_p, mean = mean, sd = sd))
}


.test_ps <span style="color: #D0372D;">&lt;-</span> runif(1000)
stopifnot(
  max(abs(.qtruncnorm(.test_ps, a = -1, b = 2, mean = 3) - truncnorm::qtruncnorm(.test_ps, a = -1, b = 2, mean = 3))) &lt; 1e-13
)


<span style="color: #006699;">.qtrunclnorm</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(p, a = -<span style="color: #6434A3;">Inf</span>, b = <span style="color: #6434A3;">Inf</span>, meanlog = 0, sdlog = 1) {
  ut_cdf_a <span style="color: #D0372D;">&lt;-</span> plnorm(a, meanlog = meanlog, sdlog = sdlog)
  ut_cdf_b <span style="color: #D0372D;">&lt;-</span> plnorm(b, meanlog = meanlog, sdlog = sdlog)
  ut_p <span style="color: #D0372D;">&lt;-</span> plnorm(a, meanlog = meanlog, sdlog = sdlog) + p * (plnorm(b, meanlog = meanlog, sdlog = sdlog) - plnorm(a, meanlog = meanlog, sdlog = sdlog))
  <span style="color: #0000FF;">return</span>(qlnorm(ut_p, meanlog = meanlog, sdlog = sdlog))
}


.test_ps <span style="color: #D0372D;">&lt;-</span> seq(from = 0.2, to = 0.9, length = 10)
stopifnot(
  max(abs(.qtrunclnorm(.test_ps, a = 0, b = 10^5, meanlog = 3) - qlnorm(.test_ps, meanlog = 3))) &lt; 1e-14
)
.test_ps <span style="color: #D0372D;">&lt;-</span> runif(1000)
stopifnot(
  !(max(abs(.qtrunclnorm(.test_ps, a = 0, b = 10^3, meanlog = 3) - qlnorm(.test_ps, meanlog = 3))) &lt; 1e-14)
)
stopifnot(
  (max(abs(.qtrunclnorm(.test_ps, a = 0, b = 10^5, meanlog = 3) - qlnorm(.test_ps, meanlog = 3))) &lt; 1e-14)
)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge05ef43" class="outline-3">
<h3 id="orge05ef43">Read BEAST2 log file</h3>
<div class="outline-text-3" id="text-orge05ef43">
<p>
See the example in the notes <a href="./beast2-notes.html">here</a>.
</p>
</div>
</div>

<div id="outline-container-org186584b" class="outline-3">
<h3 id="org186584b">Generating LaTeX summary of GLM</h3>
<div class="outline-text-3" id="text-org186584b">
<p>
We can use the <code>xtable</code> package to generate a table in LaTeX that
displays a sensible summary of estimates. The following function
streamlines this process a little bit.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Convert GLM Fit to LaTeX-Ready xtable</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> This function takes a GLM fit object, formats the summary information,</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> and returns an xtable object for LaTeX export.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">fit</span><span style="color: #8D8D84; font-style: italic;"> A GLM fit object obtained through the `glm()` function.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">num_fmt</span><span style="color: #8D8D84; font-style: italic;"> A string indicating the format for numerical values (default is "%f").</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">...</span><span style="color: #8D8D84; font-style: italic;"> Additional arguments passed to xtable.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@return</span><span style="color: #8D8D84; font-style: italic;"> An xtable object containing formatted GLM summary data.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@examples</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> fit &lt;- glm(mpg ~ wt + hp, data=mtcars, family=gaussian())</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> tab &lt;- glm_fit_as_xtable(fit, num_fmt="%.2f")</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> print.xtable(tab, include.rownames=FALSE, type="latex", file="demo-latex-table.tex")</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@importFrom</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">xtable</span><span style="color: #8D8D84; font-style: italic;"> xtable</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@importFrom</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">stats</span><span style="color: #8D8D84; font-style: italic;"> as.data.frame confint summary</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">glm_fit_as_xtable</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(fit, num_fmt=<span style="color: #008000;">"%f"</span>, ...) {

  ns <span style="color: #D0372D;">&lt;-</span> c(var = <span style="color: #008000;">"Variable"</span>,
          est_and_ci = <span style="color: #008000;">"Estimate and CI (95%)"</span>,
          sig = <span style="color: #008000;">"Significance"</span>,
          p_val = <span style="color: #008000;">"Pr(&gt;|t|)"</span>)

  fs_df <span style="color: #D0372D;">&lt;-</span> as.data.frame(summary(fit)$coefficient)[, c(1,4)]

  tmp <span style="color: #D0372D;">&lt;-</span> confint(fit)

  fs_df[[ns[<span style="color: #008000;">'var'</span>]]] <span style="color: #D0372D;">&lt;-</span> rownames(fs_df)
  est_and_ci_fmt <span style="color: #D0372D;">&lt;-</span>
    sprintf(<span style="color: #008000;">"%s (%s, %s)"</span>, num_fmt, num_fmt, num_fmt)
  fs_df[[ns[<span style="color: #008000;">'est_and_ci'</span>]]] <span style="color: #D0372D;">&lt;-</span>
    sprintf(est_and_ci_fmt, fs_df$Estimate, tmp[,1], tmp[,2])
  fs_df[[ns[<span style="color: #008000;">'sig'</span>]]] <span style="color: #D0372D;">&lt;-</span>
    ifelse(fs_df[[ns[<span style="color: #008000;">'p_val'</span>]]] &lt; 0.05 , <span style="color: #008000;">"*"</span>, <span style="color: #008000;">""</span>)

  rownames(fs_df) <span style="color: #D0372D;">&lt;-</span> <span style="color: #6434A3;">NULL</span>

  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Return xtable object</span>
  <span style="color: #0000FF;">return</span>(xtable(fs_df[ns[c(1,2,3)]],
                align = c(<span style="color: #008000;">"l"</span>, <span style="color: #008000;">"l"</span>, <span style="color: #008000;">"r"</span>, <span style="color: #008000;">"c"</span>),
                ...))
}

</pre>
</div>

<p>
This will return an <code>xtable</code> object which still needs to be printed in
a slightly strange way, the following example might help.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(xtable)

fit <span style="color: #D0372D;">&lt;-</span> glm(mpg ~ wt + hp, data=mtcars, family=gaussian())

print.xtable(glm_fit_as_xtable(fit, num_fmt=<span style="color: #008000;">"%.2f"</span>),
             include.rownames = <span style="color: #6434A3;">FALSE</span>,
             type = <span style="color: #008000;">"latex"</span>,
             file = <span style="color: #008000;">"demo-latex-table.tex"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb0e8227" class="outline-3">
<h3 id="orgb0e8227">Mini test suite</h3>
<div class="outline-text-3" id="text-orgb0e8227">
<p>
If you ever wanted to run tests in a script without needing another
package, here is a little function that you can use to do this. It is
configured with the global variable <code>RUN_TESTS</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">RUN_TESTS <span style="color: #D0372D;">&lt;-</span> <span style="color: #6434A3;">TRUE</span>

<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">Define a little tester function that evaluates an expression and</span>
<span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">stops with a suitable error message if it evaluates to false</span>
<span style="color: #006699;">tts_test</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(expr) {
  <span style="color: #0000FF;">if</span> (RUN_TESTS) {
    <span style="color: #0000FF;">if</span> (!expr) {
      cat(<span style="color: #008000;">"Test expression: "</span>, deparse(substitute(expr)), <span style="color: #008000;">"\n"</span>)
      <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"Test failed"</span>)
    } <span style="color: #0000FF;">else</span> {
      <span style="color: #D0372D;">message</span>(<span style="color: #008000;">"Test passed"</span>)
    }
  } <span style="color: #0000FF;">else</span> {
    <span style="color: #0000FF;">return</span>(invisible())
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orga212bdc" class="outline-3">
<h3 id="orga212bdc">Step function</h3>
<div class="outline-text-3" id="text-orga212bdc">
</div>
<div id="outline-container-orgffde9dd" class="outline-4">
<h4 id="orgffde9dd">Step function construction</h4>
<div class="outline-text-4" id="text-orgffde9dd">
<p>
The following snippet defines a vectorised step function.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Return a vectorized step function.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> This function creates a vectorized step function that changes</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> values at specified time points (`ts`). The resulting step function</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> will produce a constant value between each pair of consecutive</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> times in `ts`, and return the corresponding value in `vs` for any</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> given input. If an input value is less than the first time in `ts`,</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> it will return the first value in `vs`. If an input value is</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> greater than or equal to the last time in `ts`, it will return the</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> last value in `vs`.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">ts</span><span style="color: #8D8D84; font-style: italic;"> A numeric vector of times at which the step function</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   changes values. Must be sorted in strictly increasing order and</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   have at least one element.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">vs</span><span style="color: #8D8D84; font-style: italic;"> A numeric vector of values corresponding to the steps.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   Must have one more element than `ts` because the function needs</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   to cover all time ranges, including values less than the first</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   time and values greater than or equal to the last time.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">step_function_factory</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(ts, vs) {
  n <span style="color: #D0372D;">&lt;-</span> length(ts)
  <span style="color: #0000FF;">if</span> (n &lt; 1) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"need at least one step time."</span>)
  }
  <span style="color: #0000FF;">if</span> (all(sort(ts, decreasing = <span style="color: #6434A3;">FALSE</span>) != ts)) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"times must be sorted in strictly increasing order."</span>)
  }
  <span style="color: #0000FF;">if</span> (length(vs) != (1 + n)) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"if there are n step times there must be n+1 values."</span>)
  }

  <span style="color: #006699;">step_func</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(x) {
    m <span style="color: #D0372D;">&lt;-</span> length(x)
    y <span style="color: #D0372D;">&lt;-</span> numeric(m)
    mask <span style="color: #D0372D;">&lt;-</span> logical(m)
    mask <span style="color: #D0372D;">&lt;-</span> x &lt; ts[1]
    y[mask] <span style="color: #D0372D;">&lt;-</span> vs[1]
    <span style="color: #0000FF;">if</span> (n &gt; 1) {
      <span style="color: #0000FF;">for</span> (ix <span style="color: #0000FF;">in</span> seq.int(2, n)) {
        mask <span style="color: #D0372D;">&lt;-</span> (ts[ix-1] &lt;= x) &amp; (x &lt; ts[ix])
        y[mask] <span style="color: #D0372D;">&lt;-</span> vs[ix]
      }
    }
    mask <span style="color: #D0372D;">&lt;-</span> x &gt;= ts[n]
    y[mask] <span style="color: #D0372D;">&lt;-</span> vs[n+1]
    <span style="color: #0000FF;">return</span>(y)
  }

  <span style="color: #0000FF;">return</span>(
    list(
      func = step_func,
      times = ts,
      values = vs
    )
  )
}
</pre>
</div>

<p>
Here is a demonstration of it in action producing Figure <a href="#org333e2c9">1</a>
</p>

<div class="org-src-container">
<pre class="src src-R">t1s <span style="color: #D0372D;">&lt;-</span> c(2.0, 3.0)
v1s <span style="color: #D0372D;">&lt;-</span> c(3.0, 2.5, 3.5)
demo1 <span style="color: #D0372D;">&lt;-</span> step_function_factory(t1s, v1s)
t2s <span style="color: #D0372D;">&lt;-</span> c(1.0)
v2s <span style="color: #D0372D;">&lt;-</span> c(1.0, 2.0)
demo2 <span style="color: #D0372D;">&lt;-</span> step_function_factory(t2s, v2s)

x <span style="color: #D0372D;">&lt;-</span> seq(from = 0, to = 4, length = 200)
y1 <span style="color: #D0372D;">&lt;-</span> demo1$func(x)
y2 <span style="color: #D0372D;">&lt;-</span> demo2$func(x)

png(<span style="color: #008000;">'step-function-demo.png'</span>,
    width = 1.618 * 300,
    height = 300,
    units = <span style="color: #008000;">"px"</span>)
plot(x, y1, <span style="color: #008000;">'l'</span>, col = <span style="color: #008000;">'black'</span>, ylab = <span style="color: #008000;">""</span>, ylim = c(0.5, 3.5))
lines(x, y2, col = <span style="color: #008000;">'black'</span>)
points(t1s, demo1$func(t1s), col = <span style="color: #008000;">'blue'</span>, cex = 3, pch = 16)
points(t1s, demo1$func(t1s - 1e-10), col = <span style="color: #008000;">'red'</span>, cex = 3, pch = 1)
points(t2s, demo2$func(t2s), col = <span style="color: #008000;">'blue'</span>, cex = 3, pch = 16)
points(t2s, demo2$func(t2s - 1e-10), col = <span style="color: #008000;">'red'</span>, cex = 3, pch = 1)
dev.off()
</pre>
</div>


<div id="org333e2c9" class="figure">
<p><img src="../images/step-function-demo.png" alt="step-function-demo.png" width="600px" />
</p>
<p><span class="figure-number">Figure 1: </span>Example of step function result.</p>
</div>
</div>
</div>

<div id="outline-container-org1f4f2b8" class="outline-4">
<h4 id="org1f4f2b8">Applying binary functions to step functions</h4>
<div class="outline-text-4" id="text-org1f4f2b8">
<p>
The class of step functions is closed under the point-wise application of binary
functions. What? This means if you have two functions \(f(x)\) and \(g(x)\)
which are step functions, then \(h(x) := f(x) + g(x) \) is also a step function,
and more generally \(h^{F}(x) := F(f(x), g(x))\) is a step function given some
binary function \(F\). This can be implemented as follows
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Return a vectorised step function resulting from the point-wise application</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> of a binary function to two step functions.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">step_func_a</span><span style="color: #8D8D84; font-style: italic;"> a step function (see \code{step_function_factory}.)</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">step_func_b</span><span style="color: #8D8D84; font-style: italic;"> a step function (see \code{step_function_factory}.)</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">binary_func</span><span style="color: #8D8D84; font-style: italic;"> a binary function.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">map_step_function</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(step_func_a, step_func_b, binary_func) {
  times_c <span style="color: #D0372D;">&lt;-</span> sort(union(step_func_a$times, step_func_b$times))
  n <span style="color: #D0372D;">&lt;-</span> length(times_c)
  values_c <span style="color: #D0372D;">&lt;-</span> numeric(n + 1)
  values_c[1] <span style="color: #D0372D;">&lt;-</span> binary_func(
    step_func_a$func(step_func_a$times[1] - 1),
    step_func_b$func(step_func_b$times[1] - 1)
  )
  <span style="color: #0000FF;">for</span> (ix <span style="color: #0000FF;">in</span> seq.int(n)) {
    values_c[ix+1] <span style="color: #D0372D;">&lt;-</span> binary_func(
      step_func_a$func(times_c[ix]),
      step_func_b$func(times_c[ix])
    )
  }
  <span style="color: #0000FF;">return</span>(step_function_factory(times_c, values_c))
}
</pre>
</div>

<p>
Here is a demonstration of it in action producing Figure <a href="#org7f2fdbb">2</a>
</p>

<div class="org-src-container">
<pre class="src src-R">demo3 <span style="color: #D0372D;">&lt;-</span> map_step_function(demo1, demo2, <span style="color: #0000FF;">function</span>(x, y) { x / y })
y3 <span style="color: #D0372D;">&lt;-</span> demo3$func(x)
t3s <span style="color: #D0372D;">&lt;-</span> c(t2s, t1s)

png(<span style="color: #008000;">'step-function-binary-demo.png'</span>,
    width = 1.618 * 300,
    height = 300,
    units = <span style="color: #008000;">"px"</span>)
plot(x, y3, <span style="color: #008000;">'l'</span>, col = <span style="color: #008000;">'black'</span>, ylab = <span style="color: #008000;">""</span>)
points(t3s, demo3$func(t3s), col = <span style="color: #008000;">'blue'</span>, cex = 3, pch = 16)
points(t3s, demo3$func(t3s - 1e-10), col = <span style="color: #008000;">'red'</span>, cex = 3, pch = 1)
dev.off()
</pre>
</div>


<div id="org7f2fdbb" class="figure">
<p><img src="../images/step-function-binary-demo.png" alt="step-function-binary-demo.png" width="600px" />
</p>
<p><span class="figure-number">Figure 2: </span>The result of combining two step functions.</p>
</div>

<p>
And here is another example in which we use date-time objects for the
times of the step functions. The resulting figure is shown in Figure
<a href="#org5f9d6eb">3</a>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #D0372D;">library</span>(lubridate)

ts1 <span style="color: #D0372D;">&lt;-</span> ymd_hms(c(<span style="color: #008000;">"2024-01-01 00:00:00"</span>,
                 <span style="color: #008000;">"2024-01-02 00:00:00"</span>,
                 <span style="color: #008000;">"2024-01-03 00:00:00"</span>))
vs1 <span style="color: #D0372D;">&lt;-</span> c(10, 30, 20, 40)
step_func_a <span style="color: #D0372D;">&lt;-</span> step_function_factory(ts1, vs1)

ts2 <span style="color: #D0372D;">&lt;-</span> ymd_hms(c(<span style="color: #008000;">"2024-01-02 00:00:00"</span>,
                 <span style="color: #008000;">"2024-01-03 00:00:00"</span>,
                 <span style="color: #008000;">"2024-01-04 00:00:00"</span>))
vs2 <span style="color: #D0372D;">&lt;-</span> c(15, 25, 35, 45)
step_func_b <span style="color: #D0372D;">&lt;-</span> step_function_factory(ts2, vs2)

step_func_c <span style="color: #D0372D;">&lt;-</span> map_step_function(step_func_a,
                                 step_func_b,
                                 <span style="color: #0000FF;">function</span>(x, y) { x + y })

times_to_evaluate <span style="color: #D0372D;">&lt;-</span> seq(from = ymd_hms(<span style="color: #008000;">"2023-12-31 00:00:00"</span>),
                         to = ymd_hms(<span style="color: #008000;">"2024-01-05 00:00:00"</span>),
                         length = 100)
result <span style="color: #D0372D;">&lt;-</span> step_func_c$func(times_to_evaluate)

png(<span style="color: #008000;">'step-function-dates-demo.png'</span>,
    width = 1.618 * 300,
    height = 300,
    units = <span style="color: #008000;">"px"</span>)
plot(times_to_evaluate, result, <span style="color: #008000;">'l'</span>, col = <span style="color: #008000;">'black'</span>, ylab = <span style="color: #008000;">""</span>, ylim = c(0, 90))
lines(times_to_evaluate, step_func_a$func(times_to_evaluate), col = <span style="color: #008000;">'blue'</span>)
lines(times_to_evaluate, step_func_b$func(times_to_evaluate), col = <span style="color: #008000;">'red'</span>)
dev.off()
</pre>
</div>


<div id="org5f9d6eb" class="figure">
<p><img src="../images/step-function-dates-demo.png" alt="step-function-dates-demo.png" width="600px" />
</p>
<p><span class="figure-number">Figure 3: </span>An example using dates as time</p>
</div>
</div>
</div>

<div id="outline-container-org2c33e7d" class="outline-4">
<h4 id="org2c33e7d">A multivariate generalisation of the step function</h4>
<div class="outline-text-4" id="text-org2c33e7d">
<p>
The multi version of the step function returns a vector of values when
evaluated at a single point and a matrix when given a vector of times.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Return a vectorized step vector-function.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> This is similar to the `step_function_factory` function except that</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> it returns a vector-value instead of a single value. The use case</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> for this is to be able to have a distribution of step functions</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> obtained from a posterior sample.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">ts</span><span style="color: #8D8D84; font-style: italic;"> A numeric vector of times at which the step function</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   changes values. Must be sorted in strictly increasing order and</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   have at least one element.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #0000FF; font-style: italic;">@param</span><span style="color: #8D8D84; font-style: italic;"> </span><span style="color: #BA36A5; font-style: italic;">vs_list</span><span style="color: #8D8D84; font-style: italic;"> A list of numeric vectors of values corresponding to</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   the steps. Each vector must have one more element than `ts`</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   because the function needs to cover all time ranges, including</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   values less than the first time and values greater than or equal</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;">   to the last time.</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #006699;">step_function_factory_multi</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(ts, vs_list) {
  n <span style="color: #D0372D;">&lt;-</span> length(ts)
  <span style="color: #0000FF;">if</span> (n &lt; 1) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"need at least one step time."</span>)
  }
  <span style="color: #0000FF;">if</span> (all(sort(ts, decreasing = <span style="color: #6434A3;">FALSE</span>) != ts)) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"times must be sorted in strictly increasing order."</span>)
  }
  <span style="color: #0000FF;">if</span> (length(vs_list) != (1 + n)) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"if there are n step times there must be n+1 values."</span>)
  }
  vec_length <span style="color: #D0372D;">&lt;-</span> length(vs_list[[1]])
  <span style="color: #0000FF;">if</span> (!all(sapply(vs_list, <span style="color: #0000FF;">function</span>(x) length(x) == vec_length))) {
    <span style="color: #0000FF;">stop</span>(<span style="color: #008000;">"all vectors in the list must be the same length."</span>)
  }

  <span style="color: #006699;">step_func</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(x) {
    m <span style="color: #D0372D;">&lt;-</span> length(x)
    y <span style="color: #D0372D;">&lt;-</span> matrix(numeric(m * vec_length), nrow = m)
    mask <span style="color: #D0372D;">&lt;-</span> logical(m)
    mask <span style="color: #D0372D;">&lt;-</span> x &lt; ts[1]
    y[mask, ] <span style="color: #D0372D;">&lt;-</span>  t(replicate(sum(mask), vs_list[[1]]))
    <span style="color: #0000FF;">if</span> (n &gt; 1) {
      <span style="color: #0000FF;">for</span> (ix <span style="color: #0000FF;">in</span> seq.int(2, n)) {
        mask <span style="color: #D0372D;">&lt;-</span> (ts[ix - 1] &lt;= x) &amp; (x &lt; ts[ix])
        y[mask, ] <span style="color: #D0372D;">&lt;-</span> t(replicate(sum(mask), vs_list[[ix]]))
      }
    }
    mask <span style="color: #D0372D;">&lt;-</span> x &gt;= ts[n]
    y[mask, ] <span style="color: #D0372D;">&lt;-</span> t(replicate(sum(mask), vs_list[[n + 1]]))
    <span style="color: #0000FF;">return</span>(y)
  }

  <span style="color: #0000FF;">return</span>(
    list(
      func = step_func,
      times = ts,
      values = vs_list
    )
  )
}
</pre>
</div>

<p>
And here is an example of how to use this.
</p>

<div class="org-src-container">
<pre class="src src-R">t4s <span style="color: #D0372D;">&lt;-</span> c(2.0, 3.0)
num_funcs <span style="color: #D0372D;">&lt;-</span> 5
v4s <span style="color: #D0372D;">&lt;-</span> list(rnorm(num_funcs, sd = 0.2, mean = 1),
            rnorm(num_funcs, sd = 0.2, mean = 3),
            rnorm(num_funcs, sd = 0.2, mean = 2))
vals_range <span style="color: #D0372D;">&lt;-</span> v4s |&gt; unlist() |&gt; range()
demo4 <span style="color: #D0372D;">&lt;-</span> step_function_factory_multi(t4s, v4s)

x <span style="color: #D0372D;">&lt;-</span> seq(from = 0, to = 4, length = 200)
y <span style="color: #D0372D;">&lt;-</span> demo4$func(x)
</pre>
</div>

<p>
Which produces the following Figure <a href="#org0983a74">4</a>.
</p>


<div id="org0983a74" class="figure">
<p><img src="../images/step-function-multi-demo.png" alt="step-function-multi-demo.png" width="600px" />
</p>
<p><span class="figure-number">Figure 4: </span>An example using multivariate values</p>
</div>

<div class="org-src-container">
<pre class="src src-R">cols <span style="color: #D0372D;">&lt;-</span> c(<span style="color: #008000;">'red'</span>, <span style="color: #008000;">'orange'</span>, <span style="color: #008000;">'yellow'</span>, <span style="color: #008000;">'green'</span>, <span style="color: #008000;">'blue'</span>)
png(<span style="color: #008000;">'step-function-multi-demo.png'</span>,
    width = 1.618 * 300,
    height = 300,
    units = <span style="color: #008000;">"px"</span>)
plot(x, y[,1], <span style="color: #008000;">'l'</span>, col = cols[1], ylim = vals_range + c(-0.5, 0.5), ylab = <span style="color: #008000;">""</span>, xlab = <span style="color: #008000;">""</span>)
<span style="color: #0000FF;">for</span> (ix <span style="color: #0000FF;">in</span> 2:num_funcs) {
  lines(x, y[,ix], col = cols[ix])
}
dev.off()
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org203219d" class="outline-3">
<h3 id="org203219d">Number of lines in a file</h3>
<div class="outline-text-3" id="text-org203219d">
<p>
The <code>num_lines_in_file</code> function returns the number of lines in a file which is
useful to help guard against attempting to parse an empty file with <code>read.csv</code>.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #006699;">num_lines_in_file</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(fp) {
  wc_stdout <span style="color: #D0372D;">&lt;-</span> system2(command = <span style="color: #008000;">"wc"</span>, args = c(<span style="color: #008000;">"-l"</span>, fp), stdout = <span style="color: #6434A3;">TRUE</span>)
  as.numeric(head(unlist(strsplit(x = wc_stdout, split = <span style="color: #008000;">" "</span>)),1))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6aff2e" class="outline-3">
<h3 id="orgf6aff2e">Julian day of the year</h3>
<div class="outline-text-3" id="text-orgf6aff2e">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> Julian day of the year</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> &gt; j_day("2014-01-03", "2014-01-01")</span>
<span style="color: #000000; font-weight: bold;">#</span><span style="color: #000000; font-weight: bold; font-style: italic;">'</span><span style="color: #8D8D84; font-style: italic;"> 3</span>
<span style="color: #006699;">j_day</span> <span style="color: #D0372D;">&lt;-</span> <span style="color: #0000FF;">function</span>(date_string, first_day_of_year_string) {
  as.integer(as.Date(date_string) - as.Date(first_day_of_year_string)) + 1
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3660b02" class="outline-2">
<h2 id="org3660b02">RStudio</h2>
<div class="outline-text-2" id="text-org3660b02">
</div>
<div id="outline-container-org57905f2" class="outline-3">
<h3 id="org57905f2">Making it comfortable to work in</h3>
<div class="outline-text-3" id="text-org57905f2">
<ol class="org-ol">
<li>Open the preferences menu: <b>Tools</b> then <b>Global Options</b>.</li>
<li>In the <b>Code</b> menu enable Vim bindings (obviously).</li>
<li>In the <b>Appearance</b> menu, make the font and theme comfortable for
your eyes.</li>
<li>In <b>Pane Layout</b> ensure the console and source panes dominate the
screen.</li>
<li><p>
Keep in mind the following (default) keybindings:
</p>
<ul class="org-ul">
<li><code>Alt+Shift+K</code> shows the keybinding cheatsheet</li>
<li><code>Crtl+1</code> focuses on source</li>
<li><code>Ctrl+2</code> focuses on the console</li>
<li><code>Crtl+Enter</code> runs the selected lines</li>
</ul>
<p>
The <b>Tools</b> menu has a tool for modifying keybindings
</p></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org4fdf2f0" class="outline-2">
<h2 id="org4fdf2f0">Further reading</h2>
<div class="outline-text-2" id="text-org4fdf2f0">
</div>
<div id="outline-container-orgafedaca" class="outline-3">
<h3 id="orgafedaca">Articles</h3>
<div class="outline-text-3" id="text-orgafedaca">
<ul class="org-ul">
<li><a href="https://doi.org/10.1371/journal.pcbi.1009884"><i>Ten simple rules for finding and selecting R packages</i></a></li>
</ul>
</div>
</div>

<div id="outline-container-org3be346c" class="outline-3">
<h3 id="org3be346c">Blogs</h3>
<div class="outline-text-3" id="text-org3be346c">
<ul class="org-ul">
<li><a href="https://rviews.rstudio.com/about/">R Views</a> (the RStudio blog about R).</li>
</ul>
</div>
</div>

<div id="outline-container-org8516fcf" class="outline-3">
<h3 id="org8516fcf">Books</h3>
<div class="outline-text-3" id="text-org8516fcf">
<ul class="org-ul">
<li><a href="https://r4ds.hadley.nz/index.html">R for Data Science</a> by Hadley Wickham has a second (and substantially expanded)
edition.</li>
<li><a href="https://r-pkgs.org/">R Packages (2e)</a> by Hadley Wickham and Jennifer Bryan.</li>
</ul>
</div>
</div>

<div id="outline-container-org4cbf996" class="outline-3">
<h3 id="org4cbf996">Documentation</h3>
<div class="outline-text-3" id="text-org4cbf996">
<ul class="org-ul">
<li><a href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R Extensions</a></li>
<li><a href="https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-R.html">R Source Code Blocks in Org Mode</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgb9aa869" class="outline-3">
<h3 id="orgb9aa869">Curated packages</h3>
<div class="outline-text-3" id="text-orgb9aa869">
<ul class="org-ul">
<li><a href="https://cran.r-project.org/web/views/">CRAN Task Views</a></li>
<li><a href="https://www.bioconductor.org/packages/release/BiocViews.html">BioConductor BiocViews</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alexander E. Zarebski</p>
<p class="date">Created: 2025-02-21 Fri 17:51</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
