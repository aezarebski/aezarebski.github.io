<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-04-06 Thu 18:27 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>r-lang-aez-notes</title>
<meta name="author" content="Alexander E. Zarebski" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet.css" />
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">r-lang-aez-notes</h1>
<p>
<a href="../index.html">Home</a>
</p>


<div id="org01f5ea2" class="figure">
<p><img src="../images/r-logo.png" alt="r-logo.png" width="250px" />
</p>
</div>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org15eafb5">Programming in R (installation and administration)</a>
<ul>
<li><a href="#org040c5fe">Installing and updating R</a></li>
<li><a href="#org1469c96">Managing R installations</a></li>
</ul>
</li>
<li><a href="#org0f891d8">Programming in R (software development)</a>
<ul>
<li><a href="#org564e751">Scripting with R</a></li>
<li><a href="#org2ef9789">Working with files</a></li>
<li><a href="#org0c567ca">Error handling</a></li>
<li><a href="#org965c800"><i>R Packages</i> by Wickham and Bryan</a></li>
<li><a href="#org9fae96b">High performance computing</a></li>
<li><a href="#orgd9d44b4">Packages I like</a></li>
<li><a href="#org64076ae">Reshaping dataframes with <code>reshape2</code></a></li>
<li><a href="#org13455bb">Command line arguments</a></li>
<li><a href="#orgd1e3a81">Command line arguments with <code>argparse</code></a></li>
<li><a href="#org2a934a3">Working with JSON</a></li>
<li><a href="#orga07cf69">Working with HTML</a></li>
<li><a href="#org10288b7">OUTDATED: Working with XML with <code>XML</code></a></li>
<li><a href="#org94e7bc6">Working with Mustache templates</a></li>
<li><a href="#org8293f07">Unit testing with <code>testthat</code></a></li>
<li><a href="#org6f40c21">Dependency management with <code>packrat</code></a></li>
<li><a href="#org7c29a55">Package and project management with <code>usethis</code></a></li>
<li><a href="#orgf7759e0">Date handling with <code>lubridate</code></a></li>
<li><a href="#org5386d35">String handling with <code>stringr</code></a></li>
<li><a href="#orgca593b8">Documentation with <code>roxygen2</code></a></li>
<li><a href="#org149d732">Dates and times</a></li>
<li><a href="#org68d6600"><code>Rmath.h</code></a></li>
<li><a href="#org70c5394">Cheat sheets</a></li>
<li><a href="#org3df83a7">Data frames</a></li>
<li><a href="#org546d441">Data structures</a></li>
</ul>
</li>
<li><a href="#orgeaa6ea0">Data munging</a>
<ul>
<li><a href="#orga9af408">Working with XML</a></li>
<li><a href="#org03bc624">Joins</a></li>
<li><a href="#orgea3b22d">Aggregation</a></li>
</ul>
</li>
<li><a href="#orgdcb2b47">Programming in R (language and evaluation)</a>
<ul>
<li><a href="#org24f613e">Recommended reading</a></li>
<li><a href="#org2ab2491">Functional programming support</a></li>
<li><a href="#orge5c70df">R/Haskell Prelude</a></li>
<li><a href="#org6650134">Program flow and control</a></li>
<li><a href="#org937941b">Numbers</a></li>
<li><a href="#orgf9a9eb5">Metaprogramming and nonstandard evaluation</a></li>
<li><a href="#orgdddc300">Object-oriented programming</a></li>
</ul>
</li>
<li><a href="#org6542a9d">Statistics with R</a>
<ul>
<li><a href="#org1c02152">Linear regression <code>lm</code></a></li>
<li><a href="#org990e9a5">Zero-inflated regression</a></li>
<li><a href="#orge771747"><span class="todo TODO">TODO</span> Mathematical optimisation</a></li>
<li><a href="#org764bd73">Computational geography and cartography</a></li>
<li><a href="#org6a3c896">Differential equations with <code>deSolve</code></a></li>
<li><a href="#org2a3e3e0">MCMC (without <code>Stan</code>)</a></li>
<li><a href="#orge5ea2d5">(Nonparametric) density estimation with <code>KernSmooth</code></a></li>
</ul>
</li>
<li><a href="#orgbccc8c0">Miscellaneous functions</a>
<ul>
<li><a href="#orgca493cc">Step function</a></li>
<li><a href="#orgf0c6901">Number of lines in a file</a></li>
<li><a href="#org1f87986">Julian day of the year</a></li>
</ul>
</li>
<li><a href="#orge244fb4">Further reading</a>
<ul>
<li><a href="#org03666b1">Articles</a></li>
<li><a href="#org2068dcf">Blogs</a></li>
<li><a href="#org6cb8af5">Books</a></li>
<li><a href="#org48499cd">Documentation</a></li>
<li><a href="#org2d4f823">Curated packages</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org15eafb5" class="outline-2">
<h2 id="org15eafb5">Programming in R (installation and administration)</h2>
<div class="outline-text-2" id="text-org15eafb5">
</div>
<div id="outline-container-org040c5fe" class="outline-3">
<h3 id="org040c5fe">Installing and updating R</h3>
<div class="outline-text-3" id="text-org040c5fe">
<p>
<b>Last update was to 4.2.3 &#x2013; Shortstop Beagle</b>
</p>

<p>
R updates frequently and things can break, so it is a good idea to keep your
version of R reasonably up to date. You can obtain the source code for every
version of R from <a href="https://cran.r-project.org/src/base/">CRAN</a>. The steps involved in getting a particular version of R
are as follows.
</p>

<ol class="org-ol">
<li>Ensure you have the necessary dependencies with <code>sudo apt-get r-base</code>.</li>
<li>Download the relevant source, e.g. <code>R-4.2.1.tar.gz</code>, and unzip it: <code>tar -xvf
   R-X.Y.Z.tar.gz</code>.</li>
<li>Run <code>./configure</code> be sure to double check the output for configuration errors.
<ul class="org-ul">
<li>If you are using this with RStudio, you will need to use <code>--enable-R-shlib</code>.</li>
<li>If you are using SVG you may need to include <code>--with-cairo</code>.</li>
<li>If you are using Wayland you might need <code>--with-x=no</code>.</li>
</ul></li>
<li>Run <code>make</code> and <code>make info</code> to compile R and the documentation.</li>
<li>Check that the compilation has worked properly with <code>make check</code> and address
any issues that arise.</li>
<li>Install the executable with <code>sudo make install</code> and <code>sudo make install-info</code>.</li>
<li>Check it worked with <code>R -e "sessionInfo()"</code>.</li>
<li>Profit!</li>
</ol>

<p>
Note that step 3 takes the longest, but this still took less than 20 minutes on
my machine for <code>R-4.1.0</code>. After updating, you'll probably have lost all your
packages, the following command can help with this.
</p>

<div class="org-src-container">
<pre class="src src-R">my_pkgs &lt;- c("ape",
             "argparse",
             "coda",
             "cowplot",
             "dplyr",
             "devtools",
             "future",
             "furrr",
             "htmltools",
             "jsonlite",
             "phangorn",
             "purrr",
             "purrr",
             "magrittr",
             "mcmc",
             "ggplot2",
             "remotes",
             "reshape2",
             "stringr",
             "targets",
             "xml2")
install.packages(my_pkgs)
</pre>
</div>

<p>
Last time when I updated the packages it said the default library was not
writable so I used a personal library instead. Running the session with <code>sudo</code>
fixed this. Old package versions hanging around can be found with <code>.libPaths()</code>.
</p>
</div>

<div id="outline-container-orga00e12e" class="outline-4">
<h4 id="orga00e12e">Notes</h4>
<div class="outline-text-4" id="text-orga00e12e">
<ul class="org-ul">
<li><code>R.4.2.3</code> I needed to use <code>--with-x=no</code> because I don't have X on the new
laptop. Sadly, this seems to break plots. Also, <code>make install</code> put the binary
in <code>/usr/local/bin</code> which appeared on the path after the location where the
default installation is.</li>
<li><code>R.4.2.1</code></li>
<li><code>R.4.2.0</code> extends the pipe syntax, and some cases where <code>if</code> and <code>while</code> previously
threw a warning now throw and error.</li>
<li><code>R-4.1.2</code></li>
<li><code>R-4.1.0</code> introduces some new syntax: <code>|&gt;</code> for piping and some sugar for
anonymous functions, eg <code>\(x) x + 1</code> becomes <code>function(x) x+1</code>. After
upgrading I could not create plots interactively, instead there was a message
about <code>unable to start device X11cairo</code>. The fix for this was to set the
<code>DISPLAY</code> environment variable to <code>:1</code> where it was defaulting to <code>:0</code>.</li>
<li><code>R-4.0.4</code> Having some problems getting ggplot figures with transparency
working but only in the PDF output. It hasn't been a problem so far so leaving
it until next time. I was prompted to use a personal library for the packages
this time, it is at <code>/home/aez/R/x86_64-pc-linux-gnu-library/4.0</code>.</li>
<li><code>R-4.0.2</code> needed me to install <code>libpcre2-dev</code> to get the configuration step to
work. I also had to use <code>sudo make install</code> to install the executable where as
previously it had not needed this level of permission. The <code>update.packages</code>
command didn't work as expected this time, which prompted the installation
list. I also needed to install a package <code>build-dep</code> before building this.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org1469c96" class="outline-3">
<h3 id="org1469c96">Managing R installations</h3>
<div class="outline-text-3" id="text-org1469c96">
<p>
There is an R package, <a href="https://github.com/r-lib/rim">rim</a>, which manages installations: R installation manager.
</p>
</div>
</div>
</div>

<div id="outline-container-org0f891d8" class="outline-2">
<h2 id="org0f891d8">Programming in R (software development)</h2>
<div class="outline-text-2" id="text-org0f891d8">
</div>
<div id="outline-container-org564e751" class="outline-3">
<h3 id="org564e751">Scripting with R</h3>
<div class="outline-text-3" id="text-org564e751">
</div>
<div id="outline-container-org9e0a036" class="outline-4">
<h4 id="org9e0a036">Running system commands with <code>base</code></h4>
<div class="outline-text-4" id="text-org9e0a036">
<div class="org-src-container">
<pre class="src src-R">system2(command, args = character(),
        wait = TRUE,
        timeout = 0)
</pre>
</div>

<ul class="org-ul">
<li>if <code>wait</code> is set to <code>FALSE</code> then this will run asynchronously</li>
<li>if <code>timeout</code> is set to a value greater than zero it will kill the process
after that amount of time if it has not finished.</li>
</ul>

<div class="org-src-container">
<pre class="src src-R">system2("ls", args = "/home/aez/Documents")
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb8fef1d" class="outline-4">
<h4 id="orgb8fef1d">Running system commands with <code>processx</code></h4>
<div class="outline-text-4" id="text-orgb8fef1d">
<p>
There is the <code>run</code> command (from the library) which is a convenience function,
otherwise you can use <code>process$new(...)</code> to create an instance of a new process.
</p>
</div>
</div>

<div id="outline-container-org6f0ec05" class="outline-4">
<h4 id="org6f0ec05">Helper function for system commands</h4>
<div class="outline-text-4" id="text-org6f0ec05">
<p>
The following can be saved to a file and imported if you just need that one
function.
</p>

<div class="org-src-container">
<pre class="src src-R">message("loading the run_command function.")

#' Helper function for running system commands.
#'
#' Example
#' &gt; run_command("stack build")
#' &gt; run_command("Rscript R/make-simulation-configuration-1.R")
#'
run_command &lt;- function(cmd, silent = TRUE, ...) {
  message(sprintf("\nRunning command:\n\t%s", cmd))
  tmp &lt;- unlist(strsplit(cmd, " "))
  cmd_name &lt;- head(tmp, 1)
  cmd_args &lt;- tail(tmp, -1)
  std_val &lt;- if (silent) {
    FALSE
  } else {
    ""
  }
  result &lt;- system2(
    cmd_name,
    args = cmd_args,
    stdout = std_val,
    stderr = std_val,
    ...
  )
  if (result != 0) {
    stop(sprintf("command %s failed!", cmd))
  }
  return(NULL)
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2ef9789" class="outline-3">
<h3 id="org2ef9789">Working with files</h3>
<div class="outline-text-3" id="text-org2ef9789">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Some functions for working with filepaths.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Function</th>
<th scope="col" class="org-left">Use</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>tempfile</code></td>
<td class="org-left">create temporary file</td>
</tr>

<tr>
<td class="org-left"><code>basename</code></td>
<td class="org-left">get the file's name</td>
</tr>

<tr>
<td class="org-left"><code>dirname</code></td>
<td class="org-left">get the file's directory</td>
</tr>

<tr>
<td class="org-left"><code>file.exists</code></td>
<td class="org-left">predicate for file existance</td>
</tr>

<tr>
<td class="org-left"><code>dir.exists</code></td>
<td class="org-left">predicate for directory existance</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org0c567ca" class="outline-3">
<h3 id="org0c567ca">Error handling</h3>
<div class="outline-text-3" id="text-org0c567ca">
<p>
Hadley has a nice <a href="http://adv-r.had.co.nz/Exceptions-Debugging.html#condition-handling">description</a> of how to handle these things in more detail, but here is a small example (from him)
</p>

<div class="org-src-container">
<pre class="src src-R">show_condition &lt;- function(code) {
  tryCatch(code,
    error = function(c) "error"
  )
}
show_condition(stop("!")) # evaluates to the string "error"
show_condition(10) # evalates to the numeric 10
</pre>
</div>
</div>
</div>

<div id="outline-container-org965c800" class="outline-3">
<h3 id="org965c800"><i>R Packages</i> by Wickham and Bryan</h3>
<div class="outline-text-3" id="text-org965c800">
<p>
There is a new edition of the <a href="https://r-pkgs.org/">R packages book available online</a>. Here are some
notes about package creation based on reading through that book. The <a href="https://cran.r-project.org/doc/manuals/R-exts.html#Top">Writing R
Extensions</a> book is the definitive reference, but <i>R Packages</i> is intended to be
more friendly for those getting started.
</p>
</div>

<div id="outline-container-orgaec6e93" class="outline-4">
<h4 id="orgaec6e93">Package development loop</h4>
<div class="outline-text-4" id="text-orgaec6e93">
<ol class="org-ol">
<li><code>library(devtools)</code></li>
<li><code>create_package("~/path/to/my/package")</code></li>
<li><code>use_git()</code></li>
<li>Edit the <code>DESCRIPTION</code></li>
<li><code>use_mit_license("Alexander E. Zarebski")</code></li>
<li><code>use_testthat()</code></li>
<li>Include the function <code>foo</code> in <code>R/foo.R</code></li>
<li><code>load_all()</code> to bring the functions into the REPL</li>
<li><code>use_test("foo")</code> to template a test for the <code>foo</code> function</li>
<li><code>test()</code> to run the tests</li>
<li><code>check()</code> to check the package works</li>
<li><code>document()</code></li>
<li>Commit the good stuff to git</li>
<li><code>install()</code> to install on the current machine</li>
<li>Profit</li>
<li><code>uninstall("&lt;package&gt;")</code> to uninstall <code>&lt;package&gt;</code></li>
</ol>
</div>
</div>

<div id="outline-container-org5e2aa01" class="outline-4">
<h4 id="org5e2aa01">Package dependencies</h4>
<div class="outline-text-4" id="text-org5e2aa01">
<p>
The <code>DESCRIPTION</code> file is the place to go!
<i>Hadley says:</i> use <del><code>use_package("foo", "bar")</code></del> to have <code>foo</code> and <code>bar</code> added to the dependencies of the package being developed.
The <code>devtools::use_packag</code> function has been deprecated in favour of <code>usethis::use_package</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">usethis::use_package("foo", "bar")
</pre>
</div>

<p>
The <code>DESCRIPTION</code> will now have the following entry added
</p>

<div class="org-src-container">
<pre class="src src-text">Imports:
    foo,
    bar
</pre>
</div>

<p>
If the package depends on a specific version of the package this can be added too.
</p>

<div class="org-src-container">
<pre class="src src-text">Imports:
    foo (&gt;= 0.2),
    bar (&gt;= 0.3.0.1)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbd9bf45" class="outline-4">
<h4 id="orgbd9bf45">Vignettes</h4>
<div class="outline-text-4" id="text-orgbd9bf45">
<p>
Create a template vignette with <code>usethis::use_vignette</code>.
There is an <a href="https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf">R Markdown Cheat Sheet</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org9fae96b" class="outline-3">
<h3 id="org9fae96b">High performance computing</h3>
<div class="outline-text-3" id="text-org9fae96b">
<p>
<a href="https://cran.r-project.org/view=HighPerformanceComputing">CRAN Task View for High Performance Computing</a>
</p>

<p>
The package <a href="https://cran.r-project.org/web/packages/furrr/furrr.pdf"><code>furrr</code></a> provides <code>purrr</code> style functions which run in parallel. See
the following snippet for an example
</p>

<div class="org-src-container">
<pre class="src src-R">library(future)
plan(multiprocess)

y &lt;- furrr::future_map(x, ~ f(.x))
</pre>
</div>

<p>
<b>WARNING</b> It looks like <code>furrr</code> will kick up a fuss if <code>f</code> attempts to perform
any IO. It's a good way to force the use of pure functions.
</p>
</div>
</div>

<div id="outline-container-orgd9d44b4" class="outline-3">
<h3 id="orgd9d44b4">Packages I like</h3>
<div class="outline-text-3" id="text-orgd9d44b4">
</div>
<div id="outline-container-org4f1a9de" class="outline-4">
<h4 id="org4f1a9de"><a href="https://cran.r-project.org/web/packages/ape/ape.pdf">ape</a> Analyses of Phylogenetics and Evolution</h4>
</div>
<div id="outline-container-org8a785f2" class="outline-4">
<h4 id="org8a785f2"><a href="https://cran.r-project.org/web/packages/deSolve/index.html">deSolve</a> Solvers for Initial Value Problems of Differential Equations</h4>
</div>
<div id="outline-container-orgd6d36ac" class="outline-4">
<h4 id="orgd6d36ac"><a href="https://cran.r-project.org/web/packages/lhs/vignettes/lhs_basics.html">lhs</a> Latin Hypercube Samples</h4>
<div class="outline-text-4" id="text-orgd6d36ac">
<ul class="org-ul">
<li><code>randomLHS(n,k)</code> generates \(n\) samples from \([0,1]^{k}\).</li>
</ul>
</div>
</div>
<div id="outline-container-org6616b58" class="outline-4">
<h4 id="org6616b58"><a href="https://cran.r-project.org/web/packages/magrittr/magrittr.pdf">magrittr</a> a forward pipe operator for R</h4>
<div class="outline-text-4" id="text-org6616b58">
<p>
There are many useful aliases exported by <code>magrittr</code>, the table below has some examples.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Alias</th>
<th scope="col" class="org-left">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>extract</code></td>
<td class="org-left"><code>`[`</code></td>
</tr>

<tr>
<td class="org-left"><code>extract2</code></td>
<td class="org-left"><code>`[[`</code></td>
</tr>

<tr>
<td class="org-left"><code>use_series</code></td>
<td class="org-left"><code>`$`</code></td>
</tr>

<tr>
<td class="org-left"><code>is_in</code></td>
<td class="org-left"><code>`%in%`</code></td>
</tr>

<tr>
<td class="org-left"><code>is_greater_than</code></td>
<td class="org-left"><code>`&gt;`</code></td>
</tr>

<tr>
<td class="org-left"><code>set_colnames</code></td>
<td class="org-left"><code>`colnames&lt;-`</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org2628d38" class="outline-4">
<h4 id="org2628d38"><a href="https://cran.r-project.org/web/packages/stringr/stringr.pdf">stringr</a> Simple, Consistent Wrappers for Common String Operations</h4>
</div>
<div id="outline-container-org8b21543" class="outline-4">
<h4 id="org8b21543"><a href="https://cran.r-project.org/web/packages/styler/styler.pdf">styler</a> Non-Invasive Pretty Printing of R Code</h4>
</div>
<div id="outline-container-org3cf951b" class="outline-4">
<h4 id="org3cf951b"><a href="https://cran.r-project.org/web/packages/testthat/testthat.pdf">testthat</a> Unit Testing for R</h4>
</div>
<div id="outline-container-orga531926" class="outline-4">
<h4 id="orga531926"><a href="https://cran.r-project.org/web/packages/truncnorm/truncnorm.pdf">truncnorm</a> Truncated Normal Distribution</h4>
</div>
</div>

<div id="outline-container-org64076ae" class="outline-3">
<h3 id="org64076ae">Reshaping dataframes with <code>reshape2</code></h3>
<div class="outline-text-3" id="text-org64076ae">
</div>
<div id="outline-container-orgb1df9e8" class="outline-4">
<h4 id="orgb1df9e8">Casting</h4>
<div class="outline-text-4" id="text-orgb1df9e8">
<p>
Casting is difficult, this figure made by <a href="https://seananderson.ca/2013/10/19/reshape/">Sean C. Anderson</a> helps
</p>


<div id="org666046b" class="figure">
<p><img src="../images/dcast-illustration.png" alt="dcast-illustration.png" width="700px" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org13455bb" class="outline-3">
<h3 id="org13455bb">Command line arguments</h3>
<div class="outline-text-3" id="text-org13455bb">
<p>
The simplest example is probably what you'll need most of the time
</p>

<div class="org-src-container">
<pre class="src src-R">## demo.R
args &lt;- commandArgs(trailingOnly = TRUE)
print(args)
</pre>
</div>

<p>
As an example consider the following command and output
</p>

<pre class="example">
$ Rscript demo.R 3 foo.csv
[1] "3"       "foo.csv"
</pre>

<p>
Be careful when passing in numbers because they are read in as strings.
</p>
</div>
</div>

<div id="outline-container-orgd1e3a81" class="outline-3">
<h3 id="orgd1e3a81">Command line arguments with <code>argparse</code></h3>
<div class="outline-text-3" id="text-orgd1e3a81">
<p>
See the <a href="https://cran.r-project.org/web/packages/argparse/vignettes/argparse.html">vignette</a>.
</p>

<div class="org-src-container">
<pre class="src src-R">library(argparse)

# create parser object
parser &lt;- ArgumentParser()

parser$add_argument(
         "-v",
         "--verbose",
         action = "store_true",
         default = FALSE,
         help = "Verbose output"
       )
parser$add_argument(
         "-s",
         "--seed",
         type = "integer",
         default = 1,
         help = "PRNG seed"
       )
parser$add_argument(
         "-p",
         "--parameters",
         type = "character",
         help = "Filepath to parameters JSON"
       )

args &lt;- parser$parse_args()
</pre>
</div>
</div>
</div>


<div id="outline-container-org2a934a3" class="outline-3">
<h3 id="org2a934a3">Working with JSON</h3>
<div class="outline-text-3" id="text-org2a934a3">
<p>
For parsing and encoding JSON there is the <code>jsonlite</code> package.
</p>

<p>
<b>WARNING:</b> by default <code>jsonlite::write_json</code> only uses 4 digits which is not
enough for many scientific applications, unless there is a good reason not to,
it is probably better to set <code>digits = 16</code>.
</p>
</div>

<div id="outline-container-org08b3a19" class="outline-4">
<h4 id="org08b3a19">Examples</h4>
<div class="outline-text-4" id="text-org08b3a19">
<div class="org-src-container">
<pre class="src src-R">library(jsonlite)
read_json(&lt;filepath&gt;)
write_json(&lt;object&gt;, &lt;filepath&gt;, pretty = TRUE)
</pre>
</div>

<p>
There are the <code>toJSON</code> and <code>fromJSON</code> functions but they are not needed most of
the time.
</p>
</div>
</div>
</div>

<div id="outline-container-orga07cf69" class="outline-3">
<h3 id="orga07cf69">Working with HTML</h3>
<div class="outline-text-3" id="text-orga07cf69">
<p>
There is the <code>htmltools</code> package for generating HTML in R.
</p>
</div>

<div id="outline-container-orga75abfb" class="outline-4">
<h4 id="orga75abfb">Example</h4>
<div class="outline-text-4" id="text-orga75abfb">
<div class="org-src-container">
<pre class="src src-R">library(htmltools)

my_html &lt;-
  tags$html(
         tags$head(tags$title("My Title")),
         tags$body(
                tags$h1("Hello"),
                tags$div(
                       tags$h3("Hello World"),
                       tags$img(src = "the-world.png"),
                       tags$p("What a wonderful world!")
                     )
              )
       )

save_html(
  doRenderTags(my_html),
  file = "world.html"
)
</pre>
</div>

<p>
produces the following HTML
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #3a81c3;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">html</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">meta</span> <span style="color: #715ab1;">charset</span>=<span style="color: #2d9574;">"utf-8"</span>/&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">style</span>&gt;body{background-color:white;}&lt;/<span style="color: #6c3163; font-weight: bold;">style</span>&gt;


&lt;/<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">html</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">My Title</span>&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">head</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">body</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Hello</span>&lt;/<span style="color: #6c3163; font-weight: bold;">h1</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">div</span>&gt;
      &lt;<span style="color: #6c3163; font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">Hello World</span>&lt;/<span style="color: #6c3163; font-weight: bold;">h3</span>&gt;
      &lt;<span style="color: #6c3163; font-weight: bold;">img</span> <span style="color: #715ab1;">src</span>=<span style="color: #2d9574;">"the-world.png"</span>/&gt;
      &lt;<span style="color: #6c3163; font-weight: bold;">p</span>&gt;What a wonderful world!&lt;/<span style="color: #6c3163; font-weight: bold;">p</span>&gt;
    &lt;/<span style="color: #6c3163; font-weight: bold;">div</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">body</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">html</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">html</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org58e3f7c" class="outline-4">
<h4 id="org58e3f7c">Example: embedding PNG as string in HTML</h4>
<div class="outline-text-4" id="text-org58e3f7c">
<p>
The following function is useful if you want to avoid referencing external files
in your HTML but still want to include figures.
</p>

<div class="org-src-container">
<pre class="src src-R">#' An HTML tag encoding an image stored in a PNG.
#'
#' This uses the \code{base64enc} and \code{htmltools} packages.
#'
#' @param filepath is the path to the PNG
#' @param ... is additional arguments to \code{tags$img} such as style.
#'
png_as_img &lt;- function(filepath, ...) {
  if (tools::file_ext(filepath) == "png") {
    b64 &lt;- base64enc::base64encode(what = filepath)
    tags$img(
           src = paste("data:image/png;base64", b64, sep = ","),
           ...
         )
  } else {
    stop("Filepath given to png_as_img must be a PNG.")
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge8f7930" class="outline-4">
<h4 id="orge8f7930">Example: including a table representation of a dataframe</h4>
<div class="outline-text-4" id="text-orge8f7930">
<div class="org-src-container">
<pre class="src src-R">#' An HTML tag encoding a data frame as a basic table.
#'
#' This uses the \code{xtable} package to generate the HTML for the table.
#'
#' @param df data.frame to create an table from
#' @param ... additional parameters for \code{xtable::xtable}.
#'
df_as_table &lt;- function(df, ...) {
  tmp_file &lt;- tempfile()
  print(xtable::xtable(df, ...),
        type = "html",
        file = tmp_file)
  return(tags$div(includeHTML(tmp_file)))
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org10288b7" class="outline-3">
<h3 id="org10288b7">OUTDATED: Working with XML with <code>XML</code></h3>
<div class="outline-text-3" id="text-org10288b7">
<p>
<b>NOTE:</b> It looks like <code>xml2</code> might be a better choice for XML work, please see <a href="#orga9af408">these notes</a> instead.
</p>
</div>

<div id="outline-container-orgcc9a84c" class="outline-4">
<h4 id="orgcc9a84c">Example I</h4>
<div class="outline-text-4" id="text-orgcc9a84c">
<p>
The following snippet produces a file <code>demo.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-R">library(XML)

kappa_node &lt;- xmlNode(
  "kappa",
  attrs = list(idref = "hky.kappa")
)

input_node &lt;- xmlNode(
  "input",
  kappa_node,
  attrs = list(spec = "HKY", id = "hky")
)

z &lt;- xmlNode(
  "beast",
  input_node,
  attrs = list(version = "2.0",
               namespace = "beast.core:beast.evolution.operators")
)

saveXML(
  z,
  file = "demo.xml",
  prefix = "&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;\n"
)
</pre>
</div>

<p>
And here is the result
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8" standalone="no"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">beast</span> <span style="color: #715ab1;">version</span>=<span style="color: #2d9574;">"2.0"</span> <span style="color: #715ab1;">namespace</span>=<span style="color: #2d9574;">"beast.core:beast.evolution.operators"</span>&gt;
 &lt;<span style="color: #6c3163; font-weight: bold;">input</span> <span style="color: #715ab1;">spec</span>=<span style="color: #2d9574;">"HKY"</span> <span style="color: #715ab1;">id</span>=<span style="color: #2d9574;">"hky"</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">kappa</span> <span style="color: #715ab1;">idref</span>=<span style="color: #2d9574;">"hky.kappa"</span>/&gt;
 &lt;/<span style="color: #6c3163; font-weight: bold;">input</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">beast</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c4cd28" class="outline-4">
<h4 id="org1c4cd28">Example II</h4>
<div class="outline-text-4" id="text-org1c4cd28">
<p>
Given an XML file, <code>demo.xml</code>, we can read that into a list-like object:
</p>

<div class="org-src-container">
<pre class="src src-R">library(XML)

xmlToList(xmlParse("demo.xml"))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge501d8c" class="outline-4">
<h4 id="orge501d8c">Example III</h4>
<div class="outline-text-4" id="text-orge501d8c">
<p>
We can read in the XML, edit one of the nodes by indexing into the object and
replacing it, and then write it back to another file.
</p>

<div class="org-src-container">
<pre class="src src-R">library(XML)

foo &lt;- xmlTreeParse("demo.xml")$doc$children

bappa_node &lt;- xmlNode(
  "bappa",
  attrs = list(idref = "hky.bappa")
)

foo[["beast"]][["input"]][["kappa"]] &lt;- bappa_node

saveXML(
  foo$beast, # &lt;-- need to specify the node.
  file = "demo-again.xml",
  prefix = "&lt;?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?&gt;\n"
)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc083bf3" class="outline-4">
<h4 id="orgc083bf3">Example IV</h4>
<div class="outline-text-4" id="text-orgc083bf3">
<p>
We can use <a href="https://www.w3schools.com/xml/xpath_syntax.asp">XPath syntax</a> to extract a particular node and then query its
attributes.
</p>

<div class="org-src-container">
<pre class="src src-R">foo &lt;- xmlTreeParse("demo.xml")$doc$children$beast
kappa_node &lt;- getNodeSet(foo, "//kappa[@idref='hky.kappa']")[[1]]
xmlGetAttr(kappa_node, "idref")
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org94e7bc6" class="outline-3">
<h3 id="org94e7bc6">Working with Mustache templates</h3>
<div class="outline-text-3" id="text-org94e7bc6">
</div>
<div id="outline-container-org24129ab" class="outline-4">
<h4 id="org24129ab">Example</h4>
<div class="outline-text-4" id="text-org24129ab">
<div class="org-src-container">
<pre class="src src-R">library(whisker)

template &lt;- readLines("./template.html")
data &lt;- list( name = "Chris"
            , value = 10000
            , taxed_value = 10000 - (10000 * 0.4)
            , in_ca = TRUE
            )

writeLines(whisker.render(template, data), "./output.html")
</pre>
</div>

<p>
where <code>template.html</code> might look like the following
</p>

<pre class="example">
Hello {{name}}
You have just won ${{value}}!
{{#in_ca}}
Well, ${{taxed_value}}, after taxes.
{{/in_ca}}
</pre>
</div>
</div>
</div>

<div id="outline-container-org8293f07" class="outline-3">
<h3 id="org8293f07">Unit testing with <code>testthat</code></h3>
<div class="outline-text-3" id="text-org8293f07">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Function</td>
<td class="org-left">Example</td>
</tr>

<tr>
<td class="org-left"><code>expect_true</code></td>
<td class="org-left"><code>expect_true(TRUE)</code></td>
</tr>

<tr>
<td class="org-left"><code>expect_equal</code></td>
<td class="org-left"><code>expect_equal(10.01, 10, tolerance = 0.02)</code></td>
</tr>

<tr>
<td class="org-left"><code>expect_error</code></td>
<td class="org-left"><code>expect_error(stop("Boo!"))</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org6f40c21" class="outline-3">
<h3 id="org6f40c21">Dependency management with <code>packrat</code></h3>
<div class="outline-text-3" id="text-org6f40c21">
<p>
Packrat is developed by the team at RStudio. It relies on the notion of a
<i>project</i>, which we might think of as a single analysis or collection of related
analyses. A project should live in a single directory.
</p>
</div>

<div id="outline-container-orgc2645f6" class="outline-4">
<h4 id="orgc2645f6">Usage</h4>
<div class="outline-text-4" id="text-orgc2645f6">
<p>
To start a packrat project use
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::init()
</pre>
</div>

<p>
This creates a directory <code>packrat</code> and a <code>.Rprofile</code> file. The profile file is
how R knows to use the private library rather than the shared one. There is a
file <code>packrat/packrat.lock</code> which contains the package details.
</p>

<p>
Packages are installed as usual with <code>install.packages</code>, but now they will be
stored in the private packrat library. Packages are not added to the
<code>packrat.lock</code> file until a <i>snapshot</i> of the current packages is made
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::snapshot()
</pre>
</div>

<p>
If you want a status report from packrat about how the packages there is
<code>packrat::status</code>. To install local packages, packrat needs to be told where
they live
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::set_opts(local.repos = "&lt;path/to/package&gt;")
</pre>
</div>

<p>
When moving a project between machines the installed packages will probably
break. However, the <code>packrat</code> directory stores copies of the source for each of
the packages so they can be <i>restored</i>.
</p>

<div class="org-src-container">
<pre class="src src-R">packrat::restore()
</pre>
</div>
</div>
</div>

<div id="outline-container-org0358272" class="outline-4">
<h4 id="org0358272">Version control</h4>
<div class="outline-text-4" id="text-org0358272">
<p>
The following files should be included into version control:
</p>

<ul class="org-ul">
<li><code>.gitignore</code> can contain <code>packrat/lib</code> and <code>packrat/src</code>.</li>
<li><code>.Rprofile</code></li>
<li><code>packrat/packrat.opts</code></li>
<li><code>packrat/packrat.lock</code></li>
</ul>

<p>
The following explaination of the directory structure is given in the
<a href="https://rstudio.github.io/packrat/walkthrough.html">walkthrough</a>
</p>

<blockquote>
<p>
A packrat project contains a few extra files and directories. The <code>init()</code>
function creates these files for you, if they don’t already exist.
</p>

<ul class="org-ul">
<li><code>packrat/packrat.lock</code>: Lists the precise package versions that were used to
satisfy dependencies, including dependencies of dependencies. (This file
should never be edited by hand!)</li>
<li><code>packrat/packrat.opts</code>: Project-specific packrat options. These can be queried
and set with <code>get_opts</code> and <code>set_opts</code>; see <code>?"packrat-options"</code> for more
information.</li>
<li><code>packrat/lib/</code>: Private package library for this project.</li>
<li><code>packrat/src/</code>: Source packages of all the dependencies that packrat has been
made aware of.</li>
<li><code>.Rprofile</code>: Directs R to use the private package library (when it is started
from the project directory).</li>
</ul>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org7c29a55" class="outline-3">
<h3 id="org7c29a55">Package and project management with <code>usethis</code></h3>
<div class="outline-text-3" id="text-org7c29a55">
<ul class="org-ul">
<li>Add dependencies to packages with <code>usethis::use_package</code> instead of
<code>devtools::use_package</code> which is now deprecated. It is the same deal with
<code>use_vignette</code>.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf7759e0" class="outline-3">
<h3 id="orgf7759e0">Date handling with <code>lubridate</code></h3>
<div class="outline-text-3" id="text-orgf7759e0">
<p>
You may think you don't need to use this, but you are probably wrong. It won't
take long before you need something that is painful to do in base date types,
you may as well start out using this. It's part of the tidyverse, so it's safe.
</p>
</div>
</div>

<div id="outline-container-org5386d35" class="outline-3">
<h3 id="org5386d35">String handling with <code>stringr</code></h3>
<div class="outline-text-3" id="text-org5386d35">
<p>
Strings are another place where the built-in support is sufficient, but
unpleasant to work with. The <code>stringr</code> package from the tidyverse makes this
much easier and is organised to work well with the modern piping style.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">function</th>
<th scope="col" class="org-left">use</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>str_detect</code></td>
<td class="org-left"><b>match</b> like <code>grepl</code></td>
</tr>

<tr>
<td class="org-left"><code>str_flatten</code></td>
<td class="org-left"><b>flatten</b> like <code>paste</code></td>
</tr>

<tr>
<td class="org-left"><code>str_interp</code></td>
<td class="org-left">string <b>interpolation</b> like <code>sprintf</code></td>
</tr>

<tr>
<td class="org-left"><code>str_replace</code></td>
<td class="org-left"><b>substitution</b> like <code>gsub</code></td>
</tr>

<tr>
<td class="org-left"><code>str_split</code></td>
<td class="org-left"><b>split</b> like <code>strsplit</code></td>
</tr>

<tr>
<td class="org-left"><code>str_subset</code></td>
<td class="org-left"><b>filters</b> strings like <code>grep</code></td>
</tr>

<tr>
<td class="org-left"><code>str_extract</code></td>
<td class="org-left"><b>extracts</b> pattern match</td>
</tr>

<tr>
<td class="org-left"><code>str_to_lower</code></td>
<td class="org-left">converts to lower case</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgca593b8" class="outline-3">
<h3 id="orgca593b8">Documentation with <code>roxygen2</code></h3>
<div class="outline-text-3" id="text-orgca593b8">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">style</th>
<th scope="col" class="org-left">markup</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">italics</td>
<td class="org-left"><code>\emph{}</code></td>
</tr>

<tr>
<td class="org-left">bold</td>
<td class="org-left"><code>\strong{}</code></td>
</tr>

<tr>
<td class="org-left">mono-spaced</td>
<td class="org-left"><code>\code{}</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org149d732" class="outline-3">
<h3 id="org149d732">Dates and times</h3>
<div class="outline-text-3" id="text-org149d732">
<p>
<code>as.Date</code> is your friend.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Code</th>
<th scope="col" class="org-left">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>%d</code></td>
<td class="org-left">Day (integer)</td>
</tr>

<tr>
<td class="org-left"><code>%m</code></td>
<td class="org-left">Month (integer)</td>
</tr>

<tr>
<td class="org-left"><code>%b</code></td>
<td class="org-left">Abbreviated month (string)</td>
</tr>

<tr>
<td class="org-left"><code>%B</code></td>
<td class="org-left">Month (string)</td>
</tr>

<tr>
<td class="org-left"><code>%y</code></td>
<td class="org-left">Year (2 digits)</td>
</tr>

<tr>
<td class="org-left"><code>%Y</code></td>
<td class="org-left">Year (4 digits)</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org68d6600" class="outline-3">
<h3 id="org68d6600"><code>Rmath.h</code></h3>
<div class="outline-text-3" id="text-org68d6600">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">  To compile and run this I used the following...</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ sudo apt update</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ sudo apt install r-mathlib</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ sudo apt install r-base-dev</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ gcc -o mathlibtest demo.c -lRmath -lm</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  $ ./mathlibtest</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MATHLIB_STANDALONE</span> <span style="color: #4e3163;">1</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"Rmath.h"</span>


<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">fib</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">n</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>n &lt; <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3;">return</span><span style="color: #2d9574;">(</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3;">else</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3;">return</span><span style="color: #2d9574;">(</span>fib<span style="color: #67b11d;">(</span>n-<span style="color: #4e3163;">1</span><span style="color: #67b11d;">)</span> + fib<span style="color: #67b11d;">(</span>n-<span style="color: #4e3163;">2</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">ac</span>, <span style="color: #ba2f59; font-weight: bold;">char</span>** <span style="color: #715ab1;">av</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">n</span>;
  <span style="color: #ba2f59; font-weight: bold;">double</span> <span style="color: #715ab1;">foo</span>;

  <span style="color: #3a81c3;">for</span> <span style="color: #6c3163;">(</span> n = <span style="color: #4e3163;">0</span>; n &lt; <span style="color: #4e3163;">10</span>; n = n + <span style="color: #4e3163;">1</span> <span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%d\n"</span>, fib<span style="color: #67b11d;">(</span>n<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    foo = dnorm<span style="color: #2d9574;">(</span><span style="color: #4e3163;">1.0</span>, <span style="color: #4e3163;">0.0</span>, <span style="color: #4e3163;">1.0</span>, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%f\n"</span>, foo<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"hello, %s\n"</span>, <span style="color: #2d9574;">"world"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org70c5394" class="outline-3">
<h3 id="org70c5394">Cheat sheets</h3>
<div class="outline-text-3" id="text-org70c5394">
<ul class="org-ul">
<li><a href="../resources/r-cheatsheet-regex.pdf">Regex cheatsheet for <code>stringr</code></a></li>
<li><a href="https://stuff.mit.edu/afs/athena/software/r/current/RStudio/resources/roxygen_help.html">roxygen(2)</a></li>
<li><a href="https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf">rmarkdown</a></li>
<li><a href="https://evoldyn.gitlab.io/evomics-2018/ref-sheets/R_purrr.pdf">purrr</a></li>
<li><a href="../resources/ess-cheat-sheet.pdf">ESS</a></li>
</ul>
</div>
</div>

<div id="outline-container-org3df83a7" class="outline-3">
<h3 id="org3df83a7">Data frames</h3>
<div class="outline-text-3" id="text-org3df83a7">
</div>
<div id="outline-container-orgc6f3950" class="outline-4">
<h4 id="orgc6f3950">Sorting rows of a data frame</h4>
<div class="outline-text-4" id="text-orgc6f3950">
<div class="org-src-container">
<pre class="src src-R">iris[order(iris$Sepal.Length),]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org546d441" class="outline-3">
<h3 id="org546d441">Data structures</h3>
<div class="outline-text-3" id="text-org546d441">
</div>
<div id="outline-container-orgac2d066" class="outline-4">
<h4 id="orgac2d066">Hashmap</h4>
<div class="outline-text-4" id="text-orgac2d066">
<p>
The environment builtin data structure can be used as a hashmap (since it hashes
by default), a.k.a. map, dictionary, loopkup&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-R">my_dict &lt;- new.env(hash = TRUE)
my_dict[["key"]] &lt;- 2
my_dict[["key"]] # will return 2.
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgeaa6ea0" class="outline-2">
<h2 id="orgeaa6ea0">Data munging</h2>
<div class="outline-text-2" id="text-orgeaa6ea0">
</div>
<div id="outline-container-orga9af408" class="outline-3">
<h3 id="orga9af408">Working with XML</h3>
<div class="outline-text-3" id="text-orga9af408">
<p>
The modern way for working with XML is via the <code>xml2</code> package.
</p>

<ul class="org-ul">
<li><code>read_xml</code> and <code>write_xml</code> for IO or start a new node from text.</li>
<li><code>xml_text</code> (and <code>xml_set_text</code>) to get the text out of a node (and to modify it).</li>
<li><code>xml_set_attr</code> to set attributes on a node. Note that if you want to set
multiple attributes in a single command there is the function <code>xml_set_attrs</code>
which takes a node and a named vector.</li>
<li><code>xml_add_child</code> to add a child node to a parent.</li>
</ul>
</div>

<div id="outline-container-org6a6df2f" class="outline-4">
<h4 id="org6a6df2f">Example I: creating a node and adding it to existing XML</h4>
<div class="outline-text-4" id="text-org6a6df2f">
<p>
Start with the following XML in <code>demo.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;J K. Rowling&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2005&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
        &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;29.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
    &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>

<p>
then run the following script
</p>

<div class="org-src-container">
<pre class="src src-R">library(xml2)

bs &lt;- read_xml("demo.xml")

new_book &lt;- read_xml("&lt;book&gt;&lt;title/&gt;&lt;author/&gt;&lt;year/&gt;&lt;price/&gt;&lt;/book&gt;")

xml_set_attr(
  x = xml_find_first(new_book, "//title"),
  attr = "lang",
  value = "en")
xml_set_text(
  x = xml_find_first(new_book, "//title"),
  value = "Nineteen Eighty-Four"
)
xml_set_text(
  x = xml_find_first(new_book, "//author"),
  value = "G Orwell"
)
xml_set_text(
  x = xml_find_first(new_book, "//year"),
  value = "1949"
)
xml_set_text(
  x = xml_find_first(new_book, "//price"),
  value = "8.99"
)

xml_add_child(bs, new_book)
write_xml(bs, "demo2.xml")
</pre>
</div>

<p>
to get the new file <code>demo2.xml</code>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;J K. Rowling&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2005&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;29.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;G Orwell&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;1949&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;8.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9972329" class="outline-4">
<h4 id="org9972329">Example II: swapping a node for a new one in existing XML</h4>
<div class="outline-text-4" id="text-org9972329">
<p>
Starting with <code>demo2.xml</code> from the <a href="#org6a6df2f">previous example</a>
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Harry Potter&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;J K. Rowling&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2005&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;29.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;G Orwell&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;1949&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;8.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>

<p>
we can use the script
</p>

<div class="org-src-container">
<pre class="src src-R">library(xml2)

bs &lt;- read_xml("demo2.xml")

new_cd &lt;- read_xml("&lt;cd&gt;&lt;title/&gt;&lt;artist/&gt;&lt;year/&gt;&lt;/cd&gt;")

xml_set_text(
  x = xml_find_first(new_cd, "//title"),
  value = "Lateralus"
)
xml_set_text(
  x = xml_find_first(new_cd, "//artist"),
  value = "Tool"
)
xml_set_text(
  x = xml_find_first(new_cd, "//year"),
  value = "2001"
)

old_book &lt;- xml_find_first(bs, "//book[title='Harry Potter']")
xml_replace(old_book, new_cd)
write_xml(bs, "demo3.xml")
</pre>
</div>

<p>
which produces <code>demo3.xml</code> shown below
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;?<span style="color: #3a81c3;">xml</span> <span style="color: #da8b55;">version="1.0" encoding="UTF-8"</span>?&gt;
&lt;<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">cd</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span>&gt;Lateralus&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">artist</span>&gt;Tool&lt;/<span style="color: #6c3163; font-weight: bold;">artist</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;2001&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">cd</span>&gt;
  &lt;<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">title</span> <span style="color: #715ab1;">lang</span>=<span style="color: #2d9574;">"en"</span>&gt;Nineteen Eighty-Four&lt;/<span style="color: #6c3163; font-weight: bold;">title</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">author</span>&gt;G Orwell&lt;/<span style="color: #6c3163; font-weight: bold;">author</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">year</span>&gt;1949&lt;/<span style="color: #6c3163; font-weight: bold;">year</span>&gt;
    &lt;<span style="color: #6c3163; font-weight: bold;">price</span>&gt;8.99&lt;/<span style="color: #6c3163; font-weight: bold;">price</span>&gt;
  &lt;/<span style="color: #6c3163; font-weight: bold;">book</span>&gt;
&lt;/<span style="color: #6c3163; font-weight: bold;">bookstore</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2769ed" class="outline-4">
<h4 id="orgb2769ed">Example III: A helpful function for getting and setting attributes</h4>
<div class="outline-text-4" id="text-orgb2769ed">
<p>
The functions in this snippet allows you to look up a node with XPath syntax and
then read one of the attributes or set its value. There is an optional argument
in the former to get the value returned as a numeric.
</p>

<div class="org-src-container">
<pre class="src src-R">#' Find the first matching node and return the named attribute
#'
#' @param x the XML document
#' @param xp the xpath
#' @param the attribute
#' @param as_numeric boolean for casting to numeric (default is FALSE)
#'
xml_find_attr &lt;- function(x, xp, attr, as_numeric=FALSE) {
  a &lt;- xml_attr(xml_find_first(x, xpath = xp), attr)
  if (!as_numeric) {
    a
  } else {
    as.numeric(a)
  }
}

#' Find the first matching node and set the named attribute
#'
#' @param x the XML document
#' @param xp the xpath
#' @param attr the attribute
#' @param v the value for the attribute
#'
xml_find_set_attr &lt;- function(x, xp, attr, v) {
  n &lt;- xml_find_first(x, xpath = xp)
  xml_set_attr(n, attr, v)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb52625c" class="outline-4">
<h4 id="orgb52625c">Example IV: linting/formatting/beautifying XML</h4>
<div class="outline-text-4" id="text-orgb52625c">
<p>
If you have the <code>js-beautify</code> node package installed, the following function will
lint a file in place.
</p>

<div class="org-src-container">
<pre class="src src-R">#' Format an XML file in place using js-beautify
#'
#' @param x is the filepath
#'
beautify_xml &lt;- function(x) {
  system2(command = "html-beautify", args = c("-f", x, "-r"))
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org03bc624" class="outline-3">
<h3 id="org03bc624">Joins</h3>
<div class="outline-text-3" id="text-org03bc624">
<p>
There are several ways to join data frames using <code>dplyr</code>, the folling snippet
demonstrates a full join which duplicates records where necessary and will fill
in missing values. Although the data in the joined data frame does not depend on
the order of the arguments, the ordering of the rows does.
</p>

<div class="org-src-container">
<pre class="src src-R">foo &lt;- data.frame(x = 1:3, y = letters[1:3])
bar &lt;- data.frame(x = c(2:4,2:4), z = LETTERS[1:6])
dplyr::full_join(foo,bar)
</pre>
</div>

<pre class="example">
Joining, by = "x"
  x    y    z
1 1    a &lt;NA&gt;
2 2    b    A
3 2    b    D
4 3    c    B
5 3    c    E
6 4 &lt;NA&gt;    C
7 4 &lt;NA&gt;    F
</pre>
</div>
</div>

<div id="outline-container-orgea3b22d" class="outline-3">
<h3 id="orgea3b22d">Aggregation</h3>
<div class="outline-text-3" id="text-orgea3b22d">
<div class="org-src-container">
<pre class="src src-R">aggregate(formula = Petal.Length ~ Species, FUN = mean, data = iris)
</pre>
</div>

<p>
is equivalent to
</p>

<div class="org-src-container">
<pre class="src src-R">library(dplyr)
iris %&gt;%
  group_by(Species) %&gt;%
  summarise(mean_petal_length = mean(Petal.Length))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdcb2b47" class="outline-2">
<h2 id="orgdcb2b47">Programming in R (language and evaluation)</h2>
<div class="outline-text-2" id="text-orgdcb2b47">
</div>
<div id="outline-container-org24f613e" class="outline-3">
<h3 id="org24f613e">Recommended reading</h3>
<div class="outline-text-3" id="text-org24f613e">
<ul class="org-ul">
<li><a href="https://www.r-bloggers.com/2019/07/bang-bang-how-to-program-with-dplyr/">Bang Bang - How to program with dplyr</a> (explains quotation stuff for dyplr)</li>
<li><a href="https://www.r-bloggers.com/2019/06/curly-curly-the-successor-of-bang-bang-2/">Curly-Curly, the successor of Bang-Bang</a> (new rlang syntax for extending dplyr)</li>
</ul>
</div>
</div>

<div id="outline-container-org2ab2491" class="outline-3">
<h3 id="org2ab2491">Functional programming support</h3>
<div class="outline-text-3" id="text-org2ab2491">
<div class="org-src-container">
<pre class="src src-R">library(magrittr)
library(purrr)
</pre>
</div>

<p>
Here is a mapping between common functions in Haskell and their approximate
analogue in R. These are mainly for use with lists of vectors.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Haskell</th>
<th scope="col" class="org-left">R (package)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>all</code></td>
<td class="org-left"><code>all</code></td>
</tr>

<tr>
<td class="org-left"><code>filter</code></td>
<td class="org-left"><code>keep</code> and <code>discard</code> (<code>purrr</code>)</td>
</tr>

<tr>
<td class="org-left"><code>map</code></td>
<td class="org-left"><code>map</code> (<code>purrr</code>)</td>
</tr>

<tr>
<td class="org-left"><code>scanl</code></td>
<td class="org-left"><code>accumulate</code> (<code>purrr</code>)</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org97e8558" class="outline-4">
<h4 id="org97e8558"><span class="todo TODO">TODO</span> Built-in functionality</h4>
<div class="outline-text-4" id="text-org97e8558">
<ul class="org-ul">
<li><code>|&gt;</code> pipes with <code>_</code> for named arguments.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge5c70df" class="outline-3">
<h3 id="orge5c70df">R/Haskell Prelude</h3>
<div class="outline-text-3" id="text-orge5c70df">
<div class="org-src-container">
<pre class="src src-R">## See https://hackage.haskell.org/package/base-4.15.0.0/docs/Prelude.html#v:dropWhile
drop_while &lt;- function(p, xs) {
  if (length(xs) == 0) {
    xs
  } else {
    x &lt;- head(xs, 1)
    remaining &lt;- tail(xs, -1)
    if (p(x)) {
      drop_while(p, remaining)
    } else {
      remaining
    }
  }
}

## See https://hackage.haskell.org/package/base-4.15.0.0/docs/Prelude.html#v:takeWhile
take_while &lt;- function(p, xs) {
  if (length(xs) == 0) {
    xs
  } else {
    x &lt;- head(xs, 1)
    remaining &lt;- tail(xs, -1)
    if (p(x)) {
      c(x, take_while(p, remaining))
    } else {
      c()
    }
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org6650134" class="outline-3">
<h3 id="org6650134">Program flow and control</h3>
<div class="outline-text-3" id="text-org6650134">
</div>
<div id="outline-container-org6ddb4cb" class="outline-4">
<h4 id="org6ddb4cb">Ternary operator</h4>
<div class="outline-text-4" id="text-org6ddb4cb">
<div class="org-src-container">
<pre class="src src-R">ifelse(test, yes, no)
</pre>
</div>
</div>
</div>

<div id="outline-container-org37f17de" class="outline-4">
<h4 id="org37f17de">Switch/case/which</h4>
<div class="outline-text-4" id="text-org37f17de">
<div class="org-src-container">
<pre class="src src-R">centre &lt;- function(x, type) {
  switch(type,
         mean = mean(x),
         median = median(x),
         trimmed = mean(x, trim = .1))
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org937941b" class="outline-3">
<h3 id="org937941b">Numbers</h3>
<div class="outline-text-3" id="text-org937941b">
<ul class="org-ul">
<li><code>options(digits = 20)</code> will cause the REPL to start printing 20 digits of the
number.</li>
<li><code>ceiling</code> <code>floor</code> and <code>round</code> behave as expected.</li>
<li><code>signif</code> (significant figures) and <code>round</code> have a <code>digits</code> argument which can
be used to specify the number of digits to use.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf9a9eb5" class="outline-3">
<h3 id="orgf9a9eb5">Metaprogramming and nonstandard evaluation</h3>
<div class="outline-text-3" id="text-orgf9a9eb5">
<p>
The following snippet demonstrates how to get the value of a variable given a string containing its symbol.
There is a synonym <code>as.name</code> which derives from S terminology while "symbol" is LISP lingo.
</p>

<div class="org-src-container">
<pre class="src src-R">a &lt;- 1
eval(as.symbol("a"))
</pre>
</div>

<p>
This doesn't seem to work unless you have string literals.
Instead we can do the following
</p>

<div class="org-src-container">
<pre class="src src-R"># this has a syntax error
data.frame(letters[1] = 2)

# this works!
eval(parse(text = sprintf("data.frame(%s = 2)", letters[1])))
</pre>
</div>
</div>

<div id="outline-container-org5190cc0" class="outline-4">
<h4 id="org5190cc0">Local aliases</h4>
<div class="outline-text-4" id="text-org5190cc0">
<p>
The <code>with</code> function provides a way to define local variables based on a data frame
or list, etc.
</p>

<div class="org-src-container">
<pre class="src src-R">with(mtcars, mpg[cyl == 8  &amp;  disp &gt; 350])
# is the same as, but nicer than
mtcars$mpg[mtcars$cyl == 8  &amp;  mtcars$disp &gt; 350]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdddc300" class="outline-3">
<h3 id="orgdddc300">Object-oriented programming</h3>
<div class="outline-text-3" id="text-orgdddc300">
</div>
<div id="outline-container-org02587db" class="outline-4">
<h4 id="org02587db">S3</h4>
<div class="outline-text-4" id="text-org02587db">
<ul class="org-ul">
<li>You can use the <code>methods</code> function which takes the name of a class as an argument to find a list of the methods available for that class.</li>
</ul>
</div>
</div>

<div id="outline-container-org2e4dcbe" class="outline-4">
<h4 id="org2e4dcbe">R6 system</h4>
<div class="outline-text-4" id="text-org2e4dcbe">
<ul class="org-ul">
<li>R6 classes are a popular way to bring traditional OOP to R, they have reference semantics.</li>
<li>R6 is available on CRAN</li>
<li>The <code>R6Class</code> function is used to declare classes, the (public) <code>initialize</code> function is used to create instances of this class with <code>$new</code>.</li>
<li><code>self</code> is available within the class to describe the current object.</li>
<li>Assignment of fields is done with <code>&lt;-</code> e.g., <code>self$foo &lt;- "bar"</code></li>
<li>Returning <code>self</code> invisibly (<code>invisible(self)</code>) makes methods <i>chainable</i>.</li>
<li>Active bindings are a way to carry out side effects when assigning values which has a syntax which looks like you are just assigning to a field.</li>
<li>Fields containing reference objects should be set in the <code>initialize</code> method unless you want the object to be shared across all instances of the class.</li>
<li>By default, objects get a <code>clone</code> method, which is shallow; deep cloning can be achieved by passing <code>deep=TRUE</code>.</li>
<li>There was a <a href="https://github.com/r-lib/R6/issues/82#issue-133982435">request for interfaces in R6</a>, however Hadley suggested that this departed from the very minimalist goals of R6 so it will not be implemented.</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org6542a9d" class="outline-2">
<h2 id="org6542a9d">Statistics with R</h2>
<div class="outline-text-2" id="text-org6542a9d">
</div>
<div id="outline-container-org1c02152" class="outline-3">
<h3 id="org1c02152">Linear regression <code>lm</code></h3>
<div class="outline-text-3" id="text-org1c02152">
<p>
<a href="./statistics-notes.html">NOTES</a>
</p>
</div>
</div>

<div id="outline-container-org990e9a5" class="outline-3">
<h3 id="org990e9a5">Zero-inflated regression</h3>
<div class="outline-text-3" id="text-org990e9a5">
<p>
The following snippet demonstrates how to perform a zero-inflated Poisson
regression.
</p>

<div class="org-src-container">
<pre class="src src-R">library(pscl)
library(boot)
set.seed(1)

n &lt;- 1000
x1 &lt;- rnorm(n = n)
x2 &lt;- rnorm(n = n)
z1 &lt;- rnorm(n = n)
z2 &lt;- rnorm(n = n)
true_prob_zinf &lt;- inv.logit(2 * z1 + 0 * z2)
zero_inflation &lt;- rbernoulli(n = n,
                             p = true_prob_zinf)

true_count_means &lt;- exp(2 * x1 - 1 * x2 + 1)
maybe_count &lt;- rpois(n = n,
                     lambda = true_count_means)

y &lt;- ifelse(zero_inflation, 0, maybe_count)

df &lt;- data.frame(y = y,
                 x1 = x1,
                 x2 = x2,
                 z1 = z1,
                 z2 = z2)

my_zinb &lt;- zeroinfl(formula = y ~ x1 + x2 | z1 + z2,
                    data = df, dist = "poisson")

true_mean &lt;- true_prob_zinf * 0 + (1 - true_prob_zinf) * true_count_means

plot(log(true_mean), log(fitted(my_zinb)))
abline(0,1)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge771747" class="outline-3">
<h3 id="orge771747"><span class="todo TODO">TODO</span> Mathematical optimisation</h3>
<div class="outline-text-3" id="text-orge771747">
<p>
<a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/nlm.html"><code>nlm</code></a>
</p>
</div>
</div>

<div id="outline-container-org764bd73" class="outline-3">
<h3 id="org764bd73">Computational geography and cartography</h3>
<div class="outline-text-3" id="text-org764bd73">
<p>
See <a href="./computational-geography-notes.html">my other notes on this</a>.
</p>
</div>
</div>

<div id="outline-container-org6a3c896" class="outline-3">
<h3 id="org6a3c896">Differential equations with <code>deSolve</code></h3>
<div class="outline-text-3" id="text-org6a3c896">
</div>
<div id="outline-container-org39b0ea1" class="outline-4">
<h4 id="org39b0ea1">Basic SIR example</h4>
<div class="outline-text-4" id="text-org39b0ea1">
<p>
Simple SIR model
</p>

<p>
\[
\frac{ds}{dt} = -\beta s i \quad\text{and}\quad \frac{di}{dt} = \beta s i - \gamma i.
\]
</p>

<p>
The following demonstrates how to solve this system with <code>deSolve</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">library(deSolve)

sir_diff &lt;- function(time, state, params) {
    with(as.list(c(params, state)), {
        ds &lt;- - beta * susceptible * infectious
        di &lt;- beta * susceptible * infectious - gamma * infectious
        list(c(ds, di))
    })
}

params &lt;- c(beta = 1.2, gamma = 1)
state &lt;- c(susceptible = 0.99, infectious = 0.01)
times &lt;- seq(from = 0, to = 20, length = 100)
pd &lt;- matrix(nrow = 2, ncol = 2, data = 0)
out1 &lt;- deSolve::ode(state, times, sir_diff, parms = params)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge17b32c" class="outline-4">
<h4 id="orge17b32c">SIR example with C implementation</h4>
<div class="outline-text-4" id="text-orge17b32c">
<p>
Then we can implement the differential in C as
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">file sirmod.c</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">R.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3;">static</span> <span style="color: #ba2f59; font-weight: bold;">double</span> <span style="color: #715ab1;">params</span><span style="color: #3a81c3;">[</span><span style="color: #4e3163;">2</span><span style="color: #3a81c3;">]</span>;
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">beta</span> params<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">0</span><span style="color: #3a81c3;">]</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">gamma</span> params<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">1</span><span style="color: #3a81c3;">]</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">initializer</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">initmod</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163;">(</span>* <span style="color: #6c3163; font-weight: bold;">odeparams</span><span style="color: #6c3163;">)(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">N</span>=<span style="color: #4e3163;">2</span>;
  odeparams<span style="color: #6c3163;">(</span>&amp;N, params<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Derivatives and 1 output variable</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">derivs</span> <span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">neq</span>, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">t</span>, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">y</span>, <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">ydot</span>,
             <span style="color: #ba2f59; font-weight: bold;">double</span> *<span style="color: #715ab1;">yout</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">ip</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3;">if</span> <span style="color: #6c3163;">(</span>ip<span style="color: #2d9574;">[</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">]</span> &lt;<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> error<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"nout should be at least 1"</span><span style="color: #6c3163;">)</span>;
  ydot<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span> = -beta*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span>*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span>;
  ydot<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> = beta*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span>*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> - gamma*y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span>;
  yout<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span> = <span style="color: #4e3163;">1.0</span>-y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">]</span>+y<span style="color: #6c3163;">[</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">END file sirmod.c</span><span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
</pre>
</div>

<p>
Then we need to compile this and load the object for use of <code>deSovle</code>
</p>

<div class="org-src-container">
<pre class="src src-R">system("R CMD SHLIB sirmod.c")
dyn.load("sirmod.so")
out2 &lt;- deSolve::ode(state, times, func = "derivs", parms = params,
                     dllname = "sirmod", initfunc = "initmod", nout = 1,
                     outnames = "recovered")
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2a3e3e0" class="outline-3">
<h3 id="org2a3e3e0">MCMC (without <code>Stan</code>)</h3>
<div class="outline-text-3" id="text-org2a3e3e0">
<p>
There is the package <code>mcmc</code> which looks like it does a solid job of the basics,
although it takes an opinionated stance on how this should be done. Be careful
with how you interpret the <code>batch</code> arguments. The interface is designed for
testing out tuning parameters to find something that works; make the most of
this design.
</p>

<p>
<a href="https://cran.r-project.org/web/packages/coda/coda.pdf"><code>coda</code></a> is probably what you want to use to check the output beyond basic
diagnostic plots.
</p>
</div>

<div id="outline-container-orgdc3b353" class="outline-4">
<h4 id="orgdc3b353">Thinning (destructive)</h4>
<div class="outline-text-4" id="text-orgdc3b353">
<p>
This snippet demonstrates how to subset a data frame. It is a destructive
change, but since MCMC samples can be large you may not want the additional cost
of creating a copy.
</p>

<div class="org-src-container">
<pre class="src src-R">demo_df &lt;- data.frame(x = 1:100, y = rnorm(100))

## take every third sample
thinning_factor &lt;- 3

demo_df &lt;- demo_df[seq(from = 1, to = nrow(demo_df), by = thinning_factor), ]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge5ea2d5" class="outline-3">
<h3 id="orge5ea2d5">(Nonparametric) density estimation with <code>KernSmooth</code></h3>
<div class="outline-text-3" id="text-orge5ea2d5">
<p>
Here is an example looking at how to use <code>KernSmooth</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">library(KernSmooth)

set.seed(1)

x &lt;- c(rpois(n = 500, lambda=10),
       rpois(n = 500, lambda = 30))

f_x &lt;- function(x, ...) {
  0.5 * (dpois(x = x, lambda = 10, ...) +
         dpois(x = x, lambda = 30, ...))
}

x_mesh &lt;- 0:100
y_mesh &lt;- f_x(x_mesh)


kde_obj &lt;- bkde(x, bandwidth = 3, range.x = c(0,100), gridsize = 101)

r_kde_samples &lt;- sample(x = kde_obj$x,
                       size = length(x),
                       replace = TRUE,
                       prob = pmax(0, kde_obj$y))

type_char &lt;- c("true", "estimate")

density_df &lt;- data.frame(x = c(x_mesh, x_mesh),
                         y = c(y_mesh, pmax(0, kde_obj$y)),
                         type = rep(type_char, each = 101))

sample_df &lt;- data.frame(x = c(x, r_kde_samples),
                        type = rep(type_char,
                                   each = length(x)))

ggplot() +
  geom_histogram(data = sample_df,
                 mapping = aes(x = x, y = ..density.., fill = type),
                 bins = 25,
                 size = 3,
                 position = "dodge") +
  geom_line(data = density_df,
            mapping = aes(x = x, y = y, colour = type))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbccc8c0" class="outline-2">
<h2 id="orgbccc8c0">Miscellaneous functions</h2>
<div class="outline-text-2" id="text-orgbccc8c0">
</div>
<div id="outline-container-orgca493cc" class="outline-3">
<h3 id="orgca493cc">Step function</h3>
<div class="outline-text-3" id="text-orgca493cc">
</div>
<div id="outline-container-org6610d2b" class="outline-4">
<h4 id="org6610d2b">Step function construction</h4>
<div class="outline-text-4" id="text-org6610d2b">
<p>
The following snippet defines a vectorised step function.
</p>

<div class="org-src-container">
<pre class="src src-R">#' Return a vectorised step function.
#'
#' @param ts the times at which there is a step.
#' @param vs the value of the function at the step.
#'
step_function_factory &lt;- function(ts, vs) {
  n &lt;- length(ts)
  if (n &lt; 1) {
    stop("need at least one step time.")
  }
  if (length(vs) != (1 + n)) {
    stop("if there are n step times there must be n+1 values.")
  }

  step_func &lt;- function(x) {
    m &lt;- length(x)
    y &lt;- numeric(m)
    mask &lt;- logical(m)
    mask &lt;- x &lt; ts[1]
    y[mask] &lt;- vs[1]
    if (n &gt; 1) {
      for (ix in seq.int(2, n)) {
        mask &lt;- (ts[ix-1] &lt;= x) &amp; (x &lt; ts[ix])
        y[mask] &lt;- vs[ix]
      }
    }
    mask &lt;- x &gt;= ts[n]
    y[mask] &lt;- vs[n+1]
    return(y)
  }

  return(
    list(
      func = step_func,
      times = ts,
      values = vs
    )
  )
}
</pre>
</div>

<p>
Here is a demonstration of it in action producing Figure <a href="#orga49b2ad">X</a>
</p>

<div class="org-src-container">
<pre class="src src-R">t1s &lt;- c(2.0, 3.0)
v1s &lt;- c(3.0, 2.5, 3.5)
demo1 &lt;- step_function_factory(t1s, v1s)
t2s &lt;- c(1.0)
v2s &lt;- c(1.0, 2.0)
demo2 &lt;- step_function_factory(t2s, v2s)

x &lt;- seq(from = 0, to = 4, length = 200)
y1 &lt;- demo1$func(x)
y2 &lt;- demo2$func(x)

png('step-function-demo.png',
    width = 1.618 * 300,
    height = 300,
    units = "px")
plot(x, y1, 'l', col = 'black', ylab = "", ylim = c(0.5, 3.5))
lines(x, y2, col = 'black')
points(t1s, demo1$func(t1s), col = 'blue', cex = 3, pch = 16)
points(t1s, demo1$func(t1s - 1e-10), col = 'red', cex = 3, pch = 1)
points(t2s, demo2$func(t2s), col = 'blue', cex = 3, pch = 16)
points(t2s, demo2$func(t2s - 1e-10), col = 'red', cex = 3, pch = 1)
dev.off()
</pre>
</div>


<div id="orga49b2ad" class="figure">
<p><img src="../images/step-function-demo.png" alt="step-function-demo.png" width="400px" />
</p>
<p><span class="figure-number">Figure 1: </span>Example of step function result.</p>
</div>
</div>
</div>

<div id="outline-container-org435ad5b" class="outline-4">
<h4 id="org435ad5b">Applying binary functions to step functions</h4>
<div class="outline-text-4" id="text-org435ad5b">
<p>
The class of step functions is closed under the point-wise application of binary
functions. What? This means if you have two functions \(f(x)\) and \(g(x)\)
which are step functions, then \(h(x) := f(x) + g(x) \) is also a step function,
and more generally \(h^{F}(x) := F(f(x), g(x))\) is a step function given some
binary function \(F\). This can be implemented as follows
</p>

<div class="org-src-container">
<pre class="src src-R">#' Return a vectorised step function resulting from the point-wise application
#' of a binary function to two step functions.
#'
#' @param step_func_a a step function (see \code{step_function_factory}.)
#' @param step_func_b a step function (see \code{step_function_factory}.)
#' @param binary_func a binary function.
#'
map_step_function &lt;- function(step_func_a, step_func_b, binary_func) {
  times_c &lt;- sort(union(step_func_a$times, step_func_b$times))
  n &lt;- length(times_c)
  values_c &lt;- numeric(n + 1)
  values_c[1] &lt;- binary_func(
    step_func_a$func(step_func_a$times[1] - 1),
    step_func_b$func(step_func_b$times[1] - 1)
  )
  for (ix in seq.int(n)) {
    values_c[ix+1] &lt;- binary_func(
      step_func_a$func(times_c[ix]),
      step_func_b$func(times_c[ix])
    )
  }
  return(step_function_factory(times_c, values_c))
}
</pre>
</div>

<p>
Here is a demonstration of it in action producing Figure [[fig:step-function-binary][Y]
</p>

<div class="org-src-container">
<pre class="src src-R">demo3 &lt;- map_step_function(demo1, demo2, function(x, y) { x / y })
y3 &lt;- demo3$func(x)

png('step-function-binary-demo.png',
    width = 1.618 * 300,
    height = 300,
    units = "px")
plot(x, y3, 'l', col = 'black', ylab = "")
points(t3s, demo3$func(t3s), col = 'blue', cex = 3, pch = 16)
points(t3s, demo3$func(t3s - 1e-10), col = 'red', cex = 3, pch = 1)
dev.off()
</pre>
</div>


<div id="orgccc230c" class="figure">
<p><img src="../images/step-function-binary-demo.png" alt="step-function-binary-demo.png" width="400px" />
</p>
<p><span class="figure-number">Figure 2: </span>The result of combining two step functions.</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf0c6901" class="outline-3">
<h3 id="orgf0c6901">Number of lines in a file</h3>
<div class="outline-text-3" id="text-orgf0c6901">
<p>
The <code>num_lines_in_file</code> function returns the number of lines in a file which is
useful to help guard against attempting to parse an empty file with <code>read.csv</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">num_lines_in_file &lt;- function(fp) {
  wc_stdout &lt;- system2(command = "wc", args = c("-l", fp), stdout = TRUE)
  as.numeric(head(unlist(strsplit(x = wc_stdout, split = " ")),1))
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f87986" class="outline-3">
<h3 id="org1f87986">Julian day of the year</h3>
<div class="outline-text-3" id="text-org1f87986">
<div class="org-src-container">
<pre class="src src-R">#' Julian day of the year
#'
#' &gt; j_day("2014-01-03", "2014-01-01")
#' 3
j_day &lt;- function(date_string, first_day_of_year_string) {
  as.integer(as.Date(date_string) - as.Date(first_day_of_year_string)) + 1
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge244fb4" class="outline-2">
<h2 id="orge244fb4">Further reading</h2>
<div class="outline-text-2" id="text-orge244fb4">
</div>
<div id="outline-container-org03666b1" class="outline-3">
<h3 id="org03666b1">Articles</h3>
<div class="outline-text-3" id="text-org03666b1">
<ul class="org-ul">
<li><a href="https://doi.org/10.1371/journal.pcbi.1009884"><i>Ten simple rules for finding and selecting R packages</i></a></li>
</ul>
</div>
</div>

<div id="outline-container-org2068dcf" class="outline-3">
<h3 id="org2068dcf">Blogs</h3>
<div class="outline-text-3" id="text-org2068dcf">
<ul class="org-ul">
<li><a href="https://rviews.rstudio.com/about/">R Views</a> (the RStudio blog about R).</li>
</ul>
</div>
</div>

<div id="outline-container-org6cb8af5" class="outline-3">
<h3 id="org6cb8af5">Books</h3>
<div class="outline-text-3" id="text-org6cb8af5">
<ul class="org-ul">
<li><a href="https://r4ds.hadley.nz/index.html">R for Data Science</a> by Hadley Wickham has a second (and substantially expanded)
edition.</li>
</ul>
</div>
</div>

<div id="outline-container-org48499cd" class="outline-3">
<h3 id="org48499cd">Documentation</h3>
<div class="outline-text-3" id="text-org48499cd">
<ul class="org-ul">
<li><a href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R Extensions</a></li>
<li><a href="https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-R.html">R Source Code Blocks in Org Mode</a></li>
</ul>
</div>
</div>

<div id="outline-container-org2d4f823" class="outline-3">
<h3 id="org2d4f823">Curated packages</h3>
<div class="outline-text-3" id="text-org2d4f823">
<ul class="org-ul">
<li><a href="https://cran.r-project.org/web/views/">CRAN Task Views</a></li>
<li><a href="https://www.bioconductor.org/packages/release/BiocViews.html">BioConductor BiocViews</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alexander E. Zarebski</p>
<p class="date">Created: 2023-04-06 Thu 18:27</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>