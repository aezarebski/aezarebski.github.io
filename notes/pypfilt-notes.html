<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-08-28 Mon 16:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>pypfilt-notes</title>
<meta name="author" content="Alexander E. Zarebski" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link id="stylesheet" rel="stylesheet" type="text/css" href="../css/stylesheet.css" />
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">pypfilt-notes</h1>
<p>
<a href="../index.html">Home</a>
</p>


<div id="org5c7dda9" class="figure">
<p><img src="../images/pypfilt-logo.png" alt="pypfilt-logo.png" width="250px" />
</p>
</div>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0d9250f">Pypfilt</a></li>
<li><a href="#org51da6d9">Terminology</a></li>
<li><a href="#orgb51cf18">Examples: birth-death process</a>
<ul>
<li><a href="#noisy-count-obs-model">Observation model</a></li>
<li><a href="#tau-leap-bd">Tau-leaping birth-death</a></li>
<li><a href="#ode-bd">ODE birth-death</a></li>
<li><a href="#ctmc-bd">CTMC birth-death</a></li>
</ul>
</li>
<li><a href="#org34c603d">Colophon</a></li>
</ul>
</div>
</div>

<div id="outline-container-org0d9250f" class="outline-2">
<h2 id="org0d9250f">Pypfilt</h2>
<div class="outline-text-2" id="text-org0d9250f">
<ul class="org-ul">
<li><a href="https://pypfilt.readthedocs.io/en/0.8.0/">Pypfilt documentation 0.8.0</a></li>
<li><a href="https://bitbucket.org/robmoss/particle-filter-for-python/src/master/">Pypfilt on Bitbucket</a></li>
</ul>


<div id="org56b179b" class="figure">
<p><img src="./pypfilt/pypfilt-class-diagram.png" alt="pypfilt-class-diagram.png" width="950px" />
</p>
<p><span class="figure-number">Figure 1: </span>A class diagram showing the main classes that a user will interact with when using <code>pypfilt</code> along with the classes that are used in the examples on this page.</p>
</div>
</div>
</div>

<div id="outline-container-org51da6d9" class="outline-2">
<h2 id="org51da6d9">Terminology</h2>
<div class="outline-text-2" id="text-org51da6d9">
<dl class="org-dl">
<dt><i>observation model</i></dt><dd>the distribution of a random variable (e.g.,
the measured population size) given the state (e.g., the true
population.)</dd>
<dt><i>process model</i></dt><dd>a stochastic process for the state, e.g., how the
population size changes through time.</dd>
<dt><i>scenario</i></dt><dd>a description of a simulation or an inference problem,
e.g., estimating the birth rate and the future population sizes.
Think: "an imagined sequence of events."</dd>
</dl>
</div>
</div>

<div id="outline-container-orgb51cf18" class="outline-2">
<h2 id="orgb51cf18">Examples: birth-death process</h2>
<div class="outline-text-2" id="text-orgb51cf18">
<p>
We can model the birth-death process in a number of ways:
</p>

<ul class="org-ul">
<li>with <a href="#tau-leap-bd">Tau-leaping</a>;</li>
<li>with <a href="#ode-bd">ODEs</a>;</li>
<li>and as a <a href="#ctmc-bd">CTMC</a>.</li>
</ul>

<p>
For each example, we will consider observations with Poisson noise
about the true state. The observation model is described with the
<a href="#noisy-count-obs-model">NoisyCount</a> observation distribution.
</p>
</div>

<div id="outline-container-noisy-count-obs-model" class="outline-3">
<h3 id="noisy-count-obs-model">Observation model</h3>
<div class="outline-text-3" id="text-noisy-count-obs-model">
<p>
As stated above, we will assume Poisson noise about the true value of
the state. This is implemented as the <code>NoisyCount</code> class. This class
will be used with each of the different process representations.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">NoisyCount.py</span>

&lt;&lt;imports&gt;&gt;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">NoisyCount</span>(pypfilt.obs.Univariate):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">distribution</span>(<span style="color: #0000FF;">self</span>, ctx, snapshot):
        <span style="color: #BA36A5;">expected_value</span> = snapshot.state_vec[<span style="color: #008000;">'x'</span>]
        <span style="color: #0000FF;">return</span> scipy.stats.poisson(mu=expected_value)
</pre>
</div>
</div>
</div>

<div id="outline-container-tau-leap-bd" class="outline-3">
<h3 id="tau-leap-bd">Tau-leaping birth-death</h3>
<div class="outline-text-3" id="text-tau-leap-bd">
<p>
Consider an approximation of the birth-death process using
\(\tau\)-leaping. The following example demonstrates how to simulate
from this process and run a forecast to estimate both the future state
and the birth rate (assuming a known death rate and initial
condition).
</p>
</div>

<div id="outline-container-org69affb7" class="outline-4">
<h4 id="org69affb7">Process model</h4>
<div class="outline-text-4" id="text-org69affb7">
<p>
We start by defining a model for this process using \(\tau\)-leaping.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">TauLeapBirthDeathProcess.py</span>

&lt;&lt;imports&gt;&gt;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">TauLeapBirthDeathProcess</span>(pypfilt.model.Model):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">field_types</span>(<span style="color: #0000FF;">self</span>, ctx):
        <span style="color: #0000FF;">return</span> [(<span style="color: #008000;">'birth'</span>, np.dtype(<span style="color: #006FE0;">float</span>)),
                (<span style="color: #008000;">'death'</span>, np.dtype(<span style="color: #006FE0;">float</span>)),
                (<span style="color: #008000;">'x'</span>, np.dtype(<span style="color: #006FE0;">int</span>))]

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">update</span>(<span style="color: #0000FF;">self</span>, ctx, time_step, is_fs, prev, curr):
        <span style="color: #036A07;">"""Destructively update the current state."""</span>
        <span style="color: #BA36A5;">rnd</span> = ctx.component[<span style="color: #008000;">'random'</span>][<span style="color: #008000;">'model'</span>]
        <span style="color: #BA36A5;">net_rate</span> = (prev[<span style="color: #008000;">'birth'</span>] - prev[<span style="color: #008000;">'death'</span>]) * time_step.dt * prev[<span style="color: #008000;">'x'</span>]
        <span style="color: #BA36A5;">curr</span>[<span style="color: #008000;">'birth'</span>] = prev[<span style="color: #008000;">'birth'</span>]
        <span style="color: #BA36A5;">curr</span>[<span style="color: #008000;">'death'</span>] = prev[<span style="color: #008000;">'death'</span>]
        <span style="color: #BA36A5;">curr</span>[<span style="color: #008000;">'x'</span>] = prev[<span style="color: #008000;">'x'</span>] + rnd.poisson(lam=net_rate, size=curr[<span style="color: #008000;">'x'</span>].shape)
</pre>
</div>

<p>
Note that in the <code>update</code> method we need to destructively update
<code>curr</code> to contain the new value. I.e., <code>curr</code> should be considered a
reference to the state, this avoids needing to make a copy of this
data.
</p>
</div>
</div>

<div id="outline-container-org8b81f10" class="outline-4">
<h4 id="org8b81f10">Scenario file</h4>
<div class="outline-text-4" id="text-org8b81f10">
<p>
The simulation and estimation computations are specified with a TOML
file <code>approx-bd-example.toml</code>.
</p>

<div class="org-src-container">
<pre class="src src-toml">[<span style="color: #6434A3;">metadata</span>]
<span style="color: #BA36A5;">name</span> = <span style="color: #008000;">"Tau leap birth-death example"</span>
<span style="color: #BA36A5;">filename</span> = <span style="color: #008000;">"tau-leap-bd-example.toml"</span>
<span style="color: #BA36A5;">author</span> = <span style="color: #008000;">"Alexander E. Zarebski"</span>
<span style="color: #BA36A5;">date</span> = <span style="color: #008000;">"2023-07-25"</span>

[<span style="color: #6434A3;">components</span>]
<span style="color: #BA36A5;">model</span> = <span style="color: #008000;">"TauLeapBirthDeathProcess.TauLeapBirthDeathProcess"</span>
<span style="color: #BA36A5;">time</span> = <span style="color: #008000;">"pypfilt.Scalar"</span>
<span style="color: #BA36A5;">sampler</span> = <span style="color: #008000;">"pypfilt.sampler.LatinHypercube"</span>
<span style="color: #BA36A5;">summary</span> = <span style="color: #008000;">"pypfilt.summary.HDF5"</span>

[<span style="color: #6434A3;">time</span>]
<span style="color: #BA36A5;">start</span> = 0.0
<span style="color: #BA36A5;">until</span> = 5.0
<span style="color: #BA36A5;">steps_per_unit</span> = 10
<span style="color: #BA36A5;">summaries_per_unit</span> = 2

[<span style="color: #6434A3;">prior</span>]
<span style="color: #BA36A5;">death</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 1.0 }
<span style="color: #BA36A5;">x</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 1 }

[<span style="color: #6434A3;">observations.x</span>]
<span style="color: #BA36A5;">model</span> = <span style="color: #008000;">"NoisyCount.NoisyCount"</span>
<span style="color: #BA36A5;">file</span> = <span style="color: #008000;">"tau-leap-bd-example-x.ssv"</span>

[<span style="color: #6434A3;">filter</span>]
<span style="color: #BA36A5;">particles</span> = 10000
<span style="color: #BA36A5;">prng_seed</span> = 42
<span style="color: #BA36A5;">history_window</span> = -1
<span style="color: #BA36A5;">resample.threshold</span> = 0.25
<span style="color: #BA36A5;">regularisation.enabled</span> = <span style="color: #0000FF;">true</span>

[<span style="color: #6434A3;">scenario.simulate</span>]
<span style="color: #BA36A5;">prior.birth</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 2.0 }

[<span style="color: #6434A3;">scenario.forecast</span>]
<span style="color: #BA36A5;">summary.tables.model_cints.component</span> = <span style="color: #008000;">"pypfilt.summary.ModelCIs"</span>
<span style="color: #BA36A5;">summary.tables.model_cints.credible_intervals</span> = [ 0, 25, 50, 75, 95 ]
<span style="color: #BA36A5;">summary.tables.forecasts.component</span> = <span style="color: #008000;">"pypfilt.summary.PredictiveCIs"</span>
<span style="color: #BA36A5;">summary.tables.forecasts.credible_intervals</span> = [10, 20, 40, 80]
<span style="color: #BA36A5;">prior.birth</span> = { name = <span style="color: #008000;">"uniform"</span>, args.loc = 1.0, args.scale = 3.0 }
<span style="color: #BA36A5;">backcast_time</span> = 0.0
<span style="color: #BA36A5;">forecast_time</span> = 4.0

[<span style="color: #6434A3;">output</span>]
<span style="color: #BA36A5;">credible_intervals</span> = <span style="color: #008000;">"demo-tau-leap-bd-cris.ssv"</span>
<span style="color: #BA36A5;">estimate_plot</span> = <span style="color: #008000;">"tau-leap-bd-posterior-estimates.png"</span>
<span style="color: #BA36A5;">forecast_plot</span> = <span style="color: #008000;">"tau-leap-bd-posterior-forecasts.png"</span>
</pre>
</div>

<p>
Note, apart from <code>scenario.simulate</code> and <code>scenario.forecast</code>, all the
configuration is shared between the two tasks. The process model and
observation model needs to be described with <b>both</b> the module and the
class within it.
</p>

<p>
The specification of the prior distributions appears to take the
location as the right end of the uniform distribution and the scale is
the width of the uniform distribution. This may not be wildly
intuitive, but bear in mind that there are sophisticated options for
specifying a prior distribution available.
</p>
</div>
</div>

<div id="outline-container-orga9d9f28" class="outline-4">
<h4 id="orga9d9f28">Main script</h4>
<div class="outline-text-4" id="text-orga9d9f28">
<p>
Here is the main script that runs the simulation and estimation.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">tau-leap-bd-example.py</span>

&lt;&lt;imports&gt;&gt;
&lt;&lt;plotting-imports&gt;&gt;

<span style="color: #BA36A5;">scenario_file</span> = <span style="color: #008000;">'tau-leap-bd-example.toml'</span>
<span style="color: #BA36A5;">instances</span> = <span style="color: #006FE0;">list</span>(pypfilt.load_instances(scenario_file))
<span style="color: #BA36A5;">sim_instance</span> = instances[0]
<span style="color: #BA36A5;">my_time_scale</span> = sim_instance.time_scale()
<span style="color: #BA36A5;">my_obs_tables</span> = pypfilt.simulate_from_model(sim_instance)

<span style="color: #0000FF;">for</span> (obs_unit, obs_table) <span style="color: #0000FF;">in</span> my_obs_tables.items():
    <span style="color: #BA36A5;">out_file</span> = f<span style="color: #008000;">'tau-leap-bd-example-</span>{obs_unit}<span style="color: #008000;">.ssv'</span>
    pypfilt.io.write_table(out_file, obs_table, my_time_scale)
</pre>
</div>

<p>
To run the forecasts on the simulated data we have the following
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">fst_instance</span> = instances[1]
<span style="color: #BA36A5;">backcast_time</span> = fst_instance.settings[<span style="color: #008000;">'backcast_time'</span>]
<span style="color: #BA36A5;">forecast_time</span> = fst_instance.settings[<span style="color: #008000;">'forecast_time'</span>]
<span style="color: #BA36A5;">context</span> = fst_instance.build_context()
<span style="color: #BA36A5;">results</span> = pypfilt.forecast(context, [forecast_time], filename=<span style="color: #D0372D;">None</span>)
</pre>
</div>

<p>
We can generate a plot of the forecast values, and the estimate of the
historical states of the process.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">fit</span> = results.estimation.tables[<span style="color: #008000;">'forecasts'</span>]
<span style="color: #BA36A5;">forecast</span> = results.forecasts[forecast_time].tables[<span style="color: #008000;">'forecasts'</span>]
<span style="color: #BA36A5;">credible_intervals</span> = np.concatenate((
    fit[fit[<span style="color: #008000;">'time'</span>] &gt;= backcast_time],
    forecast))

<span style="color: #BA36A5;">cri_df</span> = pd.DataFrame(credible_intervals)
<span style="color: #BA36A5;">cri_df</span> = cri_df.assign(prob = cri_df[<span style="color: #008000;">'prob'</span>])
<span style="color: #BA36A5;">obs_df</span> = pd.read_csv(<span style="color: #008000;">'tau-leap-bd-example-x.ssv'</span>, sep=<span style="color: #008000;">' '</span>)
<span style="color: #BA36A5;">obs_df</span> = obs_df[obs_df[<span style="color: #008000;">'time'</span>] &gt;= backcast_time]
<span style="color: #BA36A5;">obs_df</span> = obs_df.assign(observed = obs_df[<span style="color: #008000;">'time'</span>] &lt;= forecast_time)

<span style="color: #BA36A5;">fs_p9</span> = (ggplot()
         + geom_ribbon(data = cri_df,
                       mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                     ymin = <span style="color: #008000;">"ymin"</span>,
                                     ymax = <span style="color: #008000;">"ymax"</span>,
                                     group = <span style="color: #008000;">"prob"</span>),
                       alpha = 0.2)
         + scale_x_continuous(name = <span style="color: #008000;">"Time"</span>)
         + scale_y_sqrt(name = <span style="color: #008000;">"Population size"</span>)
         + geom_point(data = obs_df,
                      mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                    y = <span style="color: #008000;">"value"</span>,
                                    shape = <span style="color: #008000;">"observed"</span>),
                      size = 3,
                      colour = <span style="color: #008000;">"red"</span>)
         + scale_shape_manual(values = {<span style="color: #D0372D;">True</span>: <span style="color: #008000;">'o'</span>, <span style="color: #D0372D;">False</span>: <span style="color: #008000;">'x'</span>})
         + geom_vline(xintercept = forecast_time,
                      linetype = <span style="color: #008000;">"dashed"</span>)
         + labs(title = <span style="color: #008000;">"Population size forecast"</span>)
         + theme_bw()
         + theme(legend_position = <span style="color: #008000;">"none"</span>))

fs_p9.save(instances[1].settings[<span style="color: #008000;">'output'</span>][<span style="color: #008000;">'forecast_plot'</span>],
           height = 4.1, width = 5.8)
</pre>
</div>

<p>
Here are the <a href="#orgf1efed2">results</a> of the particle filter.
</p>


<div id="orgf1efed2" class="figure">
<p><img src="./pypfilt/tau-leap-bd-posterior-forecasts.png" alt="tau-leap-bd-posterior-forecasts.png" width="400px" />
</p>
<p><span class="figure-number">Figure 2: </span>Forecast of birth-death process</p>
</div>

<p>
We can also generate a plot of how the posterior distribution
converges on the true value of the parameter as the amount of data
available increases.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">param_cris_df</span> = pd.DataFrame(results.estimation.tables[<span style="color: #008000;">'model_cints'</span>])
<span style="color: #BA36A5;">param_cris_df</span> = param_cris_df[param_cris_df[<span style="color: #008000;">'name'</span>] == <span style="color: #008000;">'birth'</span>]
<span style="color: #BA36A5;">param_cris_df</span>[<span style="color: #008000;">'prob'</span>] = pd.Categorical(
    param_cris_df[<span style="color: #008000;">'prob'</span>],
    categories=param_cris_df[<span style="color: #008000;">'prob'</span>].unique(),
    ordered=<span style="color: #D0372D;">True</span>
)
<span style="color: #BA36A5;">pt_est_mask</span> = param_cris_df[<span style="color: #008000;">'prob'</span>] == 0

<span style="color: #BA36A5;">br_p9</span> = (ggplot()
         + geom_ribbon(data = param_cris_df,
                       mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                     ymin = <span style="color: #008000;">"ymin"</span>,
                                     ymax = <span style="color: #008000;">"ymax"</span>,
                                     group = <span style="color: #008000;">"prob"</span>),
                       alpha = 0.2,
                       size = 1)
         + geom_line(data = param_cris_df[pt_est_mask],
                     mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                   y = <span style="color: #008000;">"ymin"</span>))
         + geom_hline(yintercept = 2.0, linetype = <span style="color: #008000;">"dashed"</span>, colour = <span style="color: #008000;">"red"</span>)
         + scale_x_continuous(name = <span style="color: #008000;">"Amount of data used"</span>)
         + scale_y_continuous(name = <span style="color: #008000;">"Birth rate"</span>)
         + labs(title = <span style="color: #008000;">"Birth rate credible intervals"</span>)
         + theme_bw())

br_p9.save(instances[1].settings[<span style="color: #008000;">'output'</span>][<span style="color: #008000;">'estimate_plot'</span>],
           height = 4.1, width = 5.8)
</pre>
</div>

<p>
Here are the <a href="#orgf641899">results</a> of the particle filter.
</p>


<div id="orgf641899" class="figure">
<p><img src="./pypfilt/tau-leap-bd-posterior-estimates.png" alt="tau-leap-bd-posterior-estimates.png" width="400px" />
</p>
<p><span class="figure-number">Figure 3: </span>Forecast of birth-death process</p>
</div>
</div>
</div>
</div>

<div id="outline-container-ode-bd" class="outline-3">
<h3 id="ode-bd">ODE birth-death</h3>
<div class="outline-text-3" id="text-ode-bd">
<p>
Consider an approximation of the birth-death process using a
differential equation.
</p>
</div>

<div id="outline-container-orgb18cf22" class="outline-4">
<h4 id="orgb18cf22">Process model</h4>
<div class="outline-text-4" id="text-orgb18cf22">
<p>
We start by defining a model for this process which is adapted from
<a href="https://pypfilt.readthedocs.io/en/0.8.0/how-to/index.html#implement-an-ordinary-differential-equation-ode-model">this example</a>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">ODEBirthDeathProcess.py</span>

&lt;&lt;imports&gt;&gt;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">ODEBirthDeathProcess</span>(pypfilt.model.OdeModel):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">field_types</span>(<span style="color: #0000FF;">self</span>, ctx):
        <span style="color: #0000FF;">return</span> [(<span style="color: #008000;">'birth'</span>, np.dtype(<span style="color: #006FE0;">float</span>)),
                (<span style="color: #008000;">'death'</span>, np.dtype(<span style="color: #006FE0;">float</span>)),
                (<span style="color: #008000;">'x'</span>, np.dtype(<span style="color: #006FE0;">float</span>))]

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">init</span>(<span style="color: #0000FF;">self</span>, ctx, vec):
        <span style="color: #BA36A5;">prior</span> = ctx.data[<span style="color: #008000;">'prior'</span>]
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'x'</span>] = prior[<span style="color: #008000;">'x'</span>]
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'birth'</span>] = prior[<span style="color: #008000;">'birth'</span>]
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'death'</span>] = prior[<span style="color: #008000;">'death'</span>]
        <span style="color: #0000FF;">self</span>.<span style="color: #BA36A5;">method</span> = <span style="color: #008000;">'RK45'</span>

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">d_dt</span>(<span style="color: #0000FF;">self</span>, time, xt, ctx, is_forecast):
        <span style="color: #BA36A5;">d_dt</span> = np.zeros(xt.shape, dtype=xt.dtype)
        <span style="color: #BA36A5;">d_dt</span>[<span style="color: #008000;">'x'</span>] = (xt[<span style="color: #008000;">'birth'</span>] - xt[<span style="color: #008000;">'death'</span>]) * xt[<span style="color: #008000;">'x'</span>]
        <span style="color: #0000FF;">return</span> d_dt
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc282cd7" class="outline-4">
<h4 id="orgc282cd7">Scenario file</h4>
<div class="outline-text-4" id="text-orgc282cd7">
<p>
The simulation and estimation computations are specified with a TOML
file <code>ode-bd-example.toml</code>.
</p>

<div class="org-src-container">
<pre class="src src-toml">[<span style="color: #6434A3;">metadata</span>]
<span style="color: #BA36A5;">name</span> = <span style="color: #008000;">"ODE birth-death example"</span>
<span style="color: #BA36A5;">filename</span> = <span style="color: #008000;">"ode-bd-example.toml"</span>
<span style="color: #BA36A5;">author</span> = <span style="color: #008000;">"Alexander E. Zarebski"</span>
<span style="color: #BA36A5;">date</span> = <span style="color: #008000;">"2023-07-27"</span>

[<span style="color: #6434A3;">components</span>]
<span style="color: #BA36A5;">model</span> = <span style="color: #008000;">"ODEBirthDeathProcess.ODEBirthDeathProcess"</span>
<span style="color: #BA36A5;">time</span> = <span style="color: #008000;">"pypfilt.Scalar"</span>
<span style="color: #BA36A5;">sampler</span> = <span style="color: #008000;">"pypfilt.sampler.LatinHypercube"</span>
<span style="color: #BA36A5;">summary</span> = <span style="color: #008000;">"pypfilt.summary.HDF5"</span>

[<span style="color: #6434A3;">time</span>]
<span style="color: #BA36A5;">start</span> = 0.0
<span style="color: #BA36A5;">until</span> = 5.0
<span style="color: #BA36A5;">steps_per_unit</span> = 10
<span style="color: #BA36A5;">summaries_per_unit</span> = 2

[<span style="color: #6434A3;">prior</span>]
<span style="color: #BA36A5;">death</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 1.0 }
<span style="color: #BA36A5;">x</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 1 }

[<span style="color: #6434A3;">observations.x</span>]
<span style="color: #BA36A5;">model</span> = <span style="color: #008000;">"NoisyCount.NoisyCount"</span>
<span style="color: #BA36A5;">file</span> = <span style="color: #008000;">"ode-bd-example-x.ssv"</span>

[<span style="color: #6434A3;">filter</span>]
<span style="color: #BA36A5;">particles</span> = 10000
<span style="color: #BA36A5;">prng_seed</span> = 13
<span style="color: #BA36A5;">history_window</span> = -1
<span style="color: #BA36A5;">resample.threshold</span> = 0.25
<span style="color: #BA36A5;">regularisation.enabled</span> = <span style="color: #0000FF;">true</span>

[<span style="color: #6434A3;">scenario.simulate</span>]
<span style="color: #BA36A5;">prior.birth</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 2.0 }

[<span style="color: #6434A3;">scenario.forecast</span>]
<span style="color: #BA36A5;">summary.tables.model_cints.component</span> = <span style="color: #008000;">"pypfilt.summary.ModelCIs"</span>
<span style="color: #BA36A5;">summary.tables.model_cints.credible_intervals</span> = [ 0, 25, 50, 75, 95 ]
<span style="color: #BA36A5;">summary.tables.forecasts.component</span> = <span style="color: #008000;">"pypfilt.summary.PredictiveCIs"</span>
<span style="color: #BA36A5;">summary.tables.forecasts.credible_intervals</span> = [10, 20, 40, 80]
<span style="color: #BA36A5;">prior.birth</span> = { name = <span style="color: #008000;">"uniform"</span>, args.loc = 1.75, args.scale = 0.5 }
<span style="color: #BA36A5;">backcast_time</span> = 2.0
<span style="color: #BA36A5;">forecast_time</span> = 4.0

[<span style="color: #6434A3;">output</span>]
<span style="color: #BA36A5;">credible_intervals</span> = <span style="color: #008000;">"demo-ode-bd-cris.ssv"</span>
<span style="color: #BA36A5;">estimate_plot</span> = <span style="color: #008000;">"ode-bd-posterior-estimates.png"</span>
<span style="color: #BA36A5;">forecast_plot</span> = <span style="color: #008000;">"ode-bd-posterior-forecasts.png"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1b44fd0" class="outline-4">
<h4 id="org1b44fd0">Main script</h4>
<div class="outline-text-4" id="text-org1b44fd0">
<p>
Here is the main script that runs the simulation and estimation.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">ode-bd-example.py</span>

&lt;&lt;imports&gt;&gt;
&lt;&lt;plotting-imports&gt;&gt;

<span style="color: #BA36A5;">scenario_file</span> = <span style="color: #008000;">'ode-bd-example.toml'</span>
<span style="color: #BA36A5;">instances</span> = <span style="color: #006FE0;">list</span>(pypfilt.load_instances(scenario_file))
<span style="color: #BA36A5;">sim_instance</span> = instances[0]
<span style="color: #BA36A5;">my_time_scale</span> = sim_instance.time_scale()
<span style="color: #BA36A5;">my_obs_tables</span> = pypfilt.simulate_from_model(sim_instance)

<span style="color: #0000FF;">for</span> (obs_unit, obs_table) <span style="color: #0000FF;">in</span> my_obs_tables.items():
    <span style="color: #BA36A5;">out_file</span> = f<span style="color: #008000;">'ode-bd-example-</span>{obs_unit}<span style="color: #008000;">.ssv'</span>
    pypfilt.io.write_table(out_file, obs_table, my_time_scale)

</pre>
</div>

<p>
To run the forecasts on the simulated data we have the following
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">fst_instance</span> = instances[1]
<span style="color: #BA36A5;">backcast_time</span> = fst_instance.settings[<span style="color: #008000;">'backcast_time'</span>]
<span style="color: #BA36A5;">forecast_time</span> = fst_instance.settings[<span style="color: #008000;">'forecast_time'</span>]
<span style="color: #BA36A5;">context</span> = fst_instance.build_context()
<span style="color: #BA36A5;">results</span> = pypfilt.forecast(context, [forecast_time], filename=<span style="color: #D0372D;">None</span>)
</pre>
</div>

<p>
Then finally we can generate a plot showing both the future forecasted
values, but also the estiamte of the historical states of the process.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">fit</span> = results.estimation.tables[<span style="color: #008000;">'forecasts'</span>]
<span style="color: #BA36A5;">forecast</span> = results.forecasts[forecast_time].tables[<span style="color: #008000;">'forecasts'</span>]
<span style="color: #BA36A5;">credible_intervals</span> = np.concatenate((
    fit[fit[<span style="color: #008000;">'time'</span>] &gt;= backcast_time],
    forecast))

<span style="color: #BA36A5;">cri_df</span> = pd.DataFrame(credible_intervals)
<span style="color: #BA36A5;">cri_df</span> = cri_df.assign(prob = cri_df[<span style="color: #008000;">'prob'</span>])
<span style="color: #BA36A5;">obs_df</span> = pd.read_csv(<span style="color: #008000;">'ode-bd-example-x.ssv'</span>, sep=<span style="color: #008000;">' '</span>)
<span style="color: #BA36A5;">obs_df</span> = obs_df[obs_df[<span style="color: #008000;">'time'</span>] &gt;= backcast_time]
<span style="color: #BA36A5;">obs_df</span> = obs_df.assign(observed = obs_df[<span style="color: #008000;">'time'</span>] &lt;= forecast_time)

<span style="color: #BA36A5;">fs_p9</span> = (ggplot()
         + geom_ribbon(data = cri_df,
                       mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                     ymin = <span style="color: #008000;">"ymin"</span>,
                                     ymax = <span style="color: #008000;">"ymax"</span>,
                                     group = <span style="color: #008000;">"prob"</span>,
                                     fill = <span style="color: #008000;">"prob"</span>),
                       alpha = 0.5)
         + scale_fill_gradient(low = <span style="color: #008000;">"white"</span>, high = <span style="color: #008000;">"black"</span>)
         + scale_x_continuous(name = <span style="color: #008000;">"Time"</span>)
         + scale_y_continuous(name = <span style="color: #008000;">"Population size"</span>)
         + geom_point(data = obs_df,
                      color = <span style="color: #008000;">"red"</span>,
                      mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                    y = <span style="color: #008000;">"value"</span>,
                                    shape = <span style="color: #008000;">"observed"</span>),
                      size = 3)
         + scale_shape_manual(values = {<span style="color: #D0372D;">True</span>: <span style="color: #008000;">'o'</span>, <span style="color: #D0372D;">False</span>: <span style="color: #008000;">'x'</span>})
         + geom_vline(xintercept = forecast_time,
                      linetype = <span style="color: #008000;">"dashed"</span>)
         + labs(title = <span style="color: #008000;">"Population size forecast"</span>)
         + theme_bw()
         + theme(legend_position = <span style="color: #008000;">"none"</span>))

<span style="color: #BA36A5;">png_plot_fn</span> = instances[1].settings[<span style="color: #008000;">'output'</span>][<span style="color: #008000;">'forecast_plot'</span>]
<span style="color: #BA36A5;">pdf_plot_fn</span> = png_plot_fn.replace(<span style="color: #008000;">"png"</span>, <span style="color: #008000;">"pdf"</span>)
p9.save_as_pdf_pages([fs_p9], filename = pdf_plot_fn)
<span style="color: #0000FF;">import</span> os
os.system(f<span style="color: #008000;">"convert -density 300 </span>{pdf_plot_fn}<span style="color: #008000;"> </span>{png_plot_fn}<span style="color: #008000;">"</span>)
os.remove(pdf_plot_fn)
</pre>
</div>

<p>
Here are the <a href="#org051efbf">results</a> of the particle filter (with the code to create
the figure below).
</p>


<div id="org051efbf" class="figure">
<p><img src="./pypfilt/ode-bd-example.png" alt="ode-bd-example.png" width="400px" />
</p>
<p><span class="figure-number">Figure 4: </span>Forecast of birth-death process</p>
</div>

<p>
We can also generate a plot of how the posterior distribution
converges on the true value of the parameter as the amount of data
available increases.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">param_cris_df</span> = pd.DataFrame(results.estimation.tables[<span style="color: #008000;">'model_cints'</span>])
<span style="color: #BA36A5;">param_cris_df</span> = param_cris_df[param_cris_df[<span style="color: #008000;">'name'</span>] == <span style="color: #008000;">'birth'</span>]
<span style="color: #BA36A5;">param_cris_df</span>[<span style="color: #008000;">'prob'</span>] = pd.Categorical(
    param_cris_df[<span style="color: #008000;">'prob'</span>],
    categories=param_cris_df[<span style="color: #008000;">'prob'</span>].unique(),
    ordered=<span style="color: #D0372D;">True</span>
)
<span style="color: #BA36A5;">pt_est_mask</span> = param_cris_df[<span style="color: #008000;">'prob'</span>] == 0

<span style="color: #BA36A5;">br_ests_p9</span> = (ggplot()
              + geom_ribbon(data = param_cris_df,
                            mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                          ymin = <span style="color: #008000;">"ymin"</span>,
                                          ymax = <span style="color: #008000;">"ymax"</span>,
                                          group = <span style="color: #008000;">"prob"</span>),
                            alpha = 0.2,
                            size = 1)
              + geom_line(data = param_cris_df[pt_est_mask],
                          mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                        y = <span style="color: #008000;">"ymin"</span>))
              + geom_hline(yintercept = 2.0, linetype = <span style="color: #008000;">"dashed"</span>)
              + scale_x_continuous(name = <span style="color: #008000;">"Amount of data used"</span>)
              + scale_y_continuous(name = <span style="color: #008000;">"Birth rate"</span>)
              + labs(title = <span style="color: #008000;">"Birth rate credible intervals"</span>)
              + theme_bw())

<span style="color: #BA36A5;">png_plot_fn</span> = instances[1].settings[<span style="color: #008000;">'output'</span>][<span style="color: #008000;">'estimate_plot'</span>]
<span style="color: #BA36A5;">pdf_plot_fn</span> = png_plot_fn.replace(<span style="color: #008000;">"png"</span>, <span style="color: #008000;">"pdf"</span>)
p9.save_as_pdf_pages([br_ests_p9], filename = pdf_plot_fn)
<span style="color: #0000FF;">import</span> os
os.system(f<span style="color: #008000;">"convert -density 300 </span>{pdf_plot_fn}<span style="color: #008000;"> </span>{png_plot_fn}<span style="color: #008000;">"</span>)
os.remove(pdf_plot_fn)
</pre>
</div>

<p>
Here are the <a href="#org1405532">results</a> of the particle filter.
</p>


<div id="org1405532" class="figure">
<p><img src="./pypfilt/ode-bd-posterior-estimates.png" alt="ode-bd-posterior-estimates.png" width="400px" />
</p>
<p><span class="figure-number">Figure 5: </span>Forecast of birth-death process</p>
</div>
</div>
</div>
</div>

<div id="outline-container-ctmc-bd" class="outline-3">
<h3 id="ctmc-bd">CTMC birth-death</h3>
<div class="outline-text-3" id="text-ctmc-bd">
<p>
Consider the birth-death process modelled with a CTMC.
</p>
</div>

<div id="outline-container-org2af9960" class="outline-4">
<h4 id="org2af9960">Process model</h4>
<div class="outline-text-4" id="text-org2af9960">
<p>
We start by defining a model for this process which is adapted from
<a href="https://pypfilt.readthedocs.io/en/0.8.0/how-to/index.html#implement-a-continuous-time-markov-chain-ctmc-model">this example</a>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">CTMCBirthDeathProcess.py</span>

&lt;&lt;imports&gt;&gt;

<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">CTMCBirthDeathProcess</span>(pypfilt.model.Model):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">field_types</span>(<span style="color: #0000FF;">self</span>, ctx):
        <span style="color: #0000FF;">return</span> [(<span style="color: #008000;">'birth'</span>, np.dtype(<span style="color: #006FE0;">float</span>)),
                (<span style="color: #008000;">'death'</span>, np.dtype(<span style="color: #006FE0;">float</span>)),
                (<span style="color: #008000;">'x'</span>, np.dtype(<span style="color: #006FE0;">int</span>)),
                (<span style="color: #008000;">'next_event'</span>, np.int_),
                (<span style="color: #008000;">'next_time'</span>, np.float_)]

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">init</span>(<span style="color: #0000FF;">self</span>, ctx, vec):
        <span style="color: #BA36A5;">prior</span> = ctx.data[<span style="color: #008000;">'prior'</span>]
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'x'</span>] = prior[<span style="color: #008000;">'x'</span>]
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'birth'</span>] = prior[<span style="color: #008000;">'birth'</span>]
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'death'</span>] = prior[<span style="color: #008000;">'death'</span>]
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'next_time'</span>] = 0
        <span style="color: #BA36A5;">vec</span>[<span style="color: #008000;">'next_event'</span>] = 0
        <span style="color: #0000FF;">self</span>.select_next_event(ctx, vec, stop_time=0)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">update</span>(<span style="color: #0000FF;">self</span>, ctx, time_step, is_forecast, prev, curr):
        <span style="color: #BA36A5;">curr</span>[:] = prev[:]
        <span style="color: #BA36A5;">active</span> = <span style="color: #0000FF;">self</span>.active_particles(curr, time_step.end)
        <span style="color: #0000FF;">while</span> <span style="color: #006FE0;">any</span>(active):
            <span style="color: #BA36A5;">births</span> = np.logical_and(active, curr[<span style="color: #008000;">'next_event'</span>] == 0)
            curr[<span style="color: #008000;">'x'</span>][births] += 1
            <span style="color: #BA36A5;">deaths</span> = np.logical_and(active, curr[<span style="color: #008000;">'next_event'</span>] == 1)
            curr[<span style="color: #008000;">'x'</span>][deaths] -= 1
            <span style="color: #0000FF;">self</span>.select_next_event(ctx, curr, stop_time=time_step.end)
            <span style="color: #BA36A5;">active</span> = <span style="color: #0000FF;">self</span>.active_particles(curr, time_step.end)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">active_particles</span>(<span style="color: #0000FF;">self</span>, vec, stop_time):
        <span style="color: #0000FF;">return</span> np.logical_and(
            vec[<span style="color: #008000;">'next_time'</span>] &lt;= stop_time,
            vec[<span style="color: #008000;">'x'</span>] &gt; 0,
        )

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">select_next_event</span>(<span style="color: #0000FF;">self</span>, ctx, vec, stop_time):
        <span style="color: #BA36A5;">active</span> = <span style="color: #0000FF;">self</span>.active_particles(vec, stop_time)
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> <span style="color: #006FE0;">any</span>(active):
            <span style="color: #0000FF;">return</span>

        <span style="color: #BA36A5;">x</span> = vec[<span style="color: #008000;">'x'</span>][active]
        <span style="color: #BA36A5;">birth</span> = vec[<span style="color: #008000;">'birth'</span>][active]
        <span style="color: #BA36A5;">death</span> = vec[<span style="color: #008000;">'death'</span>][active]

        <span style="color: #BA36A5;">birth_rate</span> = birth * x
        <span style="color: #BA36A5;">death_rate</span> = death * x
        <span style="color: #BA36A5;">rate_sum</span> = birth_rate + death_rate

        <span style="color: #BA36A5;">rng</span> = ctx.component[<span style="color: #008000;">'random'</span>][<span style="color: #008000;">'model'</span>]
        <span style="color: #BA36A5;">dt</span> = - np.log(rng.random(x.shape)) / rate_sum
        vec[<span style="color: #008000;">'next_time'</span>][active] += dt

        <span style="color: #BA36A5;">threshold</span> = rng.random(x.shape) * rate_sum
        <span style="color: #BA36A5;">death_event</span> = threshold &gt; birth_rate
        vec[<span style="color: #008000;">'next_event'</span>][active] = death_event.astype(np.int_)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">can_smooth</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #0000FF;">return</span> {<span style="color: #008000;">'birth'</span>}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf30ea5c" class="outline-4">
<h4 id="orgf30ea5c">Scenario file</h4>
<div class="outline-text-4" id="text-orgf30ea5c">
<p>
The simulation and estimation computations are specified with a TOML
file <code>ctmc-bd-example.toml</code>.
</p>

<div class="org-src-container">
<pre class="src src-toml">[<span style="color: #6434A3;">metadata</span>]
<span style="color: #BA36A5;">name</span> = <span style="color: #008000;">"CTMC birth-death example"</span>
<span style="color: #BA36A5;">filename</span> = <span style="color: #008000;">"ctmc-bd-example.toml"</span>
<span style="color: #BA36A5;">author</span> = <span style="color: #008000;">"Alexander E. Zarebski"</span>
<span style="color: #BA36A5;">date</span> = <span style="color: #008000;">"2023-07-27"</span>

[<span style="color: #6434A3;">components</span>]
<span style="color: #BA36A5;">model</span> = <span style="color: #008000;">"CTMCBirthDeathProcess.CTMCBirthDeathProcess"</span>
<span style="color: #BA36A5;">time</span> = <span style="color: #008000;">"pypfilt.Scalar"</span>
<span style="color: #BA36A5;">sampler</span> = <span style="color: #008000;">"pypfilt.sampler.LatinHypercube"</span>
<span style="color: #BA36A5;">summary</span> = <span style="color: #008000;">"pypfilt.summary.HDF5"</span>

[<span style="color: #6434A3;">time</span>]
<span style="color: #BA36A5;">start</span> = 0.0
<span style="color: #BA36A5;">until</span> = 5.0
<span style="color: #BA36A5;">steps_per_unit</span> = 10
<span style="color: #BA36A5;">summaries_per_unit</span> = 2

[<span style="color: #6434A3;">prior</span>]
<span style="color: #BA36A5;">death</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 1.0 }
<span style="color: #BA36A5;">x</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 1 }

[<span style="color: #6434A3;">observations.x</span>]
<span style="color: #BA36A5;">model</span> = <span style="color: #008000;">"NoisyCount.NoisyCount"</span>
<span style="color: #BA36A5;">file</span> = <span style="color: #008000;">"ctmc-bd-example-x.ssv"</span>

[<span style="color: #6434A3;">filter</span>]
<span style="color: #BA36A5;">particles</span> = 1000
<span style="color: #BA36A5;">prng_seed</span> = 1
<span style="color: #BA36A5;">history_window</span> = -1
<span style="color: #BA36A5;">resample.threshold</span> = 0.25
<span style="color: #BA36A5;">regularisation.enabled</span> = <span style="color: #0000FF;">true</span>

[<span style="color: #6434A3;">filter.regularisation.bounds</span>]
<span style="color: #BA36A5;">birth</span> = { min = 1.0, max = 3.0 }

[<span style="color: #6434A3;">scenario.simulate</span>]
<span style="color: #BA36A5;">prior.birth</span> = { name = <span style="color: #008000;">"constant"</span>, args.value = 2.0 }

[<span style="color: #6434A3;">scenario.forecast</span>]
<span style="color: #BA36A5;">summary.tables.model_cints.component</span> = <span style="color: #008000;">"pypfilt.summary.ModelCIs"</span>
<span style="color: #BA36A5;">summary.tables.model_cints.credible_intervals</span> = [ 0, 25, 50, 75, 95 ]
<span style="color: #BA36A5;">summary.tables.forecasts.component</span> = <span style="color: #008000;">"pypfilt.summary.PredictiveCIs"</span>
<span style="color: #BA36A5;">summary.tables.forecasts.credible_intervals</span> = [10, 20, 40, 80]
<span style="color: #BA36A5;">prior.birth</span> = { name = <span style="color: #008000;">"uniform"</span>, args.loc = 1.0, args.scale = 3.0 }
<span style="color: #BA36A5;">backcast_time</span> = 0.0
<span style="color: #BA36A5;">forecast_time</span> = 4.0

[<span style="color: #6434A3;">output</span>]
<span style="color: #BA36A5;">estimate_plot</span> = <span style="color: #008000;">"ctmc-bd-posterior-estimates.png"</span>
<span style="color: #BA36A5;">forecast_plot</span> = <span style="color: #008000;">"ctmc-bd-posterior-forecasts.png"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org42e4e0f" class="outline-4">
<h4 id="org42e4e0f">Main script</h4>
<div class="outline-text-4" id="text-org42e4e0f">
<p>
Here is the main script that runs the simulation and estimation.
Because there is a substantial chance of the process going extinct, we
wrap the simulation in a loop, incrementing the seed until we find one
that gives an interesting simulation.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">ctmc-bd-example.py</span>

&lt;&lt;imports&gt;&gt;
&lt;&lt;plotting-imports&gt;&gt;

<span style="color: #BA36A5;">scenario_file</span> = <span style="color: #008000;">'ctmc-bd-example.toml'</span>
<span style="color: #BA36A5;">found_good_seed</span>=<span style="color: #D0372D;">False</span>
<span style="color: #BA36A5;">seed</span> = 0
<span style="color: #0000FF;">while</span> <span style="color: #0000FF;">not</span> found_good_seed:
    <span style="color: #006FE0;">print</span>(<span style="color: #008000;">"Trying seed"</span>, seed)
    <span style="color: #BA36A5;">instances</span> = <span style="color: #006FE0;">list</span>(pypfilt.load_instances(scenario_file))
    <span style="color: #BA36A5;">sim_instance</span> = instances[0]
    sim_instance.settings[<span style="color: #008000;">'filter'</span>][<span style="color: #008000;">'prng_seed'</span>] = seed
    <span style="color: #BA36A5;">my_time_scale</span> = sim_instance.time_scale()
    <span style="color: #BA36A5;">my_obs_tables</span> = pypfilt.simulate_from_model(sim_instance)
    <span style="color: #BA36A5;">found_good_seed</span> = my_obs_tables[<span style="color: #008000;">'x'</span>][<span style="color: #008000;">'value'</span>][-1] &gt; 0
    <span style="color: #BA36A5;">seed</span> += 1

<span style="color: #0000FF;">for</span> (obs_unit, obs_table) <span style="color: #0000FF;">in</span> my_obs_tables.items():
    <span style="color: #BA36A5;">out_file</span> = f<span style="color: #008000;">'ctmc-bd-example-</span>{obs_unit}<span style="color: #008000;">.ssv'</span>
    pypfilt.io.write_table(out_file, obs_table, my_time_scale)
</pre>
</div>

<p>
To run the forecasts on the simulated data we have the following
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">fst_instance</span> = instances[1]
<span style="color: #BA36A5;">backcast_time</span> = fst_instance.settings[<span style="color: #008000;">'backcast_time'</span>]
<span style="color: #BA36A5;">forecast_time</span> = fst_instance.settings[<span style="color: #008000;">'forecast_time'</span>]
<span style="color: #BA36A5;">context</span> = fst_instance.build_context()
<span style="color: #BA36A5;">results</span> = pypfilt.forecast(context, [forecast_time], filename=<span style="color: #D0372D;">None</span>)
</pre>
</div>

<p>
Then finally we can generate a plot showing both the future forecasted
values, but also the estiamte of the historical states of the process.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">fit</span> = results.estimation.tables[<span style="color: #008000;">'forecasts'</span>]
<span style="color: #BA36A5;">forecast</span> = results.forecasts[forecast_time].tables[<span style="color: #008000;">'forecasts'</span>]
<span style="color: #BA36A5;">credible_intervals</span> = np.concatenate((
    fit[fit[<span style="color: #008000;">'time'</span>] &gt;= backcast_time],
    forecast))

<span style="color: #BA36A5;">cri_df</span> = pd.DataFrame(credible_intervals)
<span style="color: #BA36A5;">cri_df</span> = cri_df.assign(prob = cri_df[<span style="color: #008000;">'prob'</span>])
<span style="color: #BA36A5;">obs_df</span> = pd.read_csv(<span style="color: #008000;">'ctmc-bd-example-x.ssv'</span>, sep=<span style="color: #008000;">' '</span>)
<span style="color: #BA36A5;">obs_df</span> = obs_df[obs_df[<span style="color: #008000;">'time'</span>] &gt;= backcast_time]
<span style="color: #BA36A5;">obs_df</span> = obs_df.assign(observed = obs_df[<span style="color: #008000;">'time'</span>] &lt;= forecast_time)

<span style="color: #BA36A5;">fs_p9</span> = (ggplot()
         + geom_ribbon(data = cri_df,
                       mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                     ymin = <span style="color: #008000;">"ymin"</span>,
                                     ymax = <span style="color: #008000;">"ymax"</span>,
                                     group = <span style="color: #008000;">"prob"</span>),
                       alpha = 0.2)
         + scale_x_continuous(name = <span style="color: #008000;">"Time"</span>)
         + scale_y_sqrt(name = <span style="color: #008000;">"Population size"</span>)
         + geom_point(data = obs_df,
                      mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                    y = <span style="color: #008000;">"value"</span>,
                                    shape = <span style="color: #008000;">"observed"</span>),
                      size = 3,
                      colour = <span style="color: #008000;">"red"</span>)
         + scale_shape_manual(values = {<span style="color: #D0372D;">True</span>: <span style="color: #008000;">'o'</span>, <span style="color: #D0372D;">False</span>: <span style="color: #008000;">'x'</span>})
         + geom_vline(xintercept = forecast_time,
                      linetype = <span style="color: #008000;">"dashed"</span>)
         + labs(title = <span style="color: #008000;">"Population size forecast"</span>)
         + theme_bw()
         + theme(legend_position = <span style="color: #008000;">"none"</span>))

fs_p9.save(instances[1].settings[<span style="color: #008000;">'output'</span>][<span style="color: #008000;">'forecast_plot'</span>],
           height = 4.1, width = 5.8)
</pre>
</div>

<p>
Here are the <a href="#org703eb85">results</a> of the particle filter (with the code to create
the figure below).
</p>


<div id="org703eb85" class="figure">
<p><img src="./pypfilt/ctmc-bd-posterior-forecasts.png" alt="ctmc-bd-posterior-forecasts.png" width="400px" />
</p>
<p><span class="figure-number">Figure 6: </span>Forecast of birth-death process</p>
</div>

<p>
We can also generate a plot of how the posterior distribution
converges on the true value of the parameter as the amount of data
available increases.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">param_cris_df</span> = pd.DataFrame(results.estimation.tables[<span style="color: #008000;">'model_cints'</span>])
<span style="color: #BA36A5;">param_cris_df</span> = param_cris_df[param_cris_df[<span style="color: #008000;">'name'</span>] == <span style="color: #008000;">'birth'</span>]
<span style="color: #BA36A5;">param_cris_df</span>[<span style="color: #008000;">'prob'</span>] = pd.Categorical(
    param_cris_df[<span style="color: #008000;">'prob'</span>],
    categories=param_cris_df[<span style="color: #008000;">'prob'</span>].unique(),
    ordered=<span style="color: #D0372D;">True</span>
)
<span style="color: #BA36A5;">pt_est_mask</span> = param_cris_df[<span style="color: #008000;">'prob'</span>] == 0

<span style="color: #BA36A5;">br_p9</span> = (ggplot()
         + geom_ribbon(data = param_cris_df,
                       mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                     ymin = <span style="color: #008000;">"ymin"</span>,
                                     ymax = <span style="color: #008000;">"ymax"</span>,
                                     group = <span style="color: #008000;">"prob"</span>),
                       alpha = 0.2,
                       size = 1)
         + geom_line(data = param_cris_df[pt_est_mask],
                     mapping = aes(x = <span style="color: #008000;">"time"</span>,
                                   y = <span style="color: #008000;">"ymin"</span>))
         + geom_hline(yintercept = 2.0, linetype = <span style="color: #008000;">"dashed"</span>, colour = <span style="color: #008000;">"red"</span>)
         + scale_x_continuous(name = <span style="color: #008000;">"Amount of data used"</span>)
         + scale_y_continuous(name = <span style="color: #008000;">"Birth rate"</span>)
         + labs(title = <span style="color: #008000;">"Birth rate credible intervals"</span>)
         + theme_bw())

br_p9.save(instances[1].settings[<span style="color: #008000;">'output'</span>][<span style="color: #008000;">'estimate_plot'</span>],
           height = 4.1, width = 5.8)
</pre>
</div>

<p>
Here are the <a href="#orgea6266c">results</a> of the particle filter.
</p>


<div id="orgea6266c" class="figure">
<p><img src="./pypfilt/ctmc-bd-posterior-estimates.png" alt="ctmc-bd-posterior-estimates.png" width="400px" />
</p>
<p><span class="figure-number">Figure 7: </span>Forecast of birth-death process</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org34c603d" class="outline-2">
<h2 id="org34c603d">Colophon</h2>
<div class="outline-text-2" id="text-org34c603d">
<p>
Here is a requirements file for a python virtual environment to run
these examples.
</p>

<div class="org-src-container">
<pre class="src src-txt">contourpy==1.1.0
cycler==0.11.0
fonttools==4.41.1
h5py==3.9.0
kiwisolver==1.4.4
lhs==0.4.1
matplotlib==3.7.2
mizani==0.9.2
numpy==1.25.1
packaging==23.1
pandas==2.0.3
patsy==0.5.3
Pillow==10.0.0
plotnine==0.12.2
pyparsing==3.0.9
pypfilt==0.8.0
PyQt5==5.15.9
PyQt5-Qt5==5.15.2
PyQt5-sip==12.12.2
python-dateutil==2.8.2
pytz==2023.3
scipy==1.11.1
six==1.16.0
statsmodels==0.14.0
tomli==2.0.1
tomli_w==1.0.0
tzdata==2023.3
</pre>
</div>

<p>
Once you have the virtual environment set up, the examples can be run
as shown in the following example when using the \(\tau\)-leaping
code.
</p>

<pre class="example">
$ python tau-leap-bd-example.py
</pre>

<p>
Here is a source block that gets included whenever you see an imports
statement.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgdd2c2dd"><span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> scipy.stats
<span style="color: #0000FF;">import</span> pypfilt
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org1571de3"><span style="color: #0000FF;">import</span> matplotlib.pyplot <span style="color: #0000FF;">as</span> plt
<span style="color: #0000FF;">import</span> matplotlib.image <span style="color: #0000FF;">as</span> mpimg
<span style="color: #0000FF;">import</span> matplotlib <span style="color: #0000FF;">as</span> matplotlib
matplotlib.use(<span style="color: #008000;">'QtAgg'</span>)
<span style="color: #0000FF;">import</span> pandas <span style="color: #0000FF;">as</span> pd
<span style="color: #0000FF;">import</span> plotnine <span style="color: #0000FF;">as</span> p9
<span style="color: #0000FF;">from</span> plotnine <span style="color: #0000FF;">import</span> *
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alexander E. Zarebski</p>
<p class="date">Created: 2023-08-28 Mon 16:51</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>