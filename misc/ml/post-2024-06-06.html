<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-01-06 Mon 09:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AANN 06/06/2024</title>
<meta name="author" content="Alexander E. Zarebski" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="icon" type="image/png" href="../../resources/nicemacs-favicon.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
<link rel="stylesheet" href="../../microgram.css">
</head>
<body>
<div id="content" class="content">
<h1 class="title">AANN 06/06/2024</h1>
<div class="nav-buttons">
  <a class="button button-outline nav-button" href="./post-2024-05-16.html">Previous</a>
  <a class="button button-outline nav-button" href="../../index.html">Home</a>
  <a class="button button-outline nav-button" href="./index.html">Index</a>
  <a class="button button-outline nav-button" href="./post-2024-12-28.html">Next</a>
</div>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9496558">Speed reading</a></li>
<li><a href="#org94af7aa">Details</a></li>
</ul>
</div>
</div>

<div id="outline-container-org9496558" class="outline-2">
<h2 id="org9496558">Speed reading</h2>
<div class="outline-text-2" id="text-org9496558">

<div id="orgde8ebb6" class="figure">
<p><img src="./example-2024-06-06/cover-image.webp" alt="cover-image.webp" width="400px" />
</p>
</div>

<p>
In this example we will use the <code>timeit</code> library to see how long it
takes to get data that has been stored in various ways. Since I'm
working with phylogenies, a natural way to store them is in plaintext
Newick format. Unfortunately, reading trees from disk is painfully
slow. Here are my attempts to try and speed this up.
</p>

<p>
Let's consider three methods:
</p>

<ul class="org-ul">
<li>reading a tree in from a Newick file with <code>Bio.Phylo</code>,</li>
<li>reading a pickled version of the tree (either individually or in a
batch) in with <code>pickle</code></li>
<li>and finally reading a pickle file out of a HDF5 file and unpickling
that (either individually or in a batch).</li>
</ul>

<p>
<span class="underline">A stock standard pickle file is the way to go!</span> Loading a pickled
tree out of a bytestring stored in HDF5 (which I thought was going to
be faster) is not any faster than regular pickle file (although it
does have the convenience of only needing a single file). You can
perform this experiment yourself using <a href="./example-2024-06-06/main.py">script</a>, but here are the
results anyway.
</p>

<pre class="example" id="org65d3075">
$ python main.py
The example tree has 1024 terminals
We average times over 300 evaluations
Reading with pickle (individually) is 1.96 times faster than reading newick
Reading with pickle (batched) is 4.27 times faster than reading newick
Reading from HDF5 (individually) is 1.78 times faster than reading newick
Reading from HDF5 (batched) is 3.66 times faster than reading newick
</pre>
</div>
</div>

<div id="outline-container-org94af7aa" class="outline-2">
<h2 id="org94af7aa">Details</h2>
<div class="outline-text-2" id="text-org94af7aa">
<p>
Here are the details of the script. We start by loading in packages
(shocker!) and specifying <code>NUM_REPS</code> which is the number of times to
repeat the experiment to get a meaningful average of the time needed.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">from</span> io <span style="color: #0000FF;">import</span> StringIO
<span style="color: #0000FF;">from</span> Bio <span style="color: #0000FF;">import</span> Phylo
<span style="color: #0000FF;">import</span> h5py
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> pickle
<span style="color: #0000FF;">import</span> timeit

<span style="color: #BA36A5;">NUM_REPS</span> = 300
</pre>
</div>

<p>
Next we, set up a way to recursively generate a large tree with the
<code>_tree_string</code> function which produces a large tree in Newick format.
The result is stored in three ways: written to a Newick file as plain
text, parsed into a tree and pickled, and parsed and picked and stored
in an HDF5 file.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">def</span> <span style="color: #006699;">_tree_string</span>(n):
    <span style="color: #0000FF;">if</span> n == 0:
        <span style="color: #0000FF;">return</span> <span style="color: #008000;">"(A:0.1, A:0.1):0.1"</span>
    <span style="color: #0000FF;">else</span>:
        <span style="color: #BA36A5;">tmp</span> = _tree_string(n-1)
        <span style="color: #0000FF;">return</span> f<span style="color: #008000;">"(</span>{tmp}<span style="color: #008000;">, </span>{tmp}<span style="color: #008000;">):0.1"</span>

<span style="color: #0000FF;">def</span> <span style="color: #006699;">tree_string</span>(n):
    <span style="color: #0000FF;">return</span> _tree_string(n) + <span style="color: #008000;">";"</span>

<span style="color: #BA36A5;">newick_tree</span> = tree_string(9)

<span style="color: #BA36A5;">filename_newick</span> = <span style="color: #008000;">"foobar.newick"</span>
<span style="color: #0000FF;">with</span> <span style="color: #006FE0;">open</span>(filename_newick, <span style="color: #008000;">"w+"</span>) <span style="color: #0000FF;">as</span> <span style="color: #006FE0;">file</span>:
    <span style="color: #006FE0;">file</span>.write(newick_tree)

<span style="color: #BA36A5;">filename_pickle</span> = <span style="color: #008000;">"foobar.pickle"</span>
<span style="color: #BA36A5;">newick_tree_obj</span> = Phylo.read(StringIO(newick_tree), <span style="color: #008000;">"newick"</span>)
<span style="color: #0000FF;">with</span> <span style="color: #006FE0;">open</span>(filename_pickle, <span style="color: #008000;">"wb+"</span>) <span style="color: #0000FF;">as</span> <span style="color: #006FE0;">file</span>:
    pickle.dump(newick_tree_obj, <span style="color: #006FE0;">file</span>)

<span style="color: #BA36A5;">filename_hdf5</span> = <span style="color: #008000;">"foobar.hdf5"</span>
<span style="color: #0000FF;">with</span> h5py.File(filename_hdf5, <span style="color: #008000;">"w"</span>) <span style="color: #0000FF;">as</span> <span style="color: #006FE0;">file</span>:
    <span style="color: #BA36A5;">pickle_blob</span> = np.void(pickle.dumps(newick_tree_obj))
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(NUM_REPS):
        <span style="color: #006FE0;">file</span>.create_dataset(f<span style="color: #008000;">"tree_</span>{i}<span style="color: #008000;">"</span>, data=pickle_blob)
</pre>
</div>

<p>
The three functions here each read the tree from their respective
sources. The functions with a <code>1</code> in the function name read the file
once per invocation and those with a <code>2</code> read it 20 times. This gives
us a way to understand how much of the time is spent actually doing
the function call and how much goes to the actual un-pickling of the
tree.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">def</span> <span style="color: #006699;">test_a</span>():
    <span style="color: #BA36A5;">tree</span> = Phylo.read(filename_newick, <span style="color: #008000;">"newick"</span>)
    <span style="color: #0000FF;">return</span> <span style="color: #006FE0;">len</span>(tree.get_terminals())

<span style="color: #0000FF;">def</span> <span style="color: #006699;">test_b1</span>():
    <span style="color: #0000FF;">with</span> <span style="color: #006FE0;">open</span>(filename_pickle, <span style="color: #008000;">"rb"</span>) <span style="color: #0000FF;">as</span> <span style="color: #006FE0;">file</span>:
        <span style="color: #BA36A5;">tree</span> = pickle.load(<span style="color: #006FE0;">file</span>)
        <span style="color: #0000FF;">return</span> <span style="color: #006FE0;">len</span>(tree.get_terminals())

<span style="color: #0000FF;">def</span> <span style="color: #006699;">test_b2</span>():
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(<span style="color: #006FE0;">int</span>(NUM_REPS/20)):
        <span style="color: #0000FF;">with</span> <span style="color: #006FE0;">open</span>(filename_pickle, <span style="color: #008000;">"rb"</span>) <span style="color: #0000FF;">as</span> <span style="color: #006FE0;">file</span>:
            <span style="color: #BA36A5;">tree</span> = pickle.load(<span style="color: #006FE0;">file</span>)
    <span style="color: #0000FF;">return</span> <span style="color: #006FE0;">len</span>(tree.get_terminals())

<span style="color: #BA36A5;">hdf5_conn</span> = h5py.File(filename_hdf5, <span style="color: #008000;">"r"</span>)
<span style="color: #0000FF;">def</span> <span style="color: #006699;">test_c1</span>():
    <span style="color: #BA36A5;">tree</span> = pickle.loads(hdf5_conn[f<span style="color: #008000;">"tree_0"</span>][()])
    <span style="color: #0000FF;">return</span> <span style="color: #006FE0;">len</span>(tree.get_terminals())

<span style="color: #0000FF;">def</span> <span style="color: #006699;">test_c2</span>():
    <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span>(<span style="color: #006FE0;">int</span>(NUM_REPS/20)):
        <span style="color: #BA36A5;">tree</span> = pickle.loads(hdf5_conn[f<span style="color: #008000;">"tree_</span>{i}<span style="color: #008000;">"</span>][()])
    <span style="color: #0000FF;">return</span> <span style="color: #006FE0;">len</span>(tree.get_terminals())

<span style="color: #0000FF;">assert</span> test_a() == test_b1()
<span style="color: #0000FF;">assert</span> test_a() == test_b2()
<span style="color: #0000FF;">assert</span> test_a() == test_c1()
<span style="color: #0000FF;">assert</span> test_a() == test_c2()
</pre>
</div>

<p>
Finally to actually carry out the timing and report the results we use
<code>timeit</code> and print the results.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">time_a</span> = timeit.timeit(<span style="color: #0000FF;">lambda</span>: test_a(), number=NUM_REPS)
<span style="color: #BA36A5;">time_b1</span> = timeit.timeit(<span style="color: #0000FF;">lambda</span>: test_b1(), number=NUM_REPS)
<span style="color: #BA36A5;">time_b2</span> = timeit.timeit(<span style="color: #0000FF;">lambda</span>: test_b2(), number=20)
<span style="color: #BA36A5;">time_c1</span> = timeit.timeit(<span style="color: #0000FF;">lambda</span>: test_c1(), number=NUM_REPS)
<span style="color: #BA36A5;">time_c2</span> = timeit.timeit(<span style="color: #0000FF;">lambda</span>: test_c2(), number=20)
hdf5_conn.close()

<span style="color: #006FE0;">print</span>(f<span style="color: #008000;">"The example tree has </span>{test_a()}<span style="color: #008000;"> terminals"</span>)
<span style="color: #006FE0;">print</span>(f<span style="color: #008000;">"We average times over </span>{NUM_REPS}<span style="color: #008000;"> evaluations"</span>)
<span style="color: #006FE0;">print</span>(f<span style="color: #008000;">"Reading with pickle (individually) is </span>{(time_a/time_b1):.2f}<span style="color: #008000;"> times faster than reading newick"</span>)
<span style="color: #006FE0;">print</span>(f<span style="color: #008000;">"Reading with pickle (batched) is </span>{(time_a/time_b2):.2f}<span style="color: #008000;"> times faster than reading newick"</span>)
<span style="color: #006FE0;">print</span>(f<span style="color: #008000;">"Reading from HDF5 (individually) is </span>{(time_a/time_c1):.2f}<span style="color: #008000;"> times faster than reading newick"</span>)
<span style="color: #006FE0;">print</span>(f<span style="color: #008000;">"Reading from HDF5 (batched) is </span>{(time_a/time_c2):.2f}<span style="color: #008000;"> times faster than reading newick"</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Alexander E. Zarebski</p>
<p class="date">Created: 2025-01-06 Mon 09:32</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
