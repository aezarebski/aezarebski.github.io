const width=900,height=600;const linkLength=200;const dataFile="data.min.json"
const defaultOpacity=0.3;const baseRadius=5;const svg=d3.select("body").append("svg").attr("width",width).attr("height",height).style("border","1px solid black").call(d3.zoom().on("zoom",zoomed));const g=svg.append("g");d3.json(dataFile).then(data=>{var outDegreeMap={};data.nodes.forEach(node=>{node.addedToTable=false;outDegreeMap[node.id]=0;});data.links.forEach(link=>{if(outDegreeMap.hasOwnProperty(link.source)){outDegreeMap[link.source]+=1;}
if(outDegreeMap.hasOwnProperty(link.target)){outDegreeMap[link.target]+=1;}});console.log(outDegreeMap);data.nodes.forEach(node=>{node.radius=baseRadius+(outDegreeMap[node.id]+1);});const simulation=d3.forceSimulation(data.nodes).force("link",d3.forceLink(data.links).id(d=>d.id).distance(linkLength)).force("charge",d3.forceManyBody().strength(-800)).force("center",d3.forceCenter(width/2,height/2));const link=g.append("g").attr("class","links").selectAll("line").data(data.links).enter().append("line").attr("class","link").style("stroke-opacity",defaultOpacity);const node=g.append("g").attr("class","nodes").selectAll("circle").data(data.nodes).enter().append("circle").attr("class","node").attr("r",d=>d.radius).style("fill","grey").style("opacity",defaultOpacity).on("mouseover",function(event,d){const neighbors=new Set(data.links.filter(l=>l.source.id===d.id||l.target.id===d.id).flatMap(l=>[l.source.id,l.target.id]));neighbors.add(d.id);node.style("opacity",n=>neighbors.has(n.id)?1:defaultOpacity);link.style("stroke-opacity",l=>neighbors.has(l.source.id)&&neighbors.has(l.target.id)?1:defaultOpacity);const xPosition=event.pageX+5;const yPosition=event.pageY+5;d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px").style("opacity",1);d3.select("#tooltip-title").text(d.title);d3.select("#tooltip-year").text(d.year);d3.select("#tooltip-first-author").text(d.first_author);d3.select("#tooltip-doi").attr("href","https://doi.org/"+d.doi).text(d.doi);}).on("click",function(event,nodeData){addToTooltipTable(nodeData);nodeData.addedToTable=true;d3.select(this).style("fill","blue");}).on("mouseout",function(event,nodeData){node.style("opacity",defaultOpacity);link.style("stroke-opacity",defaultOpacity);setTimeout(()=>{if(!d3.select("#tooltip").classed("hovered")){d3.select("#tooltip").style("opacity",0).style("left","-9999px");}},1000);});d3.select("#tooltip").on("mouseover",function(){d3.select(this).classed("hovered",true);}).on("mouseout",function(){d3.select(this).classed("hovered",false);setTimeout(()=>{if(!d3.select(this).classed("hovered")){d3.select(this).style("opacity",0).style("left","-9999px");}},1000);});simulation.on("tick",()=>{link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y).attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);node.attr("cx",d=>d.x).attr("cy",d=>d.y);});});function zoomed(event){g.attr("transform",event.transform);}
function addToTooltipTable(node){if(node.addedToTable){return;}
var tooltipTable=document.getElementById("tooltipTable");var tableRow=document.createElement("tr");tableRow.innerHTML=`<td>${node.title}</td><td>${node.year}</td><td>${node.first_author}</td><td><a href="https://doi.org/${node.doi}"target="_blank">${node.doi}</a></td>`;tooltipTable.appendChild(tableRow);}